<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç£åœºå¢é‡</title>
<style>
/* --- æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œä»…åšå°‘é‡æ–‡æ¡ˆé€‚é… --- */
:root {
--bg-color: #050000;
--panel-bg: #1a0505;
--text-color: #e0e0e0;
--accent-color: #00ffff;
--accent-glow: rgba(0, 255, 255, 0.6);
--danger-color: #ff0000;
--danger-glow: rgba(255, 0, 0, 0.7);
--gold-color: #ffd700;
--gold-glow: rgba(255, 215, 0, 0.5);
--border-color: #550000;
--font-main: "Impact", "Arial Black", "Microsoft YaHei", sans-serif;
--font-body: "Verdana", "Microsoft YaHei", sans-serif;
--red-dot: #ff0000;
}
body {
background-color: var(--bg-color);
background-image: radial-gradient(circle at 50% 50%, #220000 0%, #000000 100%);
color: var(--text-color);
font-family: var(--font-body);
margin: 0;
padding: 0;
display: flex;
height: 100vh;
overflow: hidden;
user-select: none;
border: 5px solid #330000;
box-sizing: border-box;
}
#nav-sidebar {
width: 200px;
background: #000;
border-right: 4px solid var(--danger-color);
display: flex;
flex-direction: column;
padding: 10px 0;
z-index: 100;
position: relative;
box-shadow: 5px 0 20px rgba(0,0,0,0.8);
}
.nav-btn {
background: transparent;
border: none;
border-left: 5px solid #330000;
color: #666;
padding: 20px 15px;
text-align: left;
cursor: pointer;
font-family: var(--font-main);
font-size: 1.1rem;
text-transform: uppercase;
letter-spacing: 2px;
transition: all 0.2s;
position: relative;
clip-path: polygon(0 0, 100% 0, 95% 100%, 0% 100%);
}
.nav-btn:hover {
color: #fff;
background: linear-gradient(90deg, #330000 0%, transparent 100%);
padding-left: 25px;
}
.nav-btn.active {
color: var(--accent-color);
border-left-color: var(--accent-color);
background: linear-gradient(90deg, rgba(0, 255, 255, 0.1) 0%, transparent 100%);
font-weight: 900;
text-shadow: 0 0 10px var(--accent-glow);
transform: scale(1.05);
}
.nav-btn.disabled {
opacity: 0.2;
pointer-events: none;
filter: grayscale(1);
}
.nav-btn.challenge-active {
color: var(--danger-color);
border-left-color: var(--danger-color);
text-shadow: 0 0 8px var(--danger-glow);
}
.nav-btn.achievement-active {
color: var(--gold-color);
border-left-color: var(--gold-color);
text-shadow: 0 0 8px var(--gold-glow);
}
.nav-btn.system-btn {
margin-top: auto;
border-top: 2px solid #330000;
text-align: center;
font-size: 0.8rem;
padding: 15px;
color: #555;
border-left: none;
clip-path: none;
}
.nav-btn.system-btn:hover { color: #fff; background: #220000; }
.red-dot {
position: absolute;
top: 10px;
right: 10px;
width: 10px;
height: 10px;
background-color: var(--red-dot);
border-radius: 50%;
box-shadow: 0 0 10px var(--danger-color);
animation: pulse-dot 0.8s infinite alternate;
display: none;
}
@keyframes pulse-dot {
from { opacity: 0.6; transform: scale(1); }
to { opacity: 1; transform: scale(1.3); box-shadow: 0 0 15px var(--danger-color); }
}
#main-area {
flex: 1;
display: flex;
flex-direction: column;
overflow: hidden;
position: relative;
background: rgba(0,0,0,0.3);
}
#top-bar {
height: 70px;
border-bottom: 3px solid var(--border-color);
display: flex;
align-items: center;
justify-content: space-between;
padding: 0 30px;
background: linear-gradient(180deg, #110000 0%, #000 100%);
box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.resource-display {
font-size: 1.5rem;
font-family: var(--font-main);
font-style: italic;
text-transform: uppercase;
}
.resource-val {
color: #fff;
font-size: 2rem;
text-shadow: 0 0 10px rgba(255,255,255,0.5);
margin: 0 10px;
}
.resource-unit { font-size: 1rem; color: #888; }
.global-mult {
font-size: 0.9rem;
color: var(--gold-color);
font-family: var(--font-main);
background: rgba(255, 215, 0, 0.1);
padding: 5px 10px;
border: 1px solid var(--gold-color);
}
#content-panels {
flex: 1;
position: relative;
overflow: hidden;
padding: 20px;
}
.panel-view {
position: absolute;
top: 20px;
left: 20px;
width: calc(100% - 40px);
height: calc(100% - 40px);
padding: 20px;
overflow-y: auto;
display: none;
box-sizing: border-box;
animation: slamIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
background: rgba(10, 0, 0, 0.6);
border: 1px solid #330000;
}
.panel-view.active { display: block; }
@keyframes slamIn {
from { opacity: 0; transform: scale(0.9) translateY(20px); }
to { opacity: 1; transform: scale(1) translateY(0); }
}
h2 {
border-bottom: 4px solid var(--accent-color);
padding-bottom: 15px;
color: var(--accent-color);
margin-top: 0;
font-family: var(--font-main);
font-size: 2.5rem;
text-transform: uppercase;
font-style: italic;
text-shadow: 3px 3px 0px #000;
letter-spacing: 5px;
}
h2.danger {
color: var(--danger-color);
border-color: var(--danger-color);
text-shadow: 3px 3px 0px #300;
}
h2.gold {
color: var(--gold-color);
border-color: var(--gold-color);
text-shadow: 3px 3px 0px #332200;
}
p { line-height: 1.6; color: #ccc; }
.stat-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 20px;
margin-bottom: 30px;
}
.upgrade-card {
background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
border: 2px solid #444;
border-top: 4px solid #666;
padding: 20px;
display: flex;
flex-direction: column;
justify-content: space-between;
transition: all 0.2s;
position: relative;
overflow: hidden;
}
.upgrade-card::before {
content: '';
position: absolute;
top: 0; left: 0; width: 100%; height: 2px;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
}
.upgrade-card:hover {
border-color: #888;
transform: translateY(-5px);
box-shadow: 0 10px 20px rgba(0,0,0,0.5);
}
.upgrade-card h3 {
margin: 0 0 10px 0;
font-size: 1.2rem;
color: #fff;
font-family: var(--font-main);
text-transform: uppercase;
}
.upgrade-card p {
font-size: 0.85rem;
color: #999;
margin: 0 0 15px 0;
height: 40px;
font-family: var(--font-body);
}
.btn-buy {
background: #220000;
border: 2px solid var(--accent-color);
color: var(--accent-color);
padding: 12px;
cursor: pointer;
font-family: var(--font-main);
font-size: 1rem;
text-align: center;
transition: all 0.1s;
text-transform: uppercase;
font-weight: bold;
position: relative;
overflow: hidden;
clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
}
.btn-buy::after {
content: '';
position: absolute;
top: 0; left: -100%; width: 100%; height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
transition: 0.5s;
}
.btn-buy:hover::after { left: 100%; }
.btn-buy:hover:not(:disabled) {
background: var(--accent-color);
color: #000;
box-shadow: 0 0 20px var(--accent-glow);
transform: scale(1.02);
}
.btn-buy:disabled {
border-color: #444;
color: #444;
cursor: not-allowed;
background: #111;
transform: none;
box-shadow: none;
}
/* c1æŒ‘æˆ˜ï¼šçº¢è‰²è£‚ç—•è¦†ç›–æ•´ä¸ªå‡çº§å¡ç‰‡ */
.card-cracked {
position: relative !important;
pointer-events: none !important;
}
.card-cracked > * {
opacity: 0.35;
}
.card-cracked::after {
content: '' !important;
display: block !important;
position: absolute !important;
inset: 0 !important;
border: 2px solid rgba(180,0,0,0.55) !important;
border-radius: inherit !important;
background:
  linear-gradient(113deg, transparent 22%, rgba(200,0,0,0.13) 22.4%, transparent 23%),
  linear-gradient(47deg,  transparent 35%, rgba(180,0,0,0.11) 35.4%, transparent 36%),
  linear-gradient(158deg, transparent 55%, rgba(160,0,0,0.10) 55.4%, transparent 56%),
  linear-gradient(72deg,  transparent 14%, rgba(200,0,0,0.09) 14.4%, transparent 15%),
  linear-gradient(135deg, transparent 68%, rgba(180,0,0,0.12) 68.4%, transparent 69%),
  linear-gradient(25deg,  transparent 80%, rgba(200,0,0,0.08) 80.4%, transparent 81%),
  radial-gradient(ellipse at 30% 40%, rgba(140,0,0,0.18) 0%, transparent 55%),
  radial-gradient(ellipse at 70% 65%, rgba(120,0,0,0.14) 0%, transparent 50%) !important;
pointer-events: none !important;
z-index: 10 !important;
box-shadow: inset 0 0 18px rgba(180,0,0,0.18), 0 0 8px rgba(180,0,0,0.25) !important;
}
.btn-buy.danger {
border-color: var(--danger-color);
color: var(--danger-color);
background: #220000;
}
.btn-buy.danger:hover:not(:disabled) {
background: var(--danger-color);
color: #fff;
box-shadow: 0 0 20px var(--danger-glow);
}
.btn-buy.gold {
border-color: var(--gold-color);
color: var(--gold-color);
background: #221100;
}
.btn-buy.gold:hover:not(:disabled) {
background: var(--gold-color);
color: #000;
box-shadow: 0 0 20px var(--gold-glow);
}
.btn-buy.heal {
border-color: #00ccff;
color: #00ccff;
}
.btn-buy.heal:hover:not(:disabled) {
background: #00ccff;
color: #000;
box-shadow: 0 0 15px rgba(0, 204, 255, 0.6);
}
.upgrade-card.final-upgrade {
grid-column: 1 / -1;
border: 3px solid var(--gold-color);
background: linear-gradient(135deg, #332200 0%, #110000 100%);
padding: 40px;
transform: scale(1.02);
box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
text-align: center;
}
.upgrade-card.final-upgrade h3 {
font-size: 2.5rem;
color: var(--gold-color);
text-shadow: 0 0 15px var(--gold-glow);
margin-bottom: 20px;
letter-spacing: 5px;
}
.upgrade-card.final-upgrade p {
font-size: 1.2rem;
color: #eee;
height: auto;
margin-bottom: 25px;
}
.upgrade-card.final-upgrade .btn-buy {
font-size: 1.5rem;
padding: 20px 50px;
border-width: 3px;
}
.progress-wrap {
background: #111;
height: 10px;
width: 100%;
margin-top: 10px;
border: 1px solid #444;
position: relative;
}
.progress-fill {
height: 100%;
background: linear-gradient(90deg, #0088aa, var(--accent-color));
width: 0%;
transition: width 0.2s;
box-shadow: 0 0 10px var(--accent-glow);
}
.progress-fill.danger {
background: linear-gradient(90deg, #880000, var(--danger-color));
box-shadow: 0 0 10px var(--danger-glow);
}
.progress-fill.gold {
background: linear-gradient(90deg, #aa8800, var(--gold-color));
box-shadow: 0 0 10px var(--gold-glow);
}
.progress-fill.heal {
background: linear-gradient(90deg, #006688, #00ccff);
}
.achievement-item {
display: flex;
align-items: center;
background: #111;
border: 1px solid #333;
padding: 15px;
margin-bottom: 10px;
opacity: 0.5;
filter: grayscale(1);
border-left: 3px solid #333;
}
.achievement-item.unlocked {
opacity: 1;
filter: grayscale(0);
border-color: var(--gold-color);
border-left: 5px solid var(--gold-color);
background: linear-gradient(90deg, #1a1a1a 0%, #2a2a10 100%);
box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
}
.ach-icon {
width: 50px;
height: 50px;
background: #000;
border: 2px solid #555;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.5rem;
margin-right: 20px;
color: #555;
font-family: var(--font-main);
}
.achievement-item.unlocked .ach-icon {
border-color: var(--gold-color);
color: var(--gold-color);
box-shadow: 0 0 10px var(--gold-glow);
background: #221100;
}
.ach-info { flex: 1; }
.ach-title { font-weight: 900; color: #fff; font-size: 1.1rem; font-family: var(--font-main); text-transform: uppercase;}
.ach-desc { font-size: 0.9rem; color: #aaa; margin-top: 5px; }
.ach-reward { font-size: 0.8rem; color: var(--gold-color); margin-top: 5px; font-weight: bold; }
.battle-stats {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 30px;
margin-bottom: 30px;
}
.battle-side {
background: #111;
padding: 20px;
border: 2px solid #333;
text-align: center;
position: relative;
box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
}
.battle-side.player { border-color: var(--accent-color); box-shadow: 0 0 15px rgba(0, 255, 255, 0.1); }
.battle-side.enemy { border-color: var(--danger-color); box-shadow: 0 0 15px rgba(255, 0, 0, 0.1); }
.hp-bar-container {
width: 100%;
height: 30px;
background: #220000;
margin: 15px 0;
position: relative;
border: 2px solid #555;
transform: skewX(-10deg);
}
.hp-bar {
height: 100%;
transition: width 0.1s linear;
transform-origin: left;
}
.player .hp-bar { background: linear-gradient(90deg, #00aaaa, var(--accent-color)); }
.enemy .hp-bar { background: linear-gradient(90deg, #aa0000, var(--danger-color)); box-shadow: 0 0 15px var(--danger-glow); }
.hp-text {
position: absolute;
top: 0;
left: 0;
width: 100%;
text-align: center;
font-size: 0.9rem;
line-height: 26px;
color: #fff;
text-shadow: 1px 1px 2px #000;
font-weight: 900;
font-family: var(--font-main);
transform: skewX(10deg);
}
.enemy-hp-display {
font-size: 1.8rem;
color: var(--danger-color);
font-weight: 900;
text-shadow: 0 0 10px var(--danger-glow);
margin: 10px 0;
display: block;
font-family: var(--font-main);
letter-spacing: 2px;
}
.enemy-stat-row { font-size: 1rem; color: #ccc; margin: 5px 0; font-weight: bold; }
.battle-controls {
text-align: center;
margin-top: 30px;
padding: 20px;
background: #0a0a0a;
border: 2px solid #444;
border-top: 4px solid var(--danger-color);
}
.battle-status {
font-size: 1.5rem;
font-weight: 900;
margin-bottom: 20px;
height: 40px;
font-family: var(--font-main);
text-transform: uppercase;
letter-spacing: 2px;
}
.status-fighting { color: var(--danger-color); animation: shake 0.5s infinite; text-shadow: 0 0 10px var(--danger-glow); }
.status-waiting { color: var(--accent-color); }
.status-cooldown { color: #666; }
.status-injured { color: #ff6600; }
@keyframes ult-glow-pulse {
  0% { box-shadow: 0 0 4px 1px rgba(180,80,255,0.4), 0 0 8px 2px rgba(180,80,255,0.2); }
  100% { box-shadow: 0 0 10px 3px rgba(220,120,255,0.85), 0 0 20px 6px rgba(180,80,255,0.45); }
}
.ult-node-affordable {
  animation: ult-glow-pulse 0.9s ease-in-out infinite alternate !important;
  border-color: #cc66ff !important;
}
@keyframes shake {
0% { transform: translate(1px, 1px) rotate(0deg); }
10% { transform: translate(-1px, -2px) rotate(-1deg); }
20% { transform: translate(-3px, 0px) rotate(1deg); }
30% { transform: translate(3px, 2px) rotate(0deg); }
40% { transform: translate(1px, -1px) rotate(1deg); }
50% { transform: translate(-1px, 2px) rotate(-1deg); }
60% { transform: translate(-3px, 1px) rotate(0deg); }
70% { transform: translate(3px, 1px) rotate(-1deg); }
80% { transform: translate(-1px, -1px) rotate(1deg); }
90% { transform: translate(1px, 2px) rotate(0deg); }
100% { transform: translate(1px, -2px) rotate(-1deg); }
}
.btn-battle {
padding: 15px 40px;
font-size: 1.2rem;
margin: 0 15px;
min-width: 150px;
font-weight: 900;
letter-spacing: 2px;
}
.btn-flee {
border-color: #666;
color: #666;
background: #111;
}
.btn-flee:hover:not(:disabled) {
background: #666;
color: #000;
box-shadow: 0 0 15px rgba(100,100,100,0.5);
}
#cinematic-screen {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: #000;
z-index: 3000;
display: none;
flex-direction: column;
justify-content: center;
align-items: center;
text-align: center;
padding: 20px;
box-sizing: border-box;
background-image: radial-gradient(circle, #300 0%, #000 80%);
}
#cinematic-text {
font-size: 2.2rem;
color: #fff;
max-width: 900px;
line-height: 1.8;
white-space: pre-line;
opacity: 0;
transition: opacity 2s ease-in-out;
text-shadow:
0 0 10px #000,
0 0 20px var(--accent-color),
0 0 30px var(--danger-color);
font-family: var(--font-main);
font-style: italic;
font-weight: 900;
letter-spacing: 3px;
}
#cinematic-text.visible { opacity: 1; }
#cinematic-restart-btn {
margin-top: 50px;
padding: 20px 60px;
font-size: 1.5rem;
background: transparent;
border: 3px solid var(--gold-color);
color: var(--gold-color);
cursor: pointer;
font-family: var(--font-main);
display: none;
transition: all 0.3s;
text-transform: uppercase;
letter-spacing: 5px;
}
#cinematic-restart-btn:hover {
background: var(--gold-color);
color: #000;
box-shadow: 0 0 30px var(--gold-glow);
}
#log-container {
height: 150px;
background: #000;
border-top: 3px solid #330000;
padding: 15px;
overflow-y: auto;
font-size: 0.9rem;
color: #777;
font-family: 'Courier New', monospace;
box-shadow: inset 0 10px 20px rgba(0,0,0,0.8);
}
.log-entry { margin-bottom: 6px; border-bottom: 1px dashed #222; padding-bottom: 2px; }
.log-important { color: var(--accent-color); font-weight: bold; }
.log-gold { color: var(--gold-color); font-weight: 900; text-shadow: 0 0 5px var(--gold-glow); }
.log-danger { color: var(--danger-color); font-weight: bold; }
.log-heal { color: #00ccff; }
.info-row {
font-size: 1.1rem;
color: var(--gold-color);
margin-bottom: 20px;
text-align: center;
background: rgba(255, 215, 0, 0.05);
padding: 10px;
border: 1px solid rgba(255, 215, 0, 0.3);
font-family: var(--font-main);
letter-spacing: 1px;
}
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: #050000; }
::-webkit-scrollbar-thumb { background: #440000; border: 1px solid #220000; }
::-webkit-scrollbar-thumb:hover { background: #660000; }
/* Ultimate tier styles */
.ult-tree-node {
background: linear-gradient(135deg, #1a001a, #0d000d);
    border: 2px solid #660066;
    border-top: 4px solid #aa00aa;
    padding: 10px 15px; /* å‡å°å†…è¾¹è· */
    min-width: 180px;   /* å‡å°æœ€å°å®½åº¦ï¼Œä½¿å›¾æ ‡å˜å° */
    max-width: 220px;   /* å‡å°æœ€å¤§å®½åº¦ */
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    font-size: 0.9rem;  /* å¯é€‰ï¼šç¨å¾®å‡å°å­—ä½“ä»¥é€‚é…å°å›¾æ ‡ */
}
.ult-tree-node:hover:not(.locked) {
  border-color: #ff00ff;
  box-shadow: 0 0 20px rgba(255,0,255,0.3);
  transform: scale(1.02);
}
.ult-tree-node.unlocked {
  border-color: #ff00ff;
  background: linear-gradient(135deg, #2a002a, #110011);
  box-shadow: 0 0 15px rgba(255,0,255,0.2);
}
.ult-tree-node.locked {
  opacity: 0.5;
  cursor: not-allowed;
}
.ult-tree-connector {
  width: 3px;
  height: 30px;
  background: linear-gradient(180deg, #660066, #330033);
  margin: 0 auto;
}
.ult-challenge-card {
  background: linear-gradient(135deg, #1a0a00, #0d0500);
  border: 2px solid #662200;
  border-top: 4px solid #aa4400;
  padding: 20px;
  position: relative;
}
.ult-challenge-card.completed { border-color: #00aa44; border-top-color: #00ff66; }
.ult-challenge-card.active-challenge { border-color: #ff4400; box-shadow: 0 0 20px rgba(255,68,0,0.4); }
.ult-challenge-card h4 { color: #ff8844; font-family: var(--font-main); font-size:1.2rem; margin:0 0 8px 0; }
.ult-challenge-card.completed h4 { color: #00ff66; }
.body-part-card {
  background: linear-gradient(135deg, #001a10, #000d08);
  border: 2px solid #004422;
  border-top: 4px solid #00aa55;
  padding: 20px;
  text-align: center;
}
.body-part-card.owned { border-color: #00ffaa; box-shadow: 0 0 15px rgba(0,255,170,0.2); }
.body-part-card h4 { color: #00ffaa; font-family:var(--font-main); font-size:1.3rem; margin:0 0 8px 0; }
/* In-challenge indicator */
.challenge-mode-banner {
  background: linear-gradient(90deg, #330000, #220000);
  border: 2px solid #ff4400;
  color: #ff8844;
  padding: 10px 20px;
  text-align: center;
  font-family: var(--font-main);
  font-size: 1.1rem;
  margin-bottom: 15px;
  display: none;
}
.challenge-mode-banner.active { display: block; }
/* --- æ‰‹æœºç«¯é€‚é…æ ·å¼ --- */
@media screen and (max-width: 768px) {
    /* æ”¹å˜ä¸»ä½“å¸ƒå±€æ–¹å‘ä¸ºå‚ç›´ */
    body {
        flex-direction: column;
        height: auto; /* å…è®¸é«˜åº¦è‡ªé€‚åº” */
        overflow-y: auto; /* å…è®¸æ•´ä½“çºµå‘æ»šåŠ¨ */
        border: none; /* å»æ‰å¤§è¾¹æ¡†ä»¥é€‚åº”å°å± */
    }

    /* ä¾§è¾¹æ æ”¹ä¸ºé¡¶éƒ¨å¯¼èˆªæ  */
    #nav-sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 4px solid var(--danger-color);
        flex-direction: row; /* æŒ‰é’®æ¨ªå‘æ’åˆ— */
        overflow-x: auto; /* å…è®¸æ¨ªå‘æ»šåŠ¨ */
        padding: 10px 5px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        white-space: nowrap; /* é˜²æ­¢æŒ‰é’®æ¢è¡Œ */
    }

    /* å¯¼èˆªæŒ‰é’®æ ·å¼è°ƒæ•´ */
    .nav-btn {
        border-left: none;
        border-bottom: 5px solid #330000;
        padding: 10px 15px;
        font-size: 0.9rem;
        clip-path: polygon(0 0, 100% 0, 100% 90%, 90% 100%, 0 100%);
        margin-right: 10px;
        flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
    }

    .nav-btn:hover {
        padding-left: 15px; /* å–æ¶ˆæ‚¬åœæ—¶çš„å·¦ä¾§ä½ç§»ï¼Œé¿å…è·³åŠ¨ */
        background: linear-gradient(0deg, #330000 0%, transparent 100%);
    }

    .nav-btn.active {
        border-bottom-color: var(--accent-color);
        background: linear-gradient(0deg, rgba(0, 255, 255, 0.1) 0%, transparent 100%);
    }
    
    /* ç³»ç»ŸæŒ‰é’®å•ç‹¬ä¸€è¡Œæˆ–æ”¾åœ¨æœ€å */
    .nav-btn.system-btn {
        margin-top: 0;
        margin-left: auto; /* æ¨åˆ°æœ€å³ä¾§ï¼ˆå¦‚æœç©ºé—´å¤Ÿï¼‰ */
        border-top: none;
        border-bottom: 5px solid #330000;
        font-size: 0.7rem;
        padding: 10px;
    }

    /* ä¸»åŒºåŸŸè°ƒæ•´ */
    #main-area {
        height: auto;
        min-height: 100vh;
    }

    /* é¡¶éƒ¨èµ„æºæ è°ƒæ•´ */
    #top-bar {
        height: auto;
        flex-direction: column;
        padding: 15px;
        gap: 10px;
        text-align: center;
    }

    .resource-display {
        font-size: 1.2rem;
        margin-bottom: 5px;
    }
    
    .resource-val {
        font-size: 1.5rem;
    }

    .global-mult {
        font-size: 0.8rem;
        width: 100%;
        box-sizing: border-box;
    }

    /* å†…å®¹é¢æ¿è°ƒæ•´ */
    #content-panels {
        padding: 10px;
        height: auto;
        overflow: visible;
    }

    .panel-view {
        position: relative; /* å–æ¶ˆç»å¯¹å®šä½ï¼Œæ”¹ä¸ºæ–‡æ¡£æµ */
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        padding: 10px;
        box-sizing: border-box;
    }

    /* ç½‘æ ¼å¸ƒå±€è°ƒæ•´ï¼šå•åˆ—æ˜¾ç¤º */
    .stat-grid {
        grid-template-columns: 1fr; /* å¼ºåˆ¶å•åˆ— */
        gap: 15px;
    }

    /* æˆ˜æ–—åŒºåŸŸè°ƒæ•´ */
    .battle-stats {
        grid-template-columns: 1fr; /* ç©å®¶å’Œæ•Œäººä¸Šä¸‹æ’åˆ— */
        gap: 15px;
    }

    /* å­—ä½“å¤§å°å¾®è°ƒ */
    h2 {
        font-size: 1.8rem;
        letter-spacing: 2px;
    }
    
    /* æ—¥å¿—åŒºåŸŸé«˜åº¦é™åˆ¶ï¼Œé¿å…å ç”¨å¤ªå¤šå±å¹• */
    #log-container {
        height: 100px;
        font-size: 0.8rem;
    }
}
</style>
</head>
<body>
<div id="nav-sidebar">
<button class="nav-btn active" onclick="ui.switchTab('tier1')" id="nav-tier1">ç”µæµæ¨åŠ¨ <div class="red-dot" id="dot-tier1"></div></button>
<button class="nav-btn disabled" onclick="ui.switchTab('tier2')" id="nav-tier2">ç£åœºè½¬åŠ¨ <div class="red-dot" id="dot-tier2"></div></button>
<button class="nav-btn disabled" onclick="ui.switchTab('tier3')" id="nav-tier3">ç£åœºåŠŸæ³• <div class="red-dot" id="dot-tier3"></div></button>
<div style="flex:1"></div>
<button class="nav-btn disabled" onclick="ui.switchTab('tier4')" id="nav-tier4" style="color: #ff00ff; border-left-color: #ff00ff;">ç»ˆæå¼ºè€… <div class="red-dot" id="dot-tier4"></div></button>
<button class="nav-btn disabled" onclick="ui.switchTab('magnetic-body')" id="nav-magnetic-body" style="color: #00ffaa;">ç£åœºè‚‰ä½“</button>
<button class="nav-btn disabled" onclick="ui.switchTab('challenge')" id="nav-challenge">æŒ‘æˆ˜å¼ºè€… <div class="red-dot" id="dot-challenge"></div></button>
<button class="nav-btn disabled" onclick="ui.switchTab('flow')" id="nav-flow" style="color:#0099ff;border-left-color:#003366;">ğŸ’§ æµé‡</button>
<button class="nav-btn" onclick="ui.switchTab('achievements')" id="nav-achievements">æ­¦é“æˆå°±</button>
<!-- System Buttons -->
<button class="nav-btn system-btn" onclick="game.saveGame(true)">ä¿å­˜è¿›åº¦</button>
<button class="nav-btn system-btn" onclick="game.loadGame()">è¯»å–è¿›åº¦</button>
<button class="nav-btn system-btn" onclick="game.exportSave()">å¯¼å‡ºå­˜æ¡£</button>
<button class="nav-btn system-btn" onclick="game.importSave()">å¯¼å…¥å­˜æ¡£</button>
<button class="nav-btn system-btn" style="color:#f55;" onclick="if(confirm('ç¡®å®šè¦åˆ æ¡£é‡å¼€ï¼Ÿè¿™ä¸€ä¸–çš„ä¿®è¡Œå°†å…¨éƒ¨ä½œåºŸï¼')){game.hardReset()}">åˆ æ¡£é‡å¼€</button>
</div>
<div id="main-area">
<div id="challenge-mode-banner" class="challenge-mode-banner">
âš”ï¸ æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼š<span id="challenge-mode-name">-</span><span id="challenge-timer" style="color:#ffaa44;"></span> | <button onclick="game.exitUltimateChallenge()" style="background:transparent;border:1px solid #ff4400;color:#ff4400;cursor:pointer;padding:3px 10px;font-family:var(--font-main);">æ”¾å¼ƒæŒ‘æˆ˜</button>
</div>
<div id="milestone-msg" style="display:none;position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:9999;background:linear-gradient(135deg,#1a003a,#330066);border:2px solid #cc44ff;color:#ffddff;padding:14px 28px;font-family:var(--font-main);font-size:1.1rem;text-align:center;border-radius:4px;box-shadow:0 0 30px rgba(180,80,255,0.7);max-width:600px;pointer-events:none;"></div>
<div id="top-bar">
<div class="resource-display">
<span id="res-name">ç”µæµ</span>:<span id="res-val" class="resource-val">0</span><span id="res-unit" class="resource-unit">ä¼ç‰¹</span>
<span id="power-display" style="display:none; margin-left:20px; color:#ff00ff; font-size:1.2rem;">åŠ›é‡ï¼š<span id="power-val" style="color:#ff44ff; font-size:1.8rem; text-shadow:0 0 10px #ff00ff;">0</span><span style="font-size:0.9rem;color:#aa66aa">ï¼ˆä¸‡â†’äº¿â†’å…†â†’ä¸‡å…†ï¼‰</span> <span id="btn-ultimate-reset-inline" style="display:none;"><button onclick="game.doUltimateReset()" style="background:#330033;border:2px solid #ff00ff;color:#ff00ff;padding:4px 12px;cursor:pointer;font-family:var(--font-main);font-size:0.85rem;margin-left:10px;" title="é‡ç½®è·å–ç»ˆæç‚¹æ•°">é‡ç½® (â†’ç»ˆæç‚¹æ•°: +<span id="ultimate-reset-preview">0</span>)</button></span></span>
</div>
<div class="global-mult">æ€»å€ç‡ï¼šx<span id="total-mult">1.00</span> (æˆå°±ï¼šx<span id="ach-mult">1.00</span> | å¢ƒç•Œï¼šx<span id="realm-mult">1.00</span>)</div>
</div>
<div id="content-panels">
<!-- T1: ç”µæµæ¨åŠ¨ -->
<div id="view-tier1" class="panel-view active">
<h2>èµ·æºï¼šç”µæµæ¨åŠ¨</h2>
<p style="color:#888; margin-bottom: 10px; font-size: 1rem;">ç§¯ç´¯ä¼ç‰¹ã€‚<span id="volt-cap-info" style="color:var(--accent-color);">ä¸Šé™é”å®šä¸º60äº¿ã€‚</span><span style="color:var(--accent-color); font-weight:bold"> æç¤ºï¼šå³ä½¿è¿›å…¥é«˜å±‚ï¼Œä»å¯åœ¨æ­¤ç‚¹å‡»æˆ–å‡çº§ã€‚</span></p>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:15px;">
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">æ‘©æ“¦ç»†èƒ</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">ç‚¹å‡»äº§ç”Ÿç”µæµã€‚</p>
<button class="btn-buy" onclick="game.clickAction()" style="padding:8px;">æ¨åŠ¨ (+<span id="t1-click-val">1</span>V)</button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">å¼ºåŒ–èº«ä½“</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">ä»¥ç”µæµåŠ›é‡å¼ºåŒ–èº«ä½“ã€‚</p>
<button class="btn-buy" id="btn-buy-gen" onclick="game.buyGen()" style="padding:8px;">è´­ä¹° (èŠ±è´¹ï¼š<span id="cost-gen">10</span>V) æ‹¥æœ‰ï¼š<span id="count-gen">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">è¶…çº§æ„ŸçŸ¥ (ç‚¹å‡»)</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">å¢å¼ºæ‘©æ“¦ç»†èƒèƒ½åŠ›ã€‚</p>
<button class="btn-buy" id="btn-buy-cap" onclick="game.buyCap()" style="padding:8px;">å‡çº§ (<span id="cost-cap">50</span>V) ç­‰çº§ï¼š<span id="lvl-cap">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">ç”µæµå¢å¹… (æ•ˆç‡)</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">æå‡è‡ªåŠ¨æ‘©æ“¦ç»†èƒæ•ˆç‡ã€‚</p>
<button class="btn-buy" id="btn-buy-trans" onclick="game.buyTrans()" style="padding:8px;">å‡çº§ (<span id="cost-trans">200</span>V) ç­‰çº§ï¼š<span id="lvl-trans">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">ç”µæµåŠ›é‡ (å…¨å±€)</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">æå‡æ‰€æœ‰ç”µæµäº§å‡ºã€‚</p>
<button class="btn-buy" id="btn-buy-super" onclick="game.buySuper()" style="padding:8px;">é“ºè®¾ (<span id="cost-super">1000</span>V) ç­‰çº§ï¼š<span id="lvl-super">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;border-color: #00ccff; border-top-color: #00ccff;">
<h3 style="font-size:1rem;margin-bottom:5px;color: #00ccff">æœ¬æºåŠ é€Ÿ (ç”µæµ)</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">å¤§å¹…æå‡ä¼ç‰¹é€Ÿåº¦ (x1.5/çº§)ã€‚</p>
<button class="btn-buy heal" id="btn-buy-t1-boost" onclick="game.buyT1Boost()" style="padding:8px;">å‡çº§ (<span id="cost-t1-boost">100k</span>V) ç­‰çº§ï¼š<span id="lvl-t1-boost">0</span>/3</button>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;">
<div class="upgrade-card" style="padding:15px;border-color: var(--danger-color); border-top-color: var(--danger-color);">
<h3 style="color: var(--danger-color);margin-bottom:5px;">æ•£åŠŸé‡ä¿®</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.85rem;">é‡ç½®ä¼ç‰¹ï¼Œè·å¾—æ°¸ä¹…å€æ•°å¢å¹…ã€‚<span style="color:#aaa">256å€åéœ€æ±‚å¤§å¹…æå‡ã€‚</span></p>
<button class="btn-buy danger" id="btn-prestige" onclick="game.doPrestige()">ç«‹å³é‡ä¿® (å½“å‰å€æ•°ï¼šx<span id="prestige-mult-disp">1</span>)</button>
<div class="progress-wrap"><div id="prog-prestige" class="progress-fill danger"></div></div>
</div>
<div class="upgrade-card" style="padding:15px;border-color: var(--gold-color); border-top-color: var(--gold-color);" id="card-volt-retention">
<h3 style="color: var(--gold-color);margin-bottom:5px;">ä¼ç‰¹æœ¬æºä¿ç•™</h3>
<p id="volt-retention-desc" style="height:auto;margin:0 0 8px;font-size:0.85rem;">æ•£åŠŸé‡ä¿®è¾¾åˆ°64å€åè§£é”ã€‚ä¿ç•™å¹¶è‡ªåŠ¨è´­ä¹°ä¼ç‰¹å±‚çº§å‡çº§ã€‚</p>
<button class="btn-buy gold" id="btn-buy-volt-retention" onclick="game.buyVoltRetention()" disabled>è§£é” (éœ€64å€é‡ä¿®)</button>
<div style="font-size: 0.7rem; color: #888; margin-top: 5px;">å½“å‰ç­‰çº§ï¼š<span id="volt-retention-lvl">0</span>/5</div>
</div>
<div class="upgrade-card" style="padding:15px;border-color: var(--gold-color); border-top-color: var(--gold-color);" id="card-breakthrough-t1">
<h3 style="color: var(--gold-color);margin-bottom:5px;">çªç ´ç•Œé™</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.85rem;">å½“ä¼ç‰¹è¾¾åˆ° 500,000 æ—¶ï¼Œè§£é”çœŸæ­£åŠ›é‡ï¼šç£åœºè½¬åŠ¨ã€‚</p>
<button class="btn-buy gold" id="btn-breakthrough" onclick="game.enterTier2()" disabled>çªç ´è‡³ç£åœºè½¬åŠ¨ (éœ€ 500,000 V)</button>
</div>
</div>
</div>
<!-- T2: ç£åœºè½¬åŠ¨ -->
<div id="view-tier2" class="panel-view">
<h2 style="color: var(--danger-color)">ç£åœºè½¬åŠ¨</h2>
<p style="color:#888; margin-bottom: 10px; font-size: 1rem;">æ­¤å¤„ç§¯ç´¯<strong>åŒ¹æ•°</strong>ã€‚ä¼ç‰¹å·²ä¿ç•™ï¼ˆå¯åˆ‡æ¢æ ‡ç­¾æŸ¥çœ‹/å‡çº§ï¼‰ã€‚ç›®æ ‡ï¼š100,000 åŒ¹ã€‚<span style="color:var(--danger-color); font-weight:bold"> è¶…è¿‡10ä¸‡åŒ¹åè·å–éš¾åº¦æ€¥å‰§ä¸Šå‡ï¼Œå¿…é¡»è¿›å…¥ç¬¬ä¸‰å±‚ï¼</span></p>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:15px;">
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">ç£åœºè½¬åŠ¨ï¼</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">ç‚¹å‡»äº§ç”ŸåŒ¹æ•°ã€‚</p>
<button class="btn-buy" onclick="game.clickActionHP()" style="padding:8px;">æ¿€å‘ (+<span id="t2-click-val">1</span>åŒ¹)</button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">ç£åœºé©¬åŠ›</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">æå‡ä¸»åŠ¨ç‚¹å‡»å¨åŠ›ã€‚</p>
<button class="btn-buy" id="btn-buy-hp-upg" onclick="game.buyHPUpg()" style="padding:8px;">å‹ç¼© (<span id="cost-hp-upg">100</span>åŒ¹) ç­‰çº§ï¼š<span id="lvl-hp-upg">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">ç»†èƒé‡ç»„</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">è‡ªåŠ¨äº§ç”ŸåŒ¹æ•°ã€‚</p>
<button class="btn-buy" id="btn-buy-volt-upg" onclick="game.buyVoltUpg()" style="padding:8px;">å…±æŒ¯ (<span id="cost-volt-upg">500</span>åŒ¹) ç­‰çº§ï¼š<span id="lvl-volt-upg">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">ç¬¬äºŒé¢—å¿ƒè„</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">åˆ©ç”¨ä¼ç‰¹åŠ é€ŸåŒ¹æ•°è·å–ã€‚</p>
<button class="btn-buy" id="btn-buy-volt-conv" onclick="game.buyVoltConv()" style="padding:8px;">å‡çº§ (<span id="cost-volt-conv">50000</span>åŒ¹) ç­‰çº§ï¼š<span id="lvl-volt-conv">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">ç£åœºå¤§è„‘</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">å¢åŠ è‡ªåŠ¨è·å–åŒ¹æ•°é‡ã€‚</p>
<button class="btn-buy" id="btn-buy-auto-hp" onclick="game.buyAutoHP()" style="padding:8px;">å‡çº§ (<span id="cost-auto-hp">3000</span>åŒ¹) ç­‰çº§ï¼š<span id="lvl-auto-hp">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;">
<h3 style="font-size:1rem;margin-bottom:5px;">æƒ…ç»ªæ¨åŠ¨</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">æå‡ä¸»åŠ¨è·å–çš„åŒ¹æ•°é‡ã€‚</p>
<button class="btn-buy" id="btn-buy-click-hp" onclick="game.buyClickHP()" style="padding:8px;">å‡çº§ (<span id="cost-click-hp">1500</span>åŒ¹) ç­‰çº§ï¼š<span id="lvl-click-hp">0</span></button>
</div>
<div class="upgrade-card" style="padding:12px;border-color:#00ccff;border-top-color:#00ccff;">
<h3 style="font-size:1rem;margin-bottom:5px;color:#00ccff">æœ¬æºåŠ é€Ÿ (ç£åœº)</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.8rem;">å¤§å¹…æå‡åŒ¹æ•°é€Ÿåº¦ (x1.5/çº§)ã€‚</p>
<button class="btn-buy heal" id="btn-buy-t2-boost" onclick="game.buyT2Boost()" style="padding:8px;">å‡çº§ (<span id="cost-t2-boost">10k</span>åŒ¹) ç­‰çº§ï¼š<span id="lvl-t2-boost">0</span>/3</button>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;">
<div class="upgrade-card" style="padding:15px;border-color:var(--gold-color);border-top-color:var(--gold-color);">
<h3 style="color:var(--gold-color);margin-bottom:5px;">è¿›å…¥é‡ç”Ÿæ± è‹¦ä¿®</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.85rem;">é‡ç½®åŒ¹æ•°åŠç¬¬äºŒå±‚å‡çº§ï¼Œè·å¾—æ°¸ä¹…"è‹¦ä¿®å€æ•°"å¢å¹… (æ¯çº§x2.0)ã€‚<span style="color:#aaa">ä¸ä¼šé‡ç½®ä¼ç‰¹ã€ç¬¬ä¸€å±‚æˆ–ç¬¬ä¸‰å±‚ã€‚ä»·æ ¼é€’å¢ã€‚</span></p>
<button class="btn-buy gold" id="btn-t2-prestige" onclick="game.doT2Prestige()">è¿›å…¥è‹¦ä¿® (å½“å‰å€æ•°ï¼šx<span id="t2-prestige-mult-disp">1</span>)</button>
<div class="progress-wrap"><div id="prog-t2-prestige" class="progress-fill gold"></div></div>
<p style="font-size:0.7rem;color:#888;margin-top:5px;">éœ€æ±‚ï¼š<span id="t2-prestige-req">10,000</span> åŒ¹</p>
</div>
<div class="upgrade-card" style="padding:15px;border-color:var(--gold-color);border-top-color:var(--gold-color);" id="card-breakthrough-t2">
<h3 style="color:var(--gold-color);margin-bottom:5px;">ç£åœºåŠŸæ³•</h3>
<p style="height:auto;margin:0 0 8px;font-size:0.85rem;">å½“åŒ¹æ•°è¾¾åˆ° 100,000 æ—¶ï¼Œè§£é”ç£åœºåŠŸæ³•ã€‚</p>
<button class="btn-buy gold" id="btn-breakthrough-t2" onclick="game.enterTier3()" disabled>è¿›å…¥ç£åœºåŠŸæ³• (éœ€ 100,000 åŒ¹)</button>
</div>
</div>
</div>
<!-- T3: åœ°ç‹±ç£åœº -->
<div id="view-tier3" class="panel-view">
<h2 class="danger">ç£åœºåŠŸæ³•</h2>
<p style="color:#888; margin-bottom: 20px; font-size: 1.1rem;">ç£åœºå¼‚å˜ï¼Œæå‡æåº¦å›°éš¾ã€‚å”¯æœ‰å­¦ä¹ ç¥åŠŸå¯æå‡åŒ¹æ•°ã€‚<br><span style="color:#aaa">æç¤ºï¼šå¿…é¡»å‡»è´¥è¶³å¤Ÿå¤šçš„å¼ºè€…æ‰èƒ½è´­ä¹°åŠŸæ³•ã€‚è¿™æ˜¯å¼ºè€…çš„ä¸–ç•Œï¼</span></p>
<div class="info-row">å·²å‡»è´¥å¼ºè€…æ•°é‡ï¼š<span id="t3-wins-count">0</span> </div>
<div id="skill-list" class="stat-grid"></div>
</div>
<!-- æŒ‘æˆ˜å¼ºè€… -->
<div id="view-challenge" class="panel-view">
<h2 class="danger">æŒ‘æˆ˜å¼ºè€…</h2>
<p style="color:#888; font-size: 1.1rem;">é€šè¿‡æˆ˜æ–—è·å–â€œå®Œå…¨å¢ƒç•Œâ€ï¼ˆå•ä½ï¼šçº§ï¼‰ï¼Œç”¨äºè´­ä¹° ç»ˆæå¼ºåŒ–ã€‚<br><span style="color:#aaa">æ•Œäººå¼ºåº¦éšå‡»è´¥æ¬¡æ•°åŠ¨æ€è°ƒæ•´ï¼Œä½†ç»ä¸è¶…è¿‡ç©å®¶å±æ€§çš„1.5å€ã€‚æ— å†·å´æ—¶é—´ã€‚<br>è´­ä¹°"è‡ªåŠ¨æŒ‘æˆ˜"å‡çº§åï¼ŒæŒ‰é’®å°†æ˜¾ç¤ºè‡ªåŠ¨çŠ¶æ€ï¼Œèƒœåˆ©åè‡ªåŠ¨ç»§ç»­ï¼Œå¤±è´¥åè‡ªåŠ¨åœæ­¢ã€‚</span></p>
<div class="info-row">å·²å‡»è´¥å¼ºè€…æ•°é‡ï¼š<span id="challenge-wins-count">0</span></div>
<div id="battle-cap-status" style="margin:4px 0;font-size:0.85rem;color:#ff6644;display:none;">âš ï¸ å·²å‡»è´¥10000åæ•Œäººâ€”â€”æ•Œäººå±æ€§ä¸Šé™å·²è§£é™¤ï¼éœ€è´­ä¹°ç»ˆæå‡çº§æå‡å±æ€§æ‰èƒ½ç»§ç»­èƒœåˆ©ã€‚<br><span style="color:#00ffaa;">ğŸ”’ é¢å¤–è§£é”ï¼šå®Œå…¨å¢ƒç•Œæ°¸ä¹…é”å®šä¸‹é™ä¸º1ä¸‡ï¼ˆæ¶ˆè´¹ä¸ä¼šä½äºæ­¤å€¼ï¼‰ï¼Œå‡»è´¥æ•°é‡æ°¸ä¸é‡ç½®ã€‚</span></div>
<div id="battle-power-bonus" style="margin:4px 0;font-size:0.85rem;color:#aa44ff;display:none;"></div>
<div id="realm-lock-status" style="margin:4px 0;font-size:0.85rem;color:#00ffaa;display:none;">ğŸ”’ å®Œå…¨å¢ƒç•Œä¸å‡»è´¥æ•°é‡å·²æ°¸ä¹…é”å®šï¼Œä¸ä¼šå› é‡ç½®æˆ–è´­ä¹°æ‰£è‡³é›¶ã€‚</div>
<div class="battle-stats">
<div class="battle-side player">
<h3>æ­¦è€… (ä½ )</h3>
<div>æ”»å‡»åŠ›ï¼š<span id="player-atk" style="color:var(--accent-color); font-weight:bold">0</span></div>
<div>é˜²å¾¡åŠ›ï¼š<span id="player-def" style="color:var(--accent-color); font-weight:bold">0</span></div>
<div class="hp-bar-container">
<div id="player-hp-bar" class="hp-bar" style="width: 100%;"></div>
<div class="hp-text"><span id="player-hp-cur">100</span> / <span id="player-hp-max">100</span></div>
</div>
<div style="font-size: 0.9rem; color: #aaa;" id="hp-status-text">éæˆ˜æ–—æ—¶è‡ªåŠ¨å›è¡€</div>
</div>
<div class="battle-side enemy">
<h3>å¼ºè€… (æ•Œ) <span style="font-size:0.9rem; color:#888">No.<span id="enemy-wave-num">1</span></span></h3>
<!-- Large HP Display -->
<span class="enemy-hp-display"><span id="enemy-hp-cur">0</span> / <span id="enemy-hp-max">0</span></span>
<div class="hp-bar-container">
<div id="enemy-hp-bar" class="hp-bar" style="width: 100%;"></div>
<div class="hp-text">ç”Ÿå‘½åŠ›</div>
</div>
<div class="enemy-stat-row">æ”»å‡»åŠ›ï¼š<span id="enemy-atk">0</span></div>
<div class="enemy-stat-row">é˜²å¾¡åŠ›ï¼š<span id="enemy-def">0</span></div>
<div style="font-size: 0.8rem; color: #aaa;">å¼ºåº¦å—ç©å®¶å±æ€§è½¯ä¸Šé™é™åˆ¶</div>
</div>
</div>
<div class="battle-controls">
<div id="battle-status" class="battle-status status-waiting">å‡†å¤‡æŒ‘æˆ˜</div>
<div>
<button class="btn-buy danger btn-battle" id="btn-challenge" onclick="game.startChallenge()">å‘èµ·æŒ‘æˆ˜</button>
<button class="btn-buy btn-flee btn-battle" id="btn-flee" onclick="game.fleeBattle()" disabled>é€ƒèµ°</button>
</div>
<div style="margin-top: 20px; color: var(--gold-color); font-size: 1.5rem; font-family: var(--font-main);">å®Œå…¨å¢ƒç•Œï¼š<span id="realm-count">0</span> çº§</div>
<!-- NEW: Auto Battle Toggle Button -->
<div style="margin-top: 20px;">
<button class="btn-buy btn-battle" id="btn-auto-toggle" onclick="game.toggleAutoBattle()" style="min-width: auto; padding: 10px 20px; font-size: 1rem;">åˆ‡æ¢è‡ªåŠ¨æŒ‘æˆ˜</button>
</div>
</div>
<h3 class="gold" style="border-color: var(--gold-color); color: var(--gold-color); margin-top: 40px; font-family: var(--font-main); font-size: 1.8rem;">å¢ƒç•Œå‡å (å®Œå…¨å¢ƒç•Œå‡çº§)</h3>
<div class="stat-grid" id="realm-upgrades"></div>
</div>
<!-- T4: ç»ˆæå¼ºè€… -->
<div id="view-tier4" class="panel-view">
<h2 style="color:#ff00ff; border-color:#ff00ff; text-shadow:3px 3px 0 #300030;">ç»ˆæå¼ºè€…ä¹‹å¢ƒ</h2>
<div style="background:rgba(255,0,255,0.1); border:1px solid #ff00ff; padding:10px; margin-bottom:15px; text-align:center; font-family:var(--font-main);">
    <span style="color:#ff88ff; font-size:1.2rem;">åŠ›é‡ï¼š</span>
    <span id="t4-power-display" style="color:#ff00ff; font-size:1.8rem; text-shadow:0 0 10px #ff00ff;">0</span>
    <span style="color:#aa88aa; font-size:0.9rem;"> ( <span id="t4-pps-display">0</span> /ç§’ )</span>
</div>
<p style="color:#ccc; font-size:1.1rem; margin-bottom:10px;">åŠ›é‡çš„çœŸæ­£å¢ƒç•Œã€‚æ¥å—ä¹ä½ç»ˆæå¼ºè€…çš„æŒ‘æˆ˜ï¼Œçªç ´è‡ªæˆ‘æé™ã€‚<br>
<span style="color:#ff88ff;">åŠ›é‡æ¥è‡ªäºä½ çš„ç»ˆæå‡çº§æ•°é‡ï¼Œæ¯ç§’è‡ªåŠ¨å¢åŠ ã€‚<br>ç»ˆæç‚¹æ•°é€šè¿‡é‡ç½®æ¸¸æˆè·å¾—ï¼Œè¯·è€å¿ƒç­‰å¾…ä½ çš„ç¬¬ä¸€ä¸ªç»ˆæç‚¹æ•°ã€‚<br>å®Œå…¨å¢ƒç•Œï¼ˆä¸Šé™ä¸€ä¸‡çº§ï¼‰å’Œæµé‡å‡å¯æå‡åŠ›é‡äº§å‡ºã€‚</span></p>
<div style="background:#1a001a;border:2px solid #ff00ff;padding:15px;margin-bottom:20px;display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
<div style="color:#ff88ff;font-family:var(--font-main);font-size:1.3rem;">ç»ˆæç‚¹æ•°ï¼š<span id="ultimate-points-disp" style="color:#ff00ff;font-size:2rem;text-shadow:0 0 10px #ff00ff;">0</span></div>
<div style="color:#aa88aa;font-size:0.9rem;">åŠ›é‡äº§å‡ºï¼š<span id="power-per-sec" style="color:#ff88ff;">1</span>/ç§’</div>
<div style="color:#aa88aa;font-size:0.9rem;">âš¡ä¼ç‰¹åŠ æˆï¼š<span id="volt-power-bonus" style="color:#ffcc44;">x1.00</span>ï¼ˆæœ€å¤šx10ï¼‰</div>
<div style="color:#aa88aa;font-size:0.9rem;">ç»ˆæå‡çº§æ•°ï¼š<span id="ult-upg-count" style="color:#ff88ff;">0</span></div>
<div style="color:#aa88aa;font-size:0.9rem;">åŠ›é‡ä¸Šé™ï¼š<span id="power-cap-display" style="color:#ff88ff;">1å…†</span> <span id="power-cap-unlock-hint" style="color:#ffaa44;font-size:0.8rem;"></span></div>
<button onclick="game.doUltimateReset()" style="background:#330033;border:2px solid #ff00ff;color:#ff00ff;padding:8px 16px;cursor:pointer;font-family:var(--font-main);font-size:0.95rem;margin-left:auto;" title="é‡ç½®è·å–ç»ˆæç‚¹æ•°">âŸ³ é‡ç½®è·å–ç»ˆæç‚¹æ•° (+<span id="ultimate-reset-preview-t4">0</span>ç‚¹)</button>
<div id="ultimate-formula-status" style="margin-top:4px;"></div>
</div>
<h3 style="color:#ff00ff;font-family:var(--font-main);font-size:1.8rem;border-bottom:2px solid #ff00ff;padding-bottom:10px;">ç»ˆæå‡çº§æ ‘</h3>
<div id="ultimate-tree" style="display:flex;flex-direction:row;align-items:flex-start;flex-wrap:wrap;gap:8px;"></div>
<h3 style="color:#ff4444;font-family:var(--font-main);font-size:1.8rem;border-bottom:2px solid #ff4444;padding-bottom:10px;margin-top:30px;">ä¹ä½ç»ˆæå¼ºè€…æŒ‘æˆ˜</h3>
<div id="ultimate-challenges-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;"></div>
</div>
<!-- ç£åœºè‚‰ä½“ -->
<div id="view-magnetic-body" class="panel-view">
<h2 style="color:#00ffaa; border-color:#00ffaa; text-shadow:3px 3px 0 #003022;">ç£åœºè‚‰ä½“</h2>
<p style="color:#ccc; font-size:1.1rem;">åœ¨ç¬¬å››å±‚è¾¾åˆ°<strong style="color:#00ffaa;">100ä¸‡åŠ›é‡</strong>å¯è¿›è¡Œä¸€æ¬¡é‡ç½®ï¼Œè·å–ä¸€ä¸ªç£åœºè‚‰ä½“ã€‚éœ€æ±‚åå€é€’å¢ã€‚<br>
<span style="color:#88ffcc;">ç£åœºè‚‰ä½“ä¸ºèº«ä½“éƒ¨ä½æä¾›å¼ºåŠ›åŠ æˆï¼Œå¸®åŠ©çªç ´æé™ã€‚</span></p>
<div style="background:#001a0f;border:2px solid #00ffaa;padding:15px;margin-bottom:20px;display:flex;align-items:center;gap:30px;flex-wrap:wrap;">
<div style="color:#00ffaa;font-family:var(--font-main);font-size:1.1rem;">å·²æ‹¥æœ‰ç£åœºè‚‰ä½“ï¼š<span id="body-parts-count" style="color:#00ffaa;font-size:2rem;">0</span></div>
<div style="color:#88ffcc;font-size:0.9rem;">ä¸‹æ¬¡éœ€æ±‚ï¼š<span id="next-body-cost" style="color:#00ffaa;">100ä¸‡</span> åŠ›é‡</div>
<button onclick="game.doBodyReset()" id="btn-body-reset" style="background:#001a0f;border:2px solid #00ffaa;color:#00ffaa;padding:10px 20px;cursor:pointer;font-family:var(--font-main);" disabled>è·å–ç£åœºè‚‰ä½“</button>
</div>
<div id="body-parts-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;"></div>
</div>
<!-- æµé‡ -->
<div id="view-flow" class="panel-view">
<h2 style="color:#0099ff; border-color:#0099ff; text-shadow:3px 3px 0 #000033;">æµé‡</h2>
<p style="color:#ccc; font-size:1.1rem; margin-bottom:10px;">æµé‡æ˜¯æ¥è‡ªç»ˆæå¼ºè€…å±‚çš„ç‰¹æ®Šèµ„æºï¼Œä¸Šé™ä¸ºä¸€äº¿ã€‚<br>
<span style="color:#44aaff;">é€šè¿‡å……èƒ½ç§¯ç´¯æµé‡ï¼Œæµé‡è¶Šå¤šï¼Œç»ˆæå¼ºè€…å±‚åŠ›é‡äº§å‡ºè¶Šé«˜ï¼ˆæ¯1000æµé‡+5%ï¼‰ã€‚</span></p>
<div style="background:#000a1a;border:2px solid #0099ff;padding:15px;margin-bottom:20px;display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
<div style="color:#44aaff;font-family:var(--font-main);font-size:1.3rem;">å½“å‰æµé‡ï¼š<span id="flow-val" style="color:#0099ff;font-size:2rem;text-shadow:0 0 10px #0099ff;">0</span> / <span style="color:#0066aa;">1äº¿</span></div>
<div style="color:#aaccff;font-size:0.9rem;">å®Œå…¨å¢ƒç•ŒåŠ æˆåŠ›é‡äº§å‡ºï¼š<span id="flow-realm-bonus" style="color:#44aaff;">+0%</span></div>
<div style="color:#aaccff;font-size:0.9rem;">æµé‡åŠ æˆåŠ›é‡äº§å‡ºï¼š<span id="flow-power-bonus" style="color:#44aaff;">+0%</span></div>
</div>
<!-- å……èƒ½æ¡ -->
<div style="background:#000a1a;border:2px solid #0055aa;padding:20px;margin-bottom:20px;">
<h3 style="color:#44aaff;font-family:var(--font-main);">å……èƒ½</h3>
<p style="color:#aaa;font-size:0.9rem;">ç‚¹å‡»å……èƒ½æ¡å¼€å§‹å……èƒ½ï¼ˆçº¦2.5ç§’ï¼‰ï¼Œå……æ»¡åè‡ªåŠ¨è·å–æµé‡ã€‚è´­ä¹°ã€Œè‡ªåŠ¨å……èƒ½ã€å‡çº§åæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ã€‚</p>
<div id="flow-charge-bar-wrap" style="background:#001133;height:40px;width:100%;border:2px solid #0055aa;position:relative;cursor:pointer;margin-bottom:10px;overflow:hidden;" onclick="game.startFlowCharge()">
<div id="flow-charge-bar" style="height:100%;background:linear-gradient(90deg,#003388,#0099ff);width:0%;transition:width 0.1s;box-shadow:0 0 15px rgba(0,153,255,0.5);"></div>
<div style="position:absolute;top:0;left:0;width:100%;text-align:center;line-height:40px;font-family:var(--font-main);color:#fff;text-shadow:1px 1px 2px #000;font-size:1.1rem;" id="flow-charge-text">ç‚¹å‡»å……èƒ½</div>
</div>
<div style="color:#44aaff;font-size:0.9rem;">æ¯æ¬¡å……æ»¡è·å–ï¼š<span id="flow-amount-per-charge" style="color:#0099ff;font-weight:bold;">1</span> æµé‡ &nbsp;|&nbsp; å……èƒ½æ—¶é—´ï¼š<span id="flow-time-text">2.5</span>s</div>
</div>
<!-- æµé‡å‡çº§ -->
<h3 style="color:#0099ff;font-family:var(--font-main);font-size:1.5rem;border-bottom:2px solid #0099ff;padding-bottom:8px;">æµé‡å‡çº§</h3>
<p style="color:#888;font-size:0.9rem;">ä»…å¼ºåŒ–æµé‡ç³»ç»Ÿï¼Œä¸å½±å“å…¶ä»–å†…å®¹ã€‚</p>
<div id="flow-upg-list" class="stat-grid"></div>
</div>
<div id="view-achievements" class="panel-view">
<h2 class="gold">æ­¦é“æˆå°±</h2>
<p style="color:#888; font-size: 1.1rem;">å®Œæˆæˆå°±ä»¥è·å¾—æ°¸ä¹…å€ç‡åŠ æˆã€‚è¿™å°±æ˜¯å¼ºè€…çš„è¯æ˜ï¼</p>
<div id="achievement-list"></div>
</div>
</div>
<div id="log-container"></div>
</div>
<!-- Cinematic Ending Screen -->
<div id="cinematic-screen">
<div id="cinematic-text"></div>
<button id="cinematic-restart-btn" onclick="game.enterTier4World()">è¿›å…¥ç»ˆæå¼ºè€…ä¹‹å¢ƒ</button>
<button id="cinematic-confirm-btn" onclick="game.cinematicConfirm()" style="display:none;margin-top:30px;padding:16px 48px;font-size:1.2rem;background:transparent;border:2px solid var(--gold-color);color:var(--gold-color);cursor:pointer;font-family:var(--font-main);text-transform:uppercase;letter-spacing:3px;transition:all 0.3s;">æ˜¯çš„</button>
</div>
<script>
// --- æ¸¸æˆé€»è¾‘éƒ¨åˆ† ---
const CONFIG = {
hardCap: 100000,
finalCap: 1000000,
voltHardCap: 100000000,
t1Breakthrough: 500000,
t2Breakthrough: 100000,
t3Breakthrough: 999999,
prestigeReq: 5000,
t2PrestigeReq: 50000, // ä¿®æ”¹ï¼šæé«˜åŸºç¡€éœ€æ±‚ï¼Œä»10000æ”¹ä¸º50000
powerCap: 1e12, // 1å…†ï¼ˆåŸºç¡€ä¸Šé™ï¼Œå®ŒæˆæŒ‘æˆ˜åé€æ­¥è§£é”ï¼‰
// å„æŒ‘æˆ˜å®Œæˆåè§£é”çš„åŠ›é‡ä¸Šé™ï¼ˆå®Œæˆnä¸ªæŒ‘æˆ˜åä½¿ç”¨ç¬¬né¡¹ï¼‰
challengePowerCaps: [1e12, 1e13, 1e14, 1e15, 1e16, 1e17, 1e18, 1e19, 1e20, 1e21],
bodyResetCosts: [1e13, 1e15, 1e17, 5e17, 9.9e18],
// æœ€é«˜ä¸Šé™ï¼š1e21ï¼ˆä¸€ç™¾ä¸‡å…†ï¼‰
realmCap: 10000, // å®Œå…¨å¢ƒç•Œä¸Šé™
// Ultimate upgrade tree: 50+ nodes, challenges are SEPARATE (reqChallenge links to challenge)
// reqPower: minimum power needed at time of purchase (checking against saved power from reset)
ultimateUpgrades: [
  // === ROW 0: æ ¹åŸº ===
  { id: 'u_root', name: 'ç»ˆæä¹‹æ ¹', desc: 'ä¸€åˆ‡ç»ˆæåŠ›é‡çš„èµ·ç‚¹ã€‚åŠ›é‡äº§å‡ºx1.5ã€‚', cost: 1, row: 0, requires: null },

  // === ROW 1: åˆå§‹åˆ†æ”¯ (cost: 5-15ç‚¹) ===
  { id: 'u_power1', name: 'åŠ›é‡æ„ŸçŸ¥I', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦x1.5ã€‚', cost: 5, row: 1, requires: 'u_root' },
  { id: 'u_time1', name: 'æ—¶é—´æ„Ÿæ‚ŸI', desc: 'åŠ›é‡äº§å‡ºx1.3ï¼ˆå‰ä¸‰å±‚å·²æ»¡ä¸é€‚ç”¨ï¼‰ã€‚', cost: 5, row: 1, requires: 'u_root' },
  { id: 'u_speed1', name: 'é€Ÿåº¦I', desc: 'åŠ›é‡äº§å‡ºx1.2ï¼Œæ‰€æœ‰èµ„æºé€Ÿåº¦x1.1ã€‚', cost: 8, row: 1, requires: 'u_root' },

  // === ROW 1.5: æ—©æœŸåŠ é€Ÿ (cost: 20-50ç‚¹) ===
  { id: 'u_power1b', name: 'åŠ›é‡å†²åŠ¨', desc: 'åŠ›é‡äº§å‡ºå†x1.3ã€‚', cost: 20, row: 2, requires: 'u_power1' },
  { id: 'u_time1b', name: 'æ—¶é—´æ„Ÿæ‚ŸIb', desc: 'åŠ›é‡äº§å‡ºx1.3ï¼ˆå¼ºåŒ–è‡ªèº«ç§¯ç´¯ï¼‰ã€‚', cost: 20, row: 2, requires: 'u_time1' },
  { id: 'u_speed1b', name: 'é€Ÿåº¦II', desc: 'åŠ›é‡äº§å‡ºx1.3ï¼Œç‚¹å‡»èµ„æºx1.5ã€‚', cost: 25, row: 2, requires: 'u_speed1' },
  { id: 'u_body1b', name: 'è‚‰ä½“æ„ŸçŸ¥', desc: 'æ‰€æœ‰è‚‰ä½“åŠ æˆæ•ˆæœx1.2ã€‚', cost: 30, row: 2, requires: null },
  { id: 'u_chal_unlock1', name: 'æŒ‘æˆ˜è§£é”I', desc: 'è§£é”æŒ‘æˆ˜2ã€3ï¼ˆéœ€å…ˆå®ŒæˆæŒ‘æˆ˜1ï¼‰ã€‚', cost: 50, row: 2, requires: 'u_root', reqChallenge: 'c1' },

  // === ROW 2: ç™¾ç‚¹çº§ (cost: 100-500ç‚¹) ===
  { id: 'u_power2', name: 'åŠ›é‡æ„ŸçŸ¥II', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x2ã€‚', cost: 1e2, row: 3, requires: 'u_power1b' },
  { id: 'u_body2', name: 'è‚‰ä½“å¼ºåŒ–II', desc: 'ç£åœºè‚‰ä½“åŠ æˆæ•ˆæœx1.5ã€‚', cost: 1e2, row: 3, requires: 'u_body1b' },
  { id: 'u_time2', name: 'æ—¶é—´æ„Ÿæ‚ŸII', desc: 'åŠ›é‡äº§å‡ºx1.5ï¼Œå¼ºåŒ–è‡ªèº«ç§¯ç´¯ã€‚', cost: 1e2, row: 3, requires: 'u_time1b' },
  { id: 'u_speed2', name: 'é€Ÿåº¦III', desc: 'åŠ›é‡äº§å‡ºx1.5ï¼Œè‡ªåŠ¨èµ„æºx1.2ã€‚', cost: 1e2, row: 3, requires: 'u_speed1b' },
  { id: 'u_power2b', name: 'åŠ›é‡æ¿€æ¶Œ', desc: 'åŠ›é‡äº§å‡ºå†x1.5ã€‚', cost: 3e2, row: 3, requires: 'u_power2' },
  { id: 'u_click1', name: 'ç‚¹å‡»å¼ºåŒ–åˆ', desc: 'ç‚¹å‡»è·å–èµ„æºx2ã€‚', cost: 2e2, row: 3, requires: 'u_speed2' },

  // === ROW 3: åƒç‚¹çº§ (cost: 1e3-5e3) ===
  { id: 'u_power3', name: 'åŠ›é‡æ„ŸçŸ¥III', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x3ã€‚', cost: 1e3, row: 4, requires: 'u_power2b' },
  { id: 'u_body3', name: 'è‚‰ä½“å¼ºåŒ–III', desc: 'ç£åœºè‚‰ä½“åŠ æˆæ•ˆæœå†x2ï¼Œé‡ç½®éœ€æ±‚å‡åŠã€‚', cost: 1e3, row: 4, requires: 'u_body2' },
  { id: 'u_time3', name: 'æ—¶é—´æ„Ÿæ‚ŸIII', desc: 'åŠ›é‡äº§å‡ºx2ï¼Œå¼ºåŒ–è‡ªèº«ç§¯ç´¯ã€‚', cost: 1e3, row: 4, requires: 'u_time2' },
  { id: 'u_volt_boost', name: 'ç”µæµæœ¬æº', desc: 'åŠ›é‡äº§å‡ºx1.5ï¼Œä¼ç‰¹è‡ªåŠ¨äº§å‡ºx2ã€‚', cost: 1e3, row: 4, requires: 'u_time2' },
  { id: 'u_speed3', name: 'é€Ÿåº¦IV', desc: 'åŠ›é‡äº§å‡ºx2ï¼Œå…¨å±€èµ„æºx1.2ã€‚', cost: 1e3, row: 4, requires: 'u_speed2' },
  { id: 'u_click2', name: 'ç‚¹å‡»å¼ºåŒ–II', desc: 'ç‚¹å‡»è·å–èµ„æºå†x2ã€‚', cost: 2e3, row: 4, requires: 'u_click1' },
  { id: 'u_chal_unlock2', name: 'æŒ‘æˆ˜è§£é”II', desc: 'è§£é”æŒ‘æˆ˜4ã€5ï¼ˆéœ€å…ˆå®ŒæˆæŒ‘æˆ˜3ï¼‰ã€‚', cost: 5e3, row: 4, requires: 'u_chal_unlock1', reqChallenge: 'c3' },

  // === ROW 4: ä¸‡ç‚¹çº§ (cost: 1e4-5e4) ===
  { id: 'u_power4', name: 'åŠ›é‡æ„ŸçŸ¥IV', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x5ã€‚', cost: 1e4, row: 5, requires: 'u_power3' },
  { id: 'u_body4', name: 'è‚‰ä½“è§‰é†’', desc: 'åŒæ—¶æ‹¥æœ‰3ä¸ªè‚‰ä½“æ—¶ï¼Œå…¨å±€é¢å¤–x2ã€‚', cost: 1e4, row: 5, requires: 'u_body3' },
  { id: 'u_mag_boost', name: 'ç£åœºæœ¬æº', desc: 'åŠ›é‡äº§å‡ºx1.5ï¼ŒåŒ¹æ•°è‡ªåŠ¨äº§å‡ºx2ã€‚', cost: 1e4, row: 5, requires: 'u_volt_boost' },
  { id: 'u_realm_boost', name: 'å¢ƒç•Œæ„Ÿæ‚Ÿ', desc: 'å®Œå…¨å¢ƒç•Œå¥–åŠ±+100%ã€‚', cost: 1e4, row: 5, requires: 'u_time3' },
  { id: 'u_speed4', name: 'é€Ÿåº¦V', desc: 'åŠ›é‡äº§å‡ºx2.5ï¼Œç‚¹å‡»x1.5ã€‚', cost: 1e4, row: 5, requires: 'u_speed3' },
  { id: 'u_power4b', name: 'åŠ›é‡çˆ†å‘', desc: 'åŠ›é‡äº§å‡ºå†x2ã€‚', cost: 2e4, row: 5, requires: 'u_power4' },
  { id: 'u_click3', name: 'ç‚¹å‡»å¼ºåŒ–III', desc: 'ç‚¹å‡»è·å–èµ„æºå†x3ã€‚', cost: 2e4, row: 5, requires: 'u_click2' },
  { id: 'u_chal_unlock3', name: 'æŒ‘æˆ˜è§£é”III', desc: 'è§£é”æŒ‘æˆ˜6ã€7ï¼ˆéœ€å…ˆå®ŒæˆæŒ‘æˆ˜5ï¼‰ã€‚', cost: 4e4, row: 5, requires: 'u_chal_unlock2', reqChallenge: 'c5' },

  // === ROW 5: åä¸‡ç‚¹çº§ (cost: 1e5-5e5) ===
  { id: 'u_power5', name: 'åŠ›é‡æ„ŸçŸ¥V', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x8ã€‚', cost: 1e5, row: 6, requires: 'u_power4b' },
  { id: 'u_click_boost', name: 'ç‚¹å‡»å¼ºåŒ–IV', desc: 'ç‚¹å‡»è·å–èµ„æºå†x4ã€‚', cost: 1e5, row: 6, requires: 'u_click3' },
  { id: 'u_prestige_boost', name: 'é‡ä¿®æ„Ÿæ‚Ÿ', desc: 'æ•£åŠŸé‡ä¿®å€ç‡+50%ï¼ˆå åŠ ï¼‰ã€‚', cost: 1e5, row: 6, requires: 'u_realm_boost' },
  { id: 'u_body5', name: 'è‚‰ä½“å…¨æ»¡', desc: 'æ‹¥æœ‰å…¨éƒ¨5ä¸ªè‚‰ä½“æ—¶ï¼ŒåŠ›é‡äº§å‡ºx5ã€‚', cost: 1e5, row: 6, requires: 'u_body4' },
  { id: 'u_volt_boost2', name: 'ç”µæµæœ¬æºII', desc: 'åŠ›é‡äº§å‡ºx2ï¼Œä¼ç‰¹è‡ªåŠ¨äº§å‡ºx3ã€‚', cost: 1e5, row: 6, requires: 'u_volt_boost' },
  { id: 'u_mag_boost2', name: 'ç£åœºæœ¬æºII', desc: 'åŠ›é‡äº§å‡ºx2ï¼ŒåŒ¹æ•°è‡ªåŠ¨äº§å‡ºx3ã€‚', cost: 1e5, row: 6, requires: 'u_mag_boost' },
  { id: 'u_speed5', name: 'é€Ÿåº¦VI', desc: 'åŠ›é‡äº§å‡ºx3ï¼Œå…¨å±€èµ„æºx1.5ã€‚', cost: 2e5, row: 6, requires: 'u_speed4' },
  { id: 'u_chal_unlock4', name: 'æŒ‘æˆ˜è§£é”IV', desc: 'è§£é”æŒ‘æˆ˜8ã€9ï¼ˆéœ€å…ˆå®ŒæˆæŒ‘æˆ˜7ï¼‰ã€‚', cost: 4e5, row: 6, requires: 'u_chal_unlock3', reqChallenge: 'c7' },

  // === ROW 6: ç™¾ä¸‡ç‚¹çº§ (cost: 1e6-5e6) ===
  { id: 'u_power6', name: 'åŠ›é‡æ„ŸçŸ¥VI', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x15ã€‚', cost: 1e6, row: 7, requires: 'u_power5' },
  { id: 'u_click_boost2', name: 'ç‚¹å‡»å¼ºåŒ–V', desc: 'ç‚¹å‡»è·å–èµ„æºå†x5ã€‚', cost: 1e6, row: 7, requires: 'u_click_boost' },
  { id: 'u_t2prestige', name: 'è‹¦ä¿®é¡¿æ‚Ÿ', desc: 'è‹¦ä¿®å€ç‡ä¸å—é€’å¢æƒ©ç½šï¼ˆæ¯æ¬¡å‡+100%ï¼‰ã€‚', cost: 1e6, row: 7, requires: 'u_prestige_boost' },
  { id: 'u_body_regen', name: 'è‚‰ä½“å†ç”Ÿ', desc: 'æ‹¥æœ‰å¿ƒè„è‚‰ä½“æ—¶ï¼Œå—ä¼¤æ¢å¤æ—¶é—´å‡å°‘80%ã€‚', cost: 1e6, row: 7, requires: 'u_body5' },
  { id: 'u_skill_boost', name: 'åŠŸæ³•é¡¿æ‚Ÿ', desc: 'ç¬¬ä¸‰å±‚åŠŸæ³•äº§å‡ºå€ç‡ç¿»å€ã€‚', cost: 1e6, row: 7, requires: 'u_time3' },
  { id: 'u_speed6', name: 'é€Ÿåº¦VII', desc: 'åŠ›é‡äº§å‡ºx4ï¼Œæ‰€æœ‰èµ„æºx2ã€‚', cost: 2e6, row: 7, requires: 'u_speed5' },
  { id: 'u_power6b', name: 'åŠ›é‡æ´ªæµ', desc: 'åŠ›é‡äº§å‡ºå†x3ã€‚', cost: 3e6, row: 7, requires: 'u_power6' },

  // === ROW 7: åƒä¸‡ç‚¹çº§ (cost: 1e7-5e7) ===
  { id: 'u_power7', name: 'åŠ›é‡æ„ŸçŸ¥VII', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x25ã€‚', cost: 1e7, row: 8, requires: 'u_power6b' },
  { id: 'u_volt_cap', name: 'ç”µæµè§£é™', desc: 'ä¼ç‰¹ä¸Šé™æå‡è‡³600äº¿ã€‚', cost: 1e7, row: 8, requires: 'u_click_boost2' },
  { id: 'u_battle_power', name: 'æˆ˜æ–—å¼ºåŒ–', desc: 'æŒ‘æˆ˜å¼ºè€…æ”»é˜²å±æ€§ç¿»å€ã€‚', cost: 1e7, row: 8, requires: 'u_realm_boost' },
  { id: 'u_speed7', name: 'é€Ÿåº¦VIII', desc: 'åŠ›é‡äº§å‡ºx5ï¼Œç‚¹å‡»èµ„æºx2ã€‚', cost: 1e7, row: 8, requires: 'u_speed6' },
  { id: 'u_volt_boost3', name: 'ç”µæµæœ¬æºIII', desc: 'åŠ›é‡äº§å‡ºx3ï¼Œä¼ç‰¹è‡ªåŠ¨äº§å‡ºx5ã€‚', cost: 2e7, row: 8, requires: 'u_volt_boost2' },
  { id: 'u_mag_boost3', name: 'ç£åœºæœ¬æºIII', desc: 'åŠ›é‡äº§å‡ºx3ï¼ŒåŒ¹æ•°è‡ªåŠ¨äº§å‡ºx5ã€‚', cost: 2e7, row: 8, requires: 'u_mag_boost2' },
  { id: 'u_chal_unlock5', name: 'æŒ‘æˆ˜è§£é”V', desc: 'è§£é”æŒ‘æˆ˜10ï¼ˆéœ€å…ˆå®ŒæˆæŒ‘æˆ˜9ï¼‰ã€‚', cost: 4e7, row: 8, requires: 'u_chal_unlock4', reqChallenge: 'c9' },

  // === ROW 8: äº¿ç‚¹çº§ (cost: 1e8-5e8) ===
  { id: 'u_power8', name: 'åŠ›é‡æ„ŸçŸ¥VIII', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x50ã€‚', cost: 1e8, row: 9, requires: 'u_power7' },
  { id: 'u_auto_all', name: 'å…¨è‡ªåŠ¨åŒ–', desc: 'æ•£åŠŸé‡ä¿®ã€è‹¦ä¿®è‡ªåŠ¨æ‰§è¡Œï¼ˆè¾¾åˆ°æ¡ä»¶åï¼‰ã€‚', cost: 1e8, row: 9, requires: 'u_volt_cap' },
  { id: 'u_softcap_kill', name: 'è½¯ä¸Šé™ç»ˆç»“', desc: 'æ¶ˆé™¤æ‰€æœ‰èµ„æºçš„è½¯ä¸Šé™æƒ©ç½šã€‚', cost: 1e8, row: 9},
  { id: 'u_realm_auto', name: 'å¢ƒç•Œè‡ªåŠ¨', desc: 'è‡ªåŠ¨è´­ä¹°æœ€ä½è´¹ç”¨çš„å¢ƒç•Œå‡çº§ã€‚', cost: 1e8, row: 9, requires: 'u_battle_power' },
  { id: 'u_body_synergy', name: 'è‚‰ä½“å…±é¸£', desc: 'æ¯æ‹¥æœ‰ä¸€ä¸ªè‚‰ä½“ï¼ŒåŠ›é‡äº§å‡º+100%ï¼ˆå åŠ ï¼‰ã€‚', cost: 1e8, row: 9, requires: 'u_body_regen' },
  { id: 'u_speed8', name: 'é€Ÿåº¦IX', desc: 'åŠ›é‡äº§å‡ºx6ï¼Œå…¨å±€x1.5ã€‚', cost: 2e8, row: 9, requires: 'u_speed7' },
  { id: 'u_power8b', name: 'åŠ›é‡æµªæ½®', desc: 'åŠ›é‡äº§å‡ºå†x5ã€‚', cost: 3e8, row: 9, requires: 'u_power8' },

  // === ROW 9: åäº¿ç‚¹çº§ (cost: 1e9-5e9) ===
  { id: 'u_power9', name: 'åŠ›é‡æ„ŸçŸ¥IX', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x100ã€‚', cost: 1e9, row: 10, requires: 'u_power8b' },
  { id: 'u_t3_free', name: 'ç¬¬ä¸‰å±‚è‡ªç”±', desc: 'ç¬¬ä¸‰å±‚åŠŸæ³•å¯ç”¨ï¼Œæ— éœ€å®ŒæˆæŒ‘æˆ˜æ¡ä»¶ã€‚', cost: 1e9, row: 10, requires: 'u_softcap_kill' },
  { id: 'u_all_boost', name: 'å…¨å±‚å…±é¸£', desc: 'æ‰€æœ‰å±‚çº§äº§å‡ºx3ã€‚', cost: 1e9, row: 10, requires: 'u_auto_all' },
  { id: 'u_challenge_reward', name: 'æŒ‘æˆ˜å¥–åŠ±å€å¢', desc: 'æ‰€æœ‰æŒ‘æˆ˜è·å¾—çš„ç»ˆæç‚¹æ•°x3ã€‚', cost: 1e9, row: 10, requires: 'u_realm_auto' },
  { id: 'u_speed9', name: 'é€Ÿåº¦X', desc: 'åŠ›é‡äº§å‡ºx8ï¼Œç‚¹å‡»x3ã€‚', cost: 1e9, row: 10, requires: 'u_speed8' },
  { id: 'u_volt_boost4', name: 'ç”µæµæœ¬æºIV', desc: 'åŠ›é‡äº§å‡ºx5ï¼Œä¼ç‰¹è‡ªåŠ¨äº§å‡ºx10ã€‚', cost: 2e9, row: 10, requires: 'u_volt_boost3' },
  { id: 'u_mag_boost4', name: 'ç£åœºæœ¬æºIV', desc: 'åŠ›é‡äº§å‡ºx5ï¼ŒåŒ¹æ•°è‡ªåŠ¨äº§å‡ºx10ã€‚', cost: 2e9, row: 10, requires: 'u_mag_boost3' },

  // === ROW 10: ç™¾äº¿ç‚¹çº§ (cost: 1e10-5e10) ===
  { id: 'u_power10', name: 'åŠ›é‡æ„ŸçŸ¥X', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x200ã€‚', cost: 1e10, row: 11, requires: 'u_power9' },
  { id: 'u_dimension', name: 'ç»´åº¦çªç ´', desc: 'æ‰€æœ‰å±‚çº§äº§å‡ºå†x10ã€‚', cost: 1e10, row: 11, requires: 'u_all_boost' },
  { id: 'u_godhood', name: 'ç¥æ ¼åˆæ˜¾', desc: 'åŠ›é‡äº§å‡ºå†x50ï¼ŒåŠ›é‡ä¸Šé™çªç ´é™åˆ¶ã€‚', cost: 1e10, row: 11, requires: 'u_t3_free' },
  { id: 'u_ultra_reward', name: 'è¶…çº§å¥–åŠ±', desc: 'æ‰€æœ‰æŒ‘æˆ˜è·å¾—çš„ç»ˆæç‚¹æ•°å†x5ã€‚', cost: 1e10, row: 11, requires: 'u_challenge_reward' },
  { id: 'u_speed10', name: 'é€Ÿåº¦XI', desc: 'åŠ›é‡äº§å‡ºx10ï¼Œå…¨å±€x2ã€‚', cost: 1e10, row: 11, requires: 'u_speed9' },
  { id: 'u_power10b', name: 'åŠ›é‡æ´ªæµII', desc: 'åŠ›é‡äº§å‡ºå†x10ã€‚', cost: 3e10, row: 11, requires: 'u_power10' },
  { id: 'u_body_all', name: 'è‚‰ä½“èåˆ', desc: 'ç£åœºè‚‰ä½“æ‰€æœ‰æ•ˆæœé¢å¤–x2ã€‚', cost: 2e10, row: 11, requires: 'u_body_synergy' },

  // === ROW 11: åƒäº¿ç‚¹çº§ (cost: 1e11-5e11) ===
  { id: 'u_power11', name: 'åŠ›é‡æ„ŸçŸ¥XI', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x300ã€‚', cost: 1e11, row: 12, requires: 'u_power10b' },
  { id: 'u_all_boost2', name: 'å…¨å±‚å…±é¸£II', desc: 'æ‰€æœ‰å±‚çº§äº§å‡ºå†x5ã€‚', cost: 1e11, row: 12, requires: 'u_dimension' },
  { id: 'u_godhood2', name: 'ç¥æ ¼ç»½æ”¾', desc: 'åŠ›é‡äº§å‡ºå†x100ã€‚', cost: 1e11, row: 12, requires: 'u_godhood' },
  { id: 'u_speed11', name: 'é€Ÿåº¦XII', desc: 'åŠ›é‡äº§å‡ºx12ï¼Œç‚¹å‡»x5ã€‚', cost: 1e11, row: 12, requires: 'u_speed10' },
  { id: 'u_volt_boost5', name: 'ç”µæµæ— é™', desc: 'åŠ›é‡äº§å‡ºx8ï¼Œä¼ç‰¹è‡ªåŠ¨äº§å‡ºx20ã€‚', cost: 2e11, row: 12, requires: 'u_volt_boost4' },
  { id: 'u_mag_boost5', name: 'ç£åœºæ— é™', desc: 'åŠ›é‡äº§å‡ºx8ï¼ŒåŒ¹æ•°è‡ªåŠ¨äº§å‡ºx20ã€‚', cost: 2e11, row: 12, requires: 'u_mag_boost4' },
  { id: 'u_realm_boost2', name: 'å¢ƒç•Œæ„Ÿæ‚ŸII', desc: 'å®Œå…¨å¢ƒç•Œå¥–åŠ±å†+200%ã€‚', cost: 3e11, row: 12, requires: 'u_all_boost2' },

  // === ROW 12: å…†ç‚¹çº§ (cost: 1e12-5e12) ===
  { id: 'u_power12', name: 'åŠ›é‡æ„ŸçŸ¥XII', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x500ã€‚', cost: 1e12, row: 13, requires: 'u_power11' },
  { id: 'u_all_boost3', name: 'å…¨å±‚å…±é¸£III', desc: 'æ‰€æœ‰å±‚çº§äº§å‡ºå†x10ã€‚', cost: 1e12, row: 13, requires: 'u_all_boost2' },
  { id: 'u_speed12', name: 'é€Ÿåº¦XIII', desc: 'åŠ›é‡äº§å‡ºx15ï¼Œå…¨å±€x3ã€‚', cost: 1e12, row: 13, requires: 'u_speed11' },
  { id: 'u_final1', name: 'ç»ˆæé¢†æ‚ŸI', desc: 'å…¨å±€äº§å‡ºx10ï¼ŒåŠ›é‡äº§å‡ºx500ã€‚', cost: 2e12, row: 13, requires: 'u_power12' },
  { id: 'u_ultimate_synergy', name: 'ç»ˆæå…±é¸£', desc: 'æ¯è´­ä¹°10ä¸ªç»ˆæå‡çº§ï¼ŒåŠ›é‡äº§å‡ºé¢å¤–x1.5ã€‚', cost: 3e12, row: 13, requires: 'u_godhood2' },

  // === ROW 13: åå…†ç‚¹çº§ (cost: 1e13-5e13) ===
  { id: 'u_power13', name: 'åŠ›é‡æ„ŸçŸ¥XIII', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x1000ã€‚', cost: 1e13, row: 14, requires: 'u_final1' },
  { id: 'u_final2', name: 'ç»ˆæé¢†æ‚ŸII', desc: 'æ‰€æœ‰è‚‰ä½“åŠ æˆæ•ˆæœx5ï¼Œç‚¹å‡»åŠ æˆx10ã€‚', cost: 1e13, row: 14, requires: 'u_all_boost3' },
  { id: 'u_speed13', name: 'é€Ÿåº¦XIV', desc: 'åŠ›é‡äº§å‡ºx20ï¼Œæ‰€æœ‰èµ„æºx5ã€‚', cost: 2e13, row: 14, requires: 'u_speed12' },
  { id: 'u_realm_boost3', name: 'å¢ƒç•Œæ„Ÿæ‚ŸIII', desc: 'å®Œå…¨å¢ƒç•Œå¥–åŠ±å†+500%ã€‚', cost: 3e13, row: 14, requires: 'u_realm_boost2' },

  // === ROW 14: ç™¾å…†ç‚¹çº§ (cost: 1e14-5e14) ===
  { id: 'u_power14', name: 'åŠ›é‡æ„ŸçŸ¥XIV', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x2000ã€‚', cost: 1e14, row: 15, requires: 'u_power13' },
  { id: 'u_all_boost4', name: 'å…¨å±‚å…±é¸£IV', desc: 'æ‰€æœ‰å±‚çº§äº§å‡ºå†x20ã€‚', cost: 1e14, row: 15, requires: 'u_final2' },
  { id: 'u_speed14', name: 'é€Ÿåº¦XV', desc: 'åŠ›é‡äº§å‡ºx30ï¼Œå…¨å±€x5ã€‚', cost: 2e14, row: 15, requires: 'u_speed13' },
  { id: 'u_final3', name: 'ç»ˆæé¢†æ‚ŸIII', desc: 'æŒ‘æˆ˜å¥–åŠ±ç»ˆæç‚¹æ•°x10ï¼Œé‡ç½®ç‚¹æ•°ç¿»å€ã€‚', cost: 3e14, row: 15, requires: 'u_ultra_reward' },

  // === ROW 15: åƒå…†ç‚¹çº§ (cost: 1e15-5e15) ===
  { id: 'u_power15', name: 'åŠ›é‡æ„ŸçŸ¥XV', desc: 'åŠ›é‡äº§å‡ºé€Ÿåº¦å†x5000ã€‚', cost: 1e15, row: 16, requires: 'u_power14' },
  { id: 'u_speed15', name: 'é€Ÿåº¦XVI', desc: 'åŠ›é‡äº§å‡ºx50ï¼Œæ‰€æœ‰èµ„æºx10ã€‚', cost: 1e15, row: 16, requires: 'u_speed14' },
  { id: 'u_all_boost5', name: 'å…¨å±‚å…±é¸£V', desc: 'æ‰€æœ‰å±‚çº§äº§å‡ºå†x50ã€‚', cost: 2e15, row: 16, requires: 'u_all_boost4' },
  { id: 'u_transcend_prep', name: 'è¶…è¶Šå‡†å¤‡', desc: 'åŠ›é‡äº§å‡ºx100ï¼Œè§£é”æœ€ç»ˆå‡çº§è·¯å¾„ã€‚', cost: 3e15, row: 16, requires: 'u_final3' },

  // === ROW 16: è¶…è¶Š ===
  { id: 'u_transcend', name: 'è¶…è¶Šè½®å›', desc: 'ä¸€åˆ‡äº§å‡ºx100ï¼Œæˆä¸ºçœŸæ­£çš„ç»ˆæå¼ºè€…ï¼', cost: 1e16, row: 17, requires: 'u_power15' },
  { id: 'u_final_power', name: 'æ— å°½åŠ›é‡', desc: 'åŠ›é‡äº§å‡ºx10000ï¼Œçªç ´ä¸€åˆ‡é™åˆ¶ï¼', cost: 2e16, row: 17, requires: 'u_transcend_prep' },

  // === å¤§é‡ä¸­æœŸå¡«å……å‡çº§ (é¢å¤–49ä¸ª) ===
  // åŠ›é‡ç³»åˆ—æ‰©å±•
  { id: 'u_pow_a1', name: 'åŠ›åœºéœ‡åŠ¨I', desc: 'åŠ›é‡äº§å‡ºx1.2ã€‚', cost: 15, row: 1, requires: 'u_root' },
  { id: 'u_pow_a2', name: 'åŠ›åœºéœ‡åŠ¨II', desc: 'åŠ›é‡äº§å‡ºx1.3ã€‚', cost: 60, row: 2, requires: 'u_pow_a1' },
  { id: 'u_pow_a3', name: 'åŠ›åœºéœ‡åŠ¨III', desc: 'åŠ›é‡äº§å‡ºx1.5ã€‚', cost: 500, row: 3, requires: 'u_pow_a2' },
  { id: 'u_pow_a4', name: 'åŠ›åœºéœ‡åŠ¨IV', desc: 'åŠ›é‡äº§å‡ºx2ã€‚', cost: 5000, row: 4, requires: 'u_pow_a3' },
  { id: 'u_pow_a5', name: 'åŠ›åœºéœ‡åŠ¨V', desc: 'åŠ›é‡äº§å‡ºx3ã€‚', cost: 5e4, row: 5, requires: 'u_pow_a4' },
  { id: 'u_pow_a6', name: 'åŠ›åœºéœ‡åŠ¨VI', desc: 'åŠ›é‡äº§å‡ºx5ã€‚', cost: 5e5, row: 6, requires: 'u_pow_a5' },
  { id: 'u_pow_a7', name: 'åŠ›åœºéœ‡åŠ¨VII', desc: 'åŠ›é‡äº§å‡ºx8ã€‚', cost: 5e6, row: 7, requires: 'u_pow_a6' },
  { id: 'u_pow_a8', name: 'åŠ›åœºéœ‡åŠ¨VIII', desc: 'åŠ›é‡äº§å‡ºx15ã€‚', cost: 5e7, row: 8, requires: 'u_pow_a7' },
  { id: 'u_pow_a9', name: 'åŠ›åœºéœ‡åŠ¨IX', desc: 'åŠ›é‡äº§å‡ºx30ã€‚', cost: 5e8, row: 9, requires: 'u_pow_a8' },
  { id: 'u_pow_a10', name: 'åŠ›åœºéœ‡åŠ¨X', desc: 'åŠ›é‡äº§å‡ºx60ã€‚', cost: 5e9, row: 10, requires: 'u_pow_a9' },
  // èµ„æºç³»åˆ—æ‰©å±•
  { id: 'u_res_a1', name: 'èµ„æºæ„ŸçŸ¥I', desc: 'åŠ›é‡äº§å‡ºx1.1ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 12, row: 1, requires: 'u_root' },
  { id: 'u_res_a2', name: 'èµ„æºæ„ŸçŸ¥II', desc: 'åŠ›é‡äº§å‡ºx1.2ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 80, row: 2, requires: 'u_res_a1' },
  { id: 'u_res_a3', name: 'èµ„æºæ„ŸçŸ¥III', desc: 'åŠ›é‡äº§å‡ºx1.3ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 800, row: 3, requires: 'u_res_a2' },
  { id: 'u_res_a4', name: 'èµ„æºæ„ŸçŸ¥IV', desc: 'åŠ›é‡äº§å‡ºx1.5ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 8000, row: 4, requires: 'u_res_a3' },
  { id: 'u_res_a5', name: 'èµ„æºæ„ŸçŸ¥V', desc: 'åŠ›é‡äº§å‡ºx2ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 8e4, row: 5, requires: 'u_res_a4' },
  { id: 'u_res_a6', name: 'èµ„æºæ„ŸçŸ¥VI', desc: 'åŠ›é‡äº§å‡ºx3ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 8e5, row: 6, requires: 'u_res_a5' },
  { id: 'u_res_a7', name: 'èµ„æºæ„ŸçŸ¥VII', desc: 'åŠ›é‡äº§å‡ºx5ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 8e6, row: 7, requires: 'u_res_a6' },
  { id: 'u_res_a8', name: 'èµ„æºæ„ŸçŸ¥VIII', desc: 'åŠ›é‡äº§å‡ºx8ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 8e7, row: 8, requires: 'u_res_a7' },
  { id: 'u_res_a9', name: 'èµ„æºæ„ŸçŸ¥IX', desc: 'åŠ›é‡äº§å‡ºx15ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 8e8, row: 9, requires: 'u_res_a8' },
  { id: 'u_res_a10', name: 'èµ„æºæ„ŸçŸ¥X', desc: 'åŠ›é‡äº§å‡ºx30ï¼Œè‡ªèº«è·å–å¼ºåŒ–ã€‚', cost: 8e9, row: 10, requires: 'u_res_a9' },
  // æˆ˜æ–—ç³»åˆ—æ‰©å±•
  { id: 'u_battle_a1', name: 'æ­¦é“ç²¾é€šI', desc: 'å…¨å±æ€§ï¼ˆæ”»å‡»/é˜²å¾¡ï¼‰ç¿» 1.00e200 å€ã€‚', cost: 10, row: 1, requires: 'u_root' },
  { id: 'u_battle_a2', name: 'æ­¦é“ç²¾é€šII', desc: 'æŒ‘æˆ˜å¼ºè€…æ”»å‡»+40%ï¼Œé˜²å¾¡+20%ã€‚', cost: 100, row: 2, requires: 'u_battle_a1' },
  { id: 'u_battle_a3', name: 'æ­¦é“ç²¾é€šIII', desc: 'æŒ‘æˆ˜æ”»é˜²ç¿»å€ã€‚', cost: 2000, row: 3, requires: 'u_battle_a2' },
  { id: 'u_battle_a4', name: 'æ­¦é“ç²¾é€šIV', desc: 'æŒ‘æˆ˜æ”»é˜²å†x2ã€‚', cost: 2e4, row: 4, requires: 'u_battle_a3' },
  { id: 'u_battle_a5', name: 'æ­¦é“ç²¾é€šV', desc: 'æŒ‘æˆ˜æ”»é˜²å†x3ã€‚', cost: 2e5, row: 5, requires: 'u_battle_a4' },
  { id: 'u_battle_a6', name: 'æ­¦é“ç²¾é€šVI', desc: 'å®Œå…¨å¢ƒç•Œå¥–åŠ±+100%ã€‚', cost: 2e6, row: 6, requires: 'u_battle_a5' },
  { id: 'u_battle_a7', name: 'æ­¦é“ç²¾é€šVII', desc: 'æŒ‘æˆ˜æ”»é˜²å†x5ã€‚', cost: 2e7, row: 7, requires: 'u_battle_a6' },
  { id: 'u_battle_a8', name: 'æ­¦é“æ— åŒI', desc: 'æ¯å‡»è´¥100ä½å¼ºè€…ï¼ŒåŠ›é‡äº§å‡º+10%ï¼ˆå åŠ ï¼‰ã€‚', cost: 2e8, row: 8, requires: 'u_battle_a7' },
  { id: 'u_battle_a9', name: 'æ­¦é“æ— åŒII', desc: 'æ¯å‡»è´¥100ä½å¼ºè€…ï¼ŒåŠ›é‡äº§å‡º+20%ï¼ˆå åŠ ï¼‰ã€‚', cost: 2e9, row: 9, requires: 'u_battle_a8' },
  { id: 'u_battle_a10', name: 'æ­¦é“æ— åŒIII', desc: 'æ¯å‡»è´¥100ä½å¼ºè€…ï¼ŒåŠ›é‡äº§å‡º+50%ï¼ˆå åŠ ï¼‰ã€‚', cost: 2e10, row: 10, requires: 'u_battle_a9' },
  // è‚‰ä½“ç³»åˆ—æ‰©å±•
  { id: 'u_body_a1', name: 'ç£åœºè‚‰ä½“æ„Ÿåº”I', desc: 'æ‹¥æœ‰ä¸€ä¸ªè‚‰ä½“æ—¶ï¼Œå…¨å±€å€ç‡+20%ã€‚', cost: 18, row: 1, requires: 'u_root' },
  { id: 'u_body_a2', name: 'ç£åœºè‚‰ä½“æ„Ÿåº”II', desc: 'æ‹¥æœ‰ä¸€ä¸ªè‚‰ä½“æ—¶ï¼Œå…¨å±€å€ç‡+40%ã€‚', cost: 150, row: 2, requires: 'u_body_a1' },
  { id: 'u_body_a3', name: 'ç£åœºè‚‰ä½“æ„Ÿåº”III', desc: 'ç£åœºè‚‰ä½“éœ€æ±‚-20%ã€‚', cost: 1500, row: 3, requires: 'u_body_a2' },
  { id: 'u_body_a4', name: 'ç£åœºè‚‰ä½“æ„Ÿåº”IV', desc: 'ç£åœºè‚‰ä½“éœ€æ±‚-30%ï¼ŒåŠ æˆx1.3ã€‚', cost: 1.5e4, row: 4, requires: 'u_body_a3' },
  { id: 'u_body_a5', name: 'ç£åœºè‚‰ä½“æ„Ÿåº”V', desc: 'ç£åœºè‚‰ä½“åŠ æˆx1.5ã€‚', cost: 1.5e5, row: 5, requires: 'u_body_a4' },
  { id: 'u_body_a6', name: 'ç£åœºè‚‰ä½“è§‰é†’', desc: 'ç£åœºè‚‰ä½“åŠ æˆx2ã€‚', cost: 1.5e6, row: 6, requires: 'u_body_a5' },
  { id: 'u_body_a7', name: 'ç£åœºè‚‰ä½“åœ†æ»¡', desc: 'ç£åœºè‚‰ä½“åŠ æˆx3ã€‚', cost: 1.5e7, row: 7, requires: 'u_body_a6' },
  { id: 'u_body_a8', name: 'ç£åœºè‚‰ä½“æé™', desc: 'ç£åœºè‚‰ä½“åŠ æˆx5ã€‚', cost: 1.5e8, row: 8, requires: 'u_body_a7' },
  // ç»¼åˆç³»åˆ—
  { id: 'u_synergy_a1', name: 'å…±é¸£åˆç°', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡+10%ã€‚', cost: 40, row: 2, requires: 'u_root' },
  { id: 'u_synergy_a2', name: 'å…±é¸£å¢å¹…', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡+20%ã€‚', cost: 400, row: 3, requires: 'u_synergy_a1' },
  { id: 'u_synergy_a3', name: 'å…±é¸£çˆ†å‘', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡x1.5ã€‚', cost: 4000, row: 4, requires: 'u_synergy_a2' },
  { id: 'u_synergy_a4', name: 'å…±é¸£æ´ªæµ', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡x2ã€‚', cost: 4e4, row: 5, requires: 'u_synergy_a3' },
  { id: 'u_synergy_a5', name: 'å…±é¸£è¶…è¶Š', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡x5ã€‚', cost: 4e5, row: 6, requires: 'u_synergy_a4' },
  { id: 'u_synergy_a6', name: 'å…±é¸£ç»ˆæ', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡x10ã€‚', cost: 4e6, row: 7, requires: 'u_synergy_a5' },
  { id: 'u_synergy_a7', name: 'å…±é¸£æ— å°½', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡x20ã€‚', cost: 4e7, row: 8, requires: 'u_synergy_a6' },
  { id: 'u_synergy_a8', name: 'å…±é¸£è¶…ç»´', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡x50ã€‚', cost: 4e8, row: 9, requires: 'u_synergy_a7' },
  { id: 'u_synergy_a9', name: 'å…±é¸£ç¥æ ¼', desc: 'æ‰€æœ‰èµ„æºå’ŒåŠ›é‡x100ï¼ŒåŠ›é‡äº§å‡ºé¢å¤–x10ã€‚', cost: 4e9, row: 10, requires: 'u_synergy_a8' },
  { id: 'u_ach_boost1', name: 'æˆå°±ä¹‹åŠ›I', desc: 'æˆå°±å€ç‡x1.5ï¼ŒåŠ›é‡äº§å‡º+50%ã€‚', cost: 3e4, row: 5, requires: 'u_synergy_a3' },
  { id: 'u_ach_boost2', name: 'æˆå°±ä¹‹åŠ›II', desc: 'æˆå°±å€ç‡x2ï¼ŒåŠ›é‡äº§å‡º+100%ã€‚', cost: 3e6, row: 7, requires: 'u_ach_boost1' },
],
// Challenges are SEPARATE from the tree â€” they are gated by challenge unlock upgrades
// powerReq: minimum current power needed to START the challenge

ultimateChallenges: [
  { id: 'c1', name: 'ç¬¬ä¸€ä½å¼ºè€…ï¼šå‡¶é‚ªé»‘å…½Â·å…‹è±¹',
    desc: 'ç¬¬ä¸€å±‚äº§å‡ºå‡å°‘90%ï¼Œæˆå°±åŠ æˆå®Œå…¨å°é”ï¼ˆæˆå°±å’Œå‡»è´¥æ•°é‡ä¿ç•™ï¼Œå®Œæˆ/æ”¾å¼ƒåæ¢å¤ï¼‰ã€‚ç¦æ­¢ç‚¹å‡»è·å–ä¼ç‰¹ï¼Œæœ¬æºåŠ é€Ÿç¦ç”¨ã€‚è¢«åŠ¨æ¯ç§’+1ä¼ç‰¹ï¼Œè‡ªåŠ¨è·å–ä¼ç‰¹Ã—10ã€‚ä»é›¶å¼€å§‹ï¼Œå®Œæˆç¬¬ä¸€ã€äºŒå±‚çªç ´ï¼ˆè¿›å…¥ç£åœºè½¬åŠ¨ï¼‰ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +1e8 & ç»ˆæç‚¹æ•°è·å–å…¬å¼å¼ºåŒ–ï¼ˆÃ—1.5å€æŒ‡æ•°åŠ æˆï¼‰', pointReward: 1e8, reqUpg: null, pointReq: 0, powerReq: 1e12, difficulty: 1,
    restriction: { t1Mult: 0.1, noAchMult: true, noClick: true, noT1Boost: true, c1PassiveVolt: true, c1AutoVoltX10: true }, winCondition: { tier: 2 } },
  { id: 'c2', name: 'ç¬¬äºŒä½å¼ºè€…ï¼šéœ¸è€…å¤©ç¥Â·å·¨é²¨å¤©ç‹',
    desc: 'ç¬¬äºŒå±‚äº§å‡ºå‡å°‘80%ã€‚ä»é›¶å¼€å§‹ï¼Œå®Œæˆä¸¤æ¬¡è‹¦ä¿®ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +5e10', pointReward: 5e10, reqUpg: 'u_chal_unlock1', pointReq: 5e7, powerReq: 5e12, difficulty: 2,
    restriction: { t2Mult: 0.2 }, winCondition: { t2PrestigeCount: 2 } },
  { id: 'c3', name: 'ç¬¬ä¸‰ä½å¼ºè€…ï¼šä¹‰ä¹‹é“ç‹Â·é‡Šå¤©é£',
    desc: 'æˆå°±å€ç‡å®Œå…¨å½’é›¶ã€‚ä»é›¶å¼€å§‹ï¼Œå®Œæˆå…¨éƒ¨ä¸‰å±‚çªç ´å¹¶è¿›å…¥ç£åœºåŠŸæ³•ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +5e13', pointReward: 5e13, reqUpg: 'u_chal_unlock1', pointReq: 2e10, powerReq: 2e13, difficulty: 3,
    restriction: { noAchMult: true }, winCondition: { tier: 3 } },
  { id: 'c4', name: 'ç¬¬å››ä½å¼ºè€…ï¼šä¸‡åƒæ­¦ç¥ä¸ºä¸€ä½“Â·æ— æå¤©ç‹',
    desc: 'ç¦ç”¨å‰ä¸‰å±‚æ‰€æœ‰ä¸»åŠ¨å‡çº§ï¼Œä»…ä¿ç•™ç‚¹å‡»ã€‚ä»é›¶å®Œæˆç¬¬ä¸€å±‚çªç ´ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +2e17', pointReward: 2e17, reqUpg: 'u_chal_unlock2', pointReq: 2e13, powerReq: 1e14, difficulty: 4,
    restriction: { noUpgrades: true }, winCondition: { tier: 2 } },
  { id: 'c5', name: 'ç¬¬äº”ä½å¼ºè€…ï¼šä¸€ç§’åœ°ç‹±Â·å¤§åˆ€æ­¦ç¥',
    desc: 'ä»…é™10åˆ†é’Ÿï¼Œå®Œæˆç¬¬ä¸€å±‚çªç ´ï¼ˆè¿›å…¥ç£åœºè½¬åŠ¨ï¼‰ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +1e21', pointReward: 1e21, reqUpg: 'u_chal_unlock2', pointReq: 1e17, powerReq: 5e14, difficulty: 5,
    restriction: { timeLimit: 600 }, winCondition: { tier: 2 } },
  { id: 'c6', name: 'ç¬¬å…­ä½å¼ºè€…ï¼šæ€äººé²¸Â·å¥¥åŠ ',
    desc: 'æ‰€æœ‰èµ„æºä¸Šé™å‡åŠã€‚ä»é›¶å®Œæˆç¬¬äºŒå±‚çªç ´ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +5e25', pointReward: 5e25, reqUpg: 'u_chal_unlock3', pointReq: 5e20, powerReq: 2e15, difficulty: 6,
    restriction: { halfCap: true }, winCondition: { tier: 2 } },
  { id: 'c7', name: 'ç¬¬ä¸ƒä½å¼ºè€…ï¼šæµ·è™Â·ç™½å†›æµª',
    desc: 'ç¦ç”¨ç¬¬ä¸€å±‚æ‰€æœ‰å‡çº§ï¼Œæˆå°±åŠ æˆå‡åŠã€‚ä»é›¶å®Œæˆå…¨éƒ¨ä¸‰å±‚çªç ´ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +1e31', pointReward: 1e31, reqUpg: 'u_chal_unlock3', pointReq: 1e26, powerReq: 1e16, difficulty: 7,
    restriction: { noT1Upgrades: true, halfAchMult: true }, winCondition: { tier: 3 } },
  { id: 'c8', name: 'ç¬¬å…«ä½å¼ºè€…ï¼šä»è€…æš—å¸Â·åˆ¹æš—å¤©',
    desc: 'æŒ‘æˆ˜å¼ºè€…å±æ€§x3å€ã€‚ä»é›¶å‡»è´¥150ä½å¼ºè€…ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +5e37', pointReward: 5e37, reqUpg: 'u_chal_unlock4', pointReq: 5e31, powerReq: 5e16, difficulty: 8,
    restriction: { enemyMult: 3.0 }, winCondition: { battleWins: 150 } },
  { id: 'c9', name: 'ç¬¬ä¹ä½å¼ºè€…ï¼šå¸è€…æˆ˜ç¥Â·ç™½æ­¦ç”·',
    desc: 'æ‰€æœ‰äº§å‡ºå‡å°‘98%ï¼Œæ—¶é—´é™åˆ¶15åˆ†é’Ÿã€‚ä»é›¶å®Œæˆç¬¬ä¸€å±‚çªç ´ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +2e45', pointReward: 2e45, reqUpg: 'u_chal_unlock4', pointReq: 2e38, powerReq: 2e17, difficulty: 9,
    restriction: { t1Mult: 0.02, t2Mult: 0.02, timeLimit: 900 }, winCondition: { tier: 2 } },
  { id: 'c10', name: 'ç¬¬åä½å¼ºè€…ï¼šé‡Šå¤©æ­¦',
    desc: 'ç»¼åˆå…¨éƒ¨é™åˆ¶ï¼ˆäº§å‡ºÃ—0.1ã€æˆå°±å½’é›¶ã€å‡çº§å°é”ã€æ— å¢ƒç•ŒåŠ æˆï¼‰ã€‚ä»é›¶å®Œæˆå…¨éƒ¨ä¸‰å±‚å¹¶è¿›å…¥ç£åœºåŠŸæ³•ã€‚',
    reward: 'ç»ˆæç‚¹æ•° +1e60', pointReward: 1e60, reqUpg: 'u_chal_unlock5', pointReq: 1e50, powerReq: 1e18, difficulty: 10,
    restriction: { t1Mult: 0.1, t2Mult: 0.1, noAchMult: true, noUpgrades: true }, winCondition: { tier: 3 } },
],
bodyParts: [
  { id: 'head', name: 'å¤´é¢…', desc: 'ç»ˆæå¤§è„‘å¼ºåŒ–ï¼Œå…¨å±€å€ç‡+50%', effect: 'globalMult', value: 1.5 },
  { id: 'arms', name: 'æ‰‹è‡‚', desc: 'ç£åœºåŠ›é‡åŠ æˆï¼Œç‚¹å‡»å€ç‡+100%', effect: 'clickMult', value: 2.0 },
  { id: 'heart', name: 'å¿ƒè„', desc: 'ç”Ÿå‘½åŠ›é‡æºæ³‰ï¼Œè‡ªåŠ¨äº§å‡ºé€Ÿåº¦+80%', effect: 'autoMult', value: 1.8 },
  { id: 'brain', name: 'å¤§è„‘', desc: 'æ™ºè¯†æè‡´ï¼Œå‡çº§å€ç‡+60%', effect: 'upgMult', value: 1.6 },
  { id: 'legs', name: 'å¤§è…¿', desc: 'åŠ›é‡æ ¹åŸºï¼Œæ‰€æœ‰å±‚çº§æ•°å€¼å¢é€Ÿ+70%', effect: 'speedMult', value: 1.7 },
],
skills: [
{ id: 'hell', name: 'åœ°ç‹±é“', baseCost: 100000, mult: 1.5, desc: 'è§£å¼€åœ°ç‹±ä¹‹è‹¦ï¼Œäº§å‡º x1.5ï¼Œä¸Šé™è§£é”è‡³ 20ä¸‡', reqWins: 50, capUnlock: 200000 },
{ id: 'tianwu', name: 'å¤©æ­¦æ€é“', baseCost: 200000, mult: 2.0, desc: 'æ€é“é€šå¤©ï¼Œäº§å‡º x2.0ï¼Œä¸Šé™è§£é”è‡³ 50ä¸‡', reqWins: 200, capUnlock: 500000 },
{ id: 'shura', name: 'æ— æˆ‘é­”åˆ€', baseCost: 500000, mult: 3.0, desc: 'æ— æˆ‘æ— æ•Œï¼Œäº§å‡º x3.0ï¼Œä¸Šé™è§£é”è‡³ 80ä¸‡', reqWins: 300, capUnlock: 800000 },
{ id: 'bao', name: 'å¤§åƒä¸–ç•Œåˆ€', baseCost: 800000, mult: 5.0, desc: 'åˆ€æ–©å¤§åƒï¼Œäº§å‡º x5.0ï¼Œä¸Šé™è§£é”è‡³ 95ä¸‡', reqWins: 1000, capUnlock: 950000 },
{ id: 'dao', name: 'ä¿®ç½—é“', baseCost: 950000, mult: 8.0, desc: 'ç»æƒ…ä¿®ç½—ï¼Œäº§å‡º x8.0ï¼Œä¸Šé™è§£é”è‡³ 99ä¸‡', reqWins: 3000, capUnlock: 990000 },
{ id: 'wo', name: 'æµ·è™çˆ†ç ´æ‹³', baseCost: 990000, mult: 15.0, desc: 'ç»ˆææ‹³æ³•ï¼Œäº§å‡º x15.0ã€‚å½»åº•è§£å¼€é™åˆ¶ï¼Œå…è®¸è¾¾åˆ° 100ä¸‡ï¼', reqWins: 10000, capUnlock: 1000000, unlocksFinalCap: true },
{ id: 'final_break', name: 'è‡ªæ¯å¢ƒç•Œï¼ï¼ï¼', baseCost: 999999, mult: 0, desc: 'ç»ˆæçªç ´ï¼å¼€å¯æœ€ç»ˆç»“å±€ã€‚', isFinal: true, reqWins: 20000 }
],
achievements: [
{ id: 'volt_1k', name: 'åˆå‡ºèŒ…åº', desc: 'ç´¯è®¡è·å¾— 1,000 ä¼ç‰¹', condition: (s) => s.totalVolt >= 1000, rewardMult: 1.1 },
{ id: 'volt_500k', name: 'ç”µæµå¤§å¸ˆ', desc: 'æ‹¥æœ‰ 500,000 ä¼ç‰¹', condition: (s) => s.volt >= 500000, rewardMult: 1.2 },
{ id: 'tier2_enter', name: 'ç£åœºè½¬åŠ¨', desc: 'è¿›å…¥ç£åœºè½¬åŠ¨', condition: (s) => s.tier >= 2, rewardMult: 1.5 },
{ id: 'hp_100k', name: 'åä¸‡åŒ¹åŠ›é‡', desc: 'æ‹¥æœ‰ 100,000 åŒ¹ç£åœºåŠ›é‡', condition: (s) => s.totalHP >= 100000, rewardMult: 1.3 },
{ id: 'tier3_enter', name: 'åœ°ç‹±ä¹‹é—¨', desc: 'è¿›å…¥ç£åœºåŠŸæ³•', condition: (s) => s.tier >= 3, rewardMult: 2.0 },
{ id: 'win_battle_10', name: 'ç™¾æˆ˜ç™¾èƒœ', desc: 'å‡»è´¥ 10 ä½å¼ºè€…', condition: (s) => s.battleWins >= 10, rewardMult: 1.5 },
{ id: 'realm_10', name: 'å®Œå…¨å¢ƒç•ŒÂ·åˆ', desc: 'æ‹¥æœ‰ 10 çº§å®Œå…¨å¢ƒç•Œ', condition: (s) => s.realmCount >= 10, rewardMult: 1.5 },
{ id: 'game_clear', name: 'ä¸€ç™¾ä¸‡åŒ¹', desc: 'è¾¾åˆ°ä¸€ç™¾ä¸‡åŒ¹åŠ›é‡', condition: (s) => s.gameWon, rewardMult: 2.0 },
// æ›´å¤šæˆå°±
{ id: 'prestige_8', name: 'è‹¦ä¿®è€å…µ', desc: 'æ•£åŠŸé‡ä¿®è¾¾åˆ°8æ¬¡', condition: (s) => s.prestigeCount >= 8, rewardMult: 1.3 },
{ id: 'prestige_16', name: 'æ¶…æ§ƒé‡ç”Ÿ', desc: 'æ•£åŠŸé‡ä¿®è¾¾åˆ°12æ¬¡', condition: (s) => s.prestigeCount >= 12, rewardMult: 1.5 },
{ id: 't2_prestige_5', name: 'ç£åœºè‹¦è¡Œè€…', desc: 'è¿›å…¥é‡ç”Ÿæ± è‹¦ä¿®è¾¾åˆ°5æ¬¡', condition: (s) => s.t2PrestigeCount >= 5, rewardMult: 1.5 },
{ id: 'win_battle_100', name: 'ç™¾æˆ˜å¼ºè€…', desc: 'å‡»è´¥ 100 ä½å¼ºè€…', condition: (s) => s.battleWins >= 100, rewardMult: 1.5 },
{ id: 'win_battle_1000', name: 'åƒæˆ˜æ— æ•Œ', desc: 'å‡»è´¥ 1000 ä½å¼ºè€…', condition: (s) => s.battleWins >= 1000, rewardMult: 2.0 },
{ id: 'win_battle_10000', name: 'ä¸‡å†›ç»Ÿå¸…', desc: 'å‡»è´¥ 10000 ä½å¼ºè€…', condition: (s) => s.battleWins >= 10000, rewardMult: 2.0 },
{ id: 'realm_100', name: 'å®Œå…¨å¢ƒç•ŒÂ·è¿›', desc: 'æ‹¥æœ‰ 100 çº§å®Œå…¨å¢ƒç•Œ', condition: (s) => s.realmCount >= 100, rewardMult: 1.5 },
{ id: 'realm_10000', name: 'å®Œå…¨å¢ƒç•ŒÂ·æ', desc: 'æ‹¥æœ‰ 10000 çº§å®Œå…¨å¢ƒç•Œ', condition: (s) => s.realmCount >= 10000, rewardMult: 2.0 },
{ id: 'reincarnation_1', name: 'å…ƒç¥è½¬ä¸–', desc: 'å®Œæˆç¬¬ä¸€æ¬¡å…ƒç¥è½¬ä¸–', condition: (s) => (s.realmUpgrades['r_reincarnation'] || 0) >= 1, rewardMult: 2.0 },
{ id: 'reincarnation_3', name: 'ä¸‰ä¸–æµè½¬', desc: 'å®Œæˆ3æ¬¡å…ƒç¥è½¬ä¸–', condition: (s) => (s.realmUpgrades['r_reincarnation'] || 0) >= 3, rewardMult: 2.5 },
{ id: 'tier4_enter', name: 'ç»ˆæå¼ºè€…ä¹‹å¢ƒ', desc: 'è¿›å…¥ç»ˆæå¼ºè€…ä¹‹å¢ƒ', condition: (s) => s.tier4Unlocked, rewardMult: 3.0 },
{ id: 'ult_reset_1', name: 'ç»ˆæè§‰é†’', desc: 'å®Œæˆç¬¬ä¸€æ¬¡ç»ˆæé‡ç½®', condition: (s) => s.ultimatePoints > 0, rewardMult: 2.0 },
{ id: 'ult_upg_5', name: 'ç»ˆææ„Ÿæ‚ŸI', desc: 'è´­ä¹°5ä¸ªç»ˆæå‡çº§', condition: (s) => Object.values(s.ultimateUpgrades||{}).filter(v=>v).length >= 5, rewardMult: 1.5 },
{ id: 'ult_upg_20', name: 'ç»ˆææ„Ÿæ‚ŸII', desc: 'è´­ä¹°20ä¸ªç»ˆæå‡çº§', condition: (s) => Object.values(s.ultimateUpgrades||{}).filter(v=>v).length >= 20, rewardMult: 2.0 },
{ id: 'ult_upg_50', name: 'ç»ˆææ„Ÿæ‚ŸIII', desc: 'è´­ä¹°50ä¸ªç»ˆæå‡çº§', condition: (s) => Object.values(s.ultimateUpgrades||{}).filter(v=>v).length >= 50, rewardMult: 2.5 },
{ id: 'ult_upg_100', name: 'ç»ˆææ„Ÿæ‚ŸIV', desc: 'è´­ä¹°100ä¸ªç»ˆæå‡çº§', condition: (s) => Object.values(s.ultimateUpgrades||{}).filter(v=>v).length >= 100, rewardMult: 3.0 },
{ id: 'challenge_1_done', name: 'åˆæˆ˜å‘Šæ·', desc: 'å®Œæˆç¬¬ä¸€ä¸ªç»ˆæå¼ºè€…æŒ‘æˆ˜', condition: (s) => (s.completedChallenges||[]).length >= 1, rewardMult: 2.0 },
{ id: 'challenge_5_done', name: 'äº”è·¯çš†é€š', desc: 'å®Œæˆ5ä¸ªç»ˆæå¼ºè€…æŒ‘æˆ˜', condition: (s) => (s.completedChallenges||[]).length >= 5, rewardMult: 3.0 },
{ id: 'body_1', name: 'ç£åœºè‚‰èº«Â·åˆ', desc: 'è·å¾—ç¬¬ä¸€ä¸ªç£åœºè‚‰ä½“', condition: (s) => (s.bodyParts||[]).length >= 1, rewardMult: 2.0 },
{ id: 'body_5', name: 'ç£åœºè‚‰èº«Â·æ»¡', desc: 'è·å¾—å…¨éƒ¨5ä¸ªç£åœºè‚‰ä½“', condition: (s) => (s.bodyParts||[]).length >= 5, rewardMult: 5.0 }
],
flowUpgrades: [
 { id: 'fl_amount1',  name: 'æµé‡æ„ŸçŸ¥I',    desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+4ã€‚',   baseCost: 50,    costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_speed1',  name: 'å……èƒ½ä¼˜åŒ–I',    desc: 'å……èƒ½æ—¶é—´å‡å°‘10%ï¼ˆæœ€å¤šè´­ä¹°2æ¬¡ï¼‰', baseCost: 50, costMult: 3, maxLevel: 2, type: 'speed', value: 0.1 },
 { id: 'fl_amount2',  name: 'æµé‡æ„ŸçŸ¥II',   desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+10ã€‚',  baseCost: 300,   costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_speed2',  name: 'å……èƒ½ä¼˜åŒ–II',   desc: 'å……èƒ½æ—¶é—´å‡å°‘15%ï¼ˆæœ€å¤šè´­ä¹°2æ¬¡ï¼‰', baseCost: 2500, costMult: 3, maxLevel: 2, type: 'speed', value: 0.15 },
 { id: 'fl_amount3',  name: 'æµé‡æ„ŸçŸ¥III',  desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+40ã€‚',  baseCost: 1500,  costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_amount4',  name: 'æµé‡æ„ŸçŸ¥IV',   desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+200ã€‚', baseCost: 7000,  costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_speed3',  name: 'è¶…å¯¼å……èƒ½I',    desc: 'å……èƒ½æ—¶é—´å‡å°‘20%ï¼ˆæœ€å¤šè´­ä¹°2æ¬¡ï¼‰', baseCost: 25000, costMult: 4, maxLevel: 2, type: 'speed', value: 0.2 },
 { id: 'fl_amount5',  name: 'æµé‡æ´ªæµI',    desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+1000ã€‚', baseCost: 30000, costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_amount6',  name: 'æµé‡æ´ªæµII',   desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+1000ã€‚', baseCost: 120000, costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_amount7',  name: 'æµé‡æ´ªæµIII',  desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+2000ã€‚', baseCost: 450000, costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_speed4',  name: 'è¶…å¯¼å……èƒ½II',   desc: 'å……èƒ½æ—¶é—´å‡å°‘25%ï¼ˆæœ€å¤šè´­ä¹°2æ¬¡ï¼‰', baseCost: 800000, costMult: 4, maxLevel: 2, type: 'speed', value: 0.25 },
 { id: 'fl_amount8',  name: 'æµé‡æ´ªæµIV',   desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+4000ã€‚', baseCost: 1500000, costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_amount9',  name: 'æ•°æ®é£æš´I',    desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+2ä¸‡ã€‚',  baseCost: 4000000, costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_amount10', name: 'æ•°æ®é£æš´II',   desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+4ä¸‡ã€‚',  baseCost: 8000000, costMult: 2.5, maxLevel: 3, type: 'amount' },
 { id: 'fl_amount11', name: 'æ•°æ®é£æš´III',  desc: 'æ¯æ¬¡å……æ»¡æµé‡è·å–+10ä¸‡ã€‚', baseCost: 1.2e7,  costMult: 2,   maxLevel: 3, type: 'amount' },
 { id: 'fl_auto', name: 'âš™ï¸ è‡ªåŠ¨å……èƒ½', desc: 'å……èƒ½æ¡å®Œæˆåè‡ªåŠ¨é‡æ–°å¼€å§‹å……èƒ½ï¼ˆæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ï¼‰ã€‚éœ€è¦æ‹¥æœ‰1ä¸‡æµé‡è§£é”ã€‚', baseCost: 10000, costMult: 1, maxLevel: 1, type: 'auto' },
],
realmUpgrades: [
    { id: 'r_atk', name: 'æ”»å‡»å¼ºåŒ–', desc: 'æå‡æŒ‘æˆ˜æ”»å‡»åŠ› (x1.2/çº§)', baseCost: 1, costMult: 1.3, maxLevel: 20, effect: (lvl) => Math.pow(1.2, lvl), type: 'atk' }, // åŸ1.5 -> 1.3
    { id: 'r_def', name: 'é˜²å¾¡å¼ºåŒ–', desc: 'æå‡æŒ‘æˆ˜é˜²å¾¡åŠ› (x1.2/çº§)', baseCost: 1, costMult: 1.3, maxLevel: 20, effect: (lvl) => Math.pow(1.2, lvl), type: 'def' }, // åŸ1.5 -> 1.3
    { id: 'r_res_t1', name: 'ç”µæµæ„Ÿæ‚Ÿ', desc: 'ä¼ç‰¹è·å–å€ç‡ (x1.1/çº§)', baseCost: 5, costMult: 1.5, maxLevel: 10, effect: (lvl) => Math.pow(1.1, lvl), type: 'res_t1', reqTier: 1 }, // åŸ2.0 -> 1.5
    { id: 'r_res_t2', name: 'ç£åœºæ„Ÿæ‚Ÿ', desc: 'åŒ¹æ•°è·å–å€ç‡ (x1.1/çº§)', baseCost: 10, costMult: 1.6, maxLevel: 10, effect: (lvl) => Math.pow(1.1, lvl), type: 'res_t2', reqTier: 2 }, // åŸ2.5 -> 1.6
    { id: 'r_res_t3', name: 'æ€é“æ„Ÿæ‚Ÿ', desc: 'åœ°ç‹±å±‚äº§å‡ºå€ç‡ (x1.2/çº§)', baseCost: 20, costMult: 1.8, maxLevel: 10, effect: (lvl) => Math.pow(1.2, lvl), type: 'res_t3', reqTier: 3 }, // åŸ3.0 -> 1.8
    { id: 'r_regen', name: 'ç”Ÿå‘½å¤è‹', desc: 'è„±æˆ˜å›è¡€é€Ÿåº¦ (x1.5/çº§)', baseCost: 5, costMult: 1.8, maxLevel: 10, effect: (lvl) => Math.pow(1.5, lvl), type: 'regen', reqTier: 2 }, // åŸ2.5 -> 1.8
    { id: 'r_auto_battle', name: 'è‡ªåŠ¨æŒ‘æˆ˜', desc: 'è§£é”åè‡ªåŠ¨è¿ç»­æŒ‘æˆ˜å¼ºè€…', baseCost: 500, costMult: 5.0, maxLevel: 1, effect: (lvl) => lvl > 0, type: 'auto', reqTier: 2 },
    // å…ƒç¥è½¬ä¸–
    { id: 'r_reincarnation', name: 'å…ƒç¥è½¬ä¸–', desc: 'é‡ç½®æ¸¸æˆï¼Œä¿ç•™éƒ¨åˆ†å‡çº§ï¼Œæ°¸ä¹…ç¿»å€å¼ºè€…æŒ‘æˆ˜å±æ€§å€ç‡ã€‚å‡»è´¥50äººè§£é”ï¼Œç¬¬2æ¬¡è´­ä¹°åï¼Œæ¯æ¬¡å‡»è´¥æ•Œäººè·å¾—éƒ¨åˆ†åŒ¹æ•°å¥–åŠ±ã€‚', baseCost: 0, costMult: 1, maxLevel: 4, effect: (lvl) => Math.pow(2, lvl), type: 'reincarnation', reqTier: 2, reqWins: 50, reincarnationCosts: [0, 0, 0, 0, 0, 0, 0, 0] , reincarnationWinReqs: [50, 150, 350, 750, 1550, 3150, 6350, 12750] }
],
};

// ===== ç»ˆæå‡çº§è´¹ç”¨å¹³æ»‘é‡è®¡ç®— =====
// è´¹ç”¨èŒƒå›´ï¼šç¬¬0è¡Œâ‰ˆ1ç‚¹ï¼Œç¬¬17è¡Œâ‰ˆ1e60ç‚¹
// å¯¹åº”æ–°çš„åŠ›é‡â†’ç‚¹æ•°æ¢ç®—ï¼šç©å®¶èƒ½åœ¨åˆç†æ—¶é—´å†…è´­ä¹°æ‰€æœ‰å‡çº§
(function recalcUltCosts() {
  const maxRow = Math.max(...CONFIG.ultimateUpgrades.map(u => u.row));
  // log10(1e60) = 60ï¼Œè®©æœ«æ’å‡çº§çº¦éœ€1e60ç‚¹
  const logMax = 60;
  CONFIG.ultimateUpgrades.forEach(u => {
    const frac = u.row / maxRow;
    // æŒ‡æ•°åˆ†å¸ƒï¼šä½è¡Œä¾¿å®œï¼Œé«˜è¡Œè´µ
    const logCost = Math.pow(frac, 1.2) * logMax; // 1.2æ¬¡æ–¹è®©ä¸­æœŸæ›´å¹³ç¼“
    const val = Math.pow(10, logCost);
    u.cost = Math.max(1, isFinite(val) ? val : 1e60);
  });
  // åŒè¡Œå†…æŒ‰æ•°ç»„é¡ºåºå¾®è°ƒï¼šæ¯ä¸ªåç»­å‡çº§Ã—1.5
  const rowGroups = {};
  CONFIG.ultimateUpgrades.forEach(u => {
    if (!rowGroups[u.row]) rowGroups[u.row] = [];
    rowGroups[u.row].push(u);
  });
  Object.values(rowGroups).forEach(group => {
    if (group.length <= 1) return;
    const baseLog = Math.log10(Math.max(1, group[0].cost));
    group.forEach((u, idx) => {
      const newLog = baseLog + idx * 0.18;
      const val = Math.pow(10, newLog);
      u.cost = isFinite(val) ? Math.max(1, val) : 1e60;
    });
  });
})();

const game = {
state: {},
battleTimer: null,
autoBattleEnabled: false,
cinematicLines: [
"ä½ â€¦â€¦ç»ˆäºæ¥äº†ã€‚",
"å³ä¾¿æ˜¯å½“å¹´é‚£ä¸ªä¸æ˜¯æˆ‘çš„æˆ‘ï¼Œä»»ç”±å¤§èƒ½å°†å…¶æŒæ§ã€‚",
"åœ¨æœ€åçš„æœ€åï¼Œè¿«æˆ‘åšå‡ºäº†è‡ªæ„¿æ”¾å¼ƒçš„é€‰æ‹©ï¼Œè®©ä¸–ç•Œå˜æˆäº†è¿™ä¸ªæ— è¶£æ¨¡æ ·ã€‚",
"ä½†å‘½è¿ç»ˆç©¶ä¼šè®©æˆ‘ä»¬å†æ¬¡èµ°åˆ°è¿™é‡Œ",
"ç°åœ¨ï¼Œå¼€å§‹ä½ æœ€åçš„è·¯ç¨‹å§ã€‚",
"æˆ‘â€¦â€¦ç™½æ­¦ç”·ï¼Œå‘µâ€¦â€¦æœŸå¾…ä¸ä½ çš„æœ€åä¸€æˆ˜ã€‚"
],
getInitialState() {
return {
tier: 1,
volt: 0, totalVolt: 0, prestigeCount: 0,
genCount: 0, genCost: 10, capLvl: 0, capCost: 50, transLvl: 0, transCost: 200, superLvl: 0, superCost: 1000,
t1BoostLvl: 0, t1BoostCost: 100000,
voltRetentionLevel: 0,
horsePower: 0, totalHP: 0, t2PrestigeCount: 0,
hpUpgLvl: 0, hpUpgCost: 100, voltUpgLvl: 0, voltUpgCost: 500, voltConvLvl: 0, voltConvCost: 50000,
autoHPLvl: 0, autoHPCost: 3000, clickHPLvl: 0, clickHPCost: 1500,
t2BoostLvl: 0, t2BoostCost: 10000,
skills: {}, realmCount: 0, battleWins: 0,
playerMaxHp: 100, playerCurHp: 100, enemyMaxHp: 100, enemyCurHp: 100, enemyAtk: 0, enemyDef: 0,
isBattling: false, isInjured: false, injuredUntil: 0, hpRegenActive: true,
realmUpgrades: {}, unlockedAchievements: [], gameWon: false, startTime: Date.now(),
reincarnationMult: 1,
// Tier 4 æ–°å¢
power: 0,
ultimatePoints: 0,
ultimateUpgrades: {},
completedChallenges: [],
activeChallenge: null, // challenge id currently active
challengeStartState: null, // saved state before challenge
challengeStartTime: null,
bodyParts: [], // owned body parts
bodyResetCount: 0,
magneticBodyUnlocked: false,
tier4Unlocked: false,
voltCapUnlocked: false, // è§£é”ç»ˆæå¼ºè€…åè·å¾—çš„ä¼ç‰¹ä¸Šé™æå‡å¥–åŠ±
// æµé‡ç³»ç»Ÿ
flow: 0, // å½“å‰æµé‡
flowMax: 1e8, // ä¸Šé™ä¸€äº¿
flowUpgLvl: 0, // æµé‡å‡çº§ç­‰çº§ï¼ˆæ€»è®¡ï¼‰
flowUpgrades: {}, // å„æµé‡å‡çº§ç­‰çº§
flowChargeProgress: 0, // å……èƒ½è¿›åº¦ 0~1
flowChargeActive: false, // æ˜¯å¦æ­£åœ¨å……èƒ½
flowUnlocked: false, // æ˜¯å¦å·²è§£é”æµé‡é¡µé¢
};
},
init() {
this.state = this.getInitialState();
this.loadGame();
ui.init();
this.checkAchievements();
this.renderRealmUpgrades();
this.renderSkills();
this.renderAchievements();
this.renderVoltRetention();
this.renderUltimateTree();
this.renderUltimateChallenges();
this.renderBodyParts();
setInterval(() => {
this.checkProgression();
ui.update();
ui.checkRedDots();
// ä»…åœ¨ç»ˆæç‚¹æ•°å˜åŒ–æ—¶é‡æ¸²æ ‘ï¼ˆé¿å…100msé‡æ¸²å¯¼è‡´onclickæ— æ³•è§¦å‘ï¼‰
if (this.state.tier4Unlocked) {
  const pts = this.state.ultimatePoints;
  if (pts !== this._lastUltPtsForTree) {
    this._lastUltPtsForTree = pts;
    this.renderUltimateTree();
  }
}
}, 100);
this.lastUpdateTime = Date.now(); // åˆå§‹åŒ–ï¼Œé˜²æ­¢é¦–æ¬¡dtä¸ºNaN
setInterval(() => {
// In tier4 outside challenge: only run power production and regen
const now = Date.now();
const dt = (now - this.lastUpdateTime) / 1000; // è®¡ç®—ç»è¿‡çš„ç§’æ•°
this.lastUpdateTime = now;
this.processAutoProduction(dt); 
this.processPowerProduction(dt);
this.checkProgression(); // æ£€æŸ¥è§£é”æ¡ä»¶
ui.update();             // ã€æ ¸å¿ƒã€‘å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢æ•°å€¼å’ŒæŒ‰é’®çŠ¶æ€
ui.checkRedDots();   
this.handlePassiveRegen();
this.checkAutoBattle();
this.checkChallengeTimeout();
this.processFlowCharge();
// æµé‡å……èƒ½é€»è¾‘ä¹Ÿåœ¨æ­¤è¿è¡Œï¼ˆä¿è¯åå°è¿è¡Œï¼‰
if (this.state.flowUnlocked && this.state.flowChargeActive) {
  this.tickFlowCharge(dt);
}
}, 100);
setInterval(() => this.saveGame(), 10000);
this.log("ç³»ç»Ÿå¯åŠ¨ã€‚v10æ›´æ–°ï¼šç»ˆæå¼ºè€…å±‚ã€åŠ›é‡èµ„æºã€ç£åœºè‚‰ä½“å·²è§£é”ã€‚");

// åå°è¿è¡Œæ”¯æŒï¼šé¡µé¢éšè—æ—¶è®°å½•æ—¶é—´ï¼Œæ¢å¤æ—¶è¡¥ç®—ç¦»çº¿è¿›åº¦
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    this._bgHideTime = Date.now();
  } else {
    if (this._bgHideTime) {
      const elapsed = (Date.now() - this._bgHideTime) / 1000; // ç§’
      // è¡¥ç®—åå°æ—¶é—´å†…çš„èµ„æºç”Ÿäº§ï¼ˆæœ€å¤šè¡¥ç®—1å°æ—¶ï¼Œé˜²æ­¢å¼‚å¸¸ï¼‰
      const cap = Math.min(elapsed, 3600);
      const steps = Math.ceil(cap / 0.1);
      const stepDt = cap / steps;
      for (let i = 0; i < steps; i++) {
        this.processAutoProduction(stepDt);
        this.processPowerProduction(stepDt);
        // æµé‡å……èƒ½
        if (this.state.flowUnlocked && this.state.flowChargeActive) {
          const totalTime = this.getFlowChargeTime();
          this.state.flowChargeProgress = Math.min(1, (this.state.flowChargeProgress || 0) + stepDt / totalTime);
          if (this.state.flowChargeProgress >= 1) {
            const upgs = this.state.flowUpgrades || {};
            let amount = 1;
            amount += (upgs['fl_amount1'] || 0) * 4;
            amount += (upgs['fl_amount2'] || 0) * 10;
            amount += (upgs['fl_amount3'] || 0) * 40;
            amount += (upgs['fl_amount4'] || 0) * 200;
            amount += (upgs['fl_amount5'] || 0) * 1000;
            amount += (upgs['fl_amount6'] || 0) * 1000;
            amount += (upgs['fl_amount7'] || 0) * 2000;
            amount += (upgs['fl_amount8'] || 0) * 4000;
            amount += (upgs['fl_amount9'] || 0) * 20000;
            amount += (upgs['fl_amount10'] || 0) * 40000;
            amount += (upgs['fl_amount11'] || 0) * 100000;
                                                            this.state.flow = Math.min(this.state.flowMax, this.state.flow + amount);
            this.state.flowChargeProgress = 0;
            const hasAuto = (this.state.flowUpgrades || {})['fl_auto'] >= 1;
            this.state.flowChargeActive = hasAuto && this.state.flow < this.state.flowMax;
          }
        }
      }
      this._bgHideTime = null;
      ui.update();
      ui.updateFlowBar();
    }
  }
});

// rAF loopï¼šä»…ç”¨äºæµé‡å……èƒ½æ¡çš„è§†è§‰åŠ¨ç”»ï¼ˆä¸æ˜¯æ ¸å¿ƒé€»è¾‘ï¼ŒrAFæš‚åœæ—¶ç”±setIntervalè¡¥å¿ï¼‰
let lastTime = performance.now();
const rafLoop = (now) => {
const dt = (now - lastTime) / 1000;
lastTime = now;
game.tickFlowCharge(dt);
ui.updateFlowBar();
requestAnimationFrame(rafLoop);
};
requestAnimationFrame(rafLoop);
},
hardReset() {
if (confirm("ã€è­¦å‘Šã€‘ç¡®å®šè¦åˆ æ¡£é‡å¼€å—ï¼Ÿè¿™ä¸€ä¸–çš„ä¿®è¡Œå°†å…¨éƒ¨ä½œåºŸï¼")) {
localStorage.removeItem('magneticIncrementSave_v4');
localStorage.removeItem('magneticIncrementSave_v3');
localStorage.removeItem('magneticT4Backup_v4');
location.reload();
}
},
processAutoProduction(dt) {
const now = Date.now();
const s = this.state;
// dt ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆå‘¼ã³å‡ºã—å…ƒãŒdtã‚’æ¸¡ã•ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
if (!dt || dt <= 0) dt = 0.1;
// tier1-3 production always runs (including during tier4)
{
const achMult = this.getAchievementMult();
const realmMult = this.getRealmResourceMult();
// challenge restrictions
const chalRestrict = this.getChallengeRestriction();
const t1ChalMult = chalRestrict.t1Mult !== undefined ? chalRestrict.t1Mult : 1;
const t2ChalMult = chalRestrict.t2Mult !== undefined ? chalRestrict.t2Mult : 1;
// body part multipliers
const bodyAutoMult = this.getBodyPartMult('autoMult');
const bodySpeedMult = this.getBodyPartMult('speedMult');
if (s.genCount > 0) {
const pMult = (s.activeChallenge && s.activeChallenge !== 'c1') ? 1 : Math.pow(2, s.prestigeCount);
const transEff = (chalRestrict.noUpgrades || chalRestrict.noT1Upgrades) ? 1 : 1 + (s.transLvl * 0.1);
const superEff = (chalRestrict.noUpgrades || chalRestrict.noT1Upgrades) ? 1 : 1 + (s.superLvl * 0.2);
const boostMult = (chalRestrict.noUpgrades || chalRestrict.noT1Upgrades || chalRestrict.noT1Boost) ? 1 : Math.pow(1.5, s.t1BoostLvl);
let productionPerSecond = s.genCount * 3 * transEff * pMult * superEff * achMult * realmMult * boostMult * t1ChalMult * bodyAutoMult * bodySpeedMult;
if (chalRestrict.c1AutoVoltX10) productionPerSecond *= 10; // c1æŒ‘æˆ˜ï¼šè‡ªåŠ¨ä¼ç‰¹Ã—10
if (productionPerSecond > 0) this.addVolt(productionPerSecond * dt);
}
// c1æŒ‘æˆ˜ï¼šè¢«åŠ¨æ¯ç§’+1ä¼ç‰¹
if (chalRestrict.c1PassiveVolt) this.addVolt(1 * dt);
if (s.tier >= 2) {
const t2Mult = s.activeChallenge ? 1 : Math.pow(2, s.t2PrestigeCount);
const realmBonus = this.getRealmResourceMult(true);
const boostMult = (chalRestrict.noUpgrades) ? 1 : Math.pow(1.5, s.t2BoostLvl);
let baseAuto = 1 + (Math.pow(s.voltUpgLvl, 2) * 1) + (s.autoHPLvl * 5); // æœ€ä½1/ç§’åŸºç¡€äº§å‡º
let rawVoltConversion = 0;
if (s.voltConvLvl > 0) {
rawVoltConversion = (Math.log10(Math.max(1, s.volt)) * 10) * s.voltConvLvl;
}
let voltEfficiency = 1.0;
const currentHP = s.horsePower;
if (currentHP > 100000) {
if (currentHP < 500000) {
const progress = (currentHP - 100000) / 400000;
voltEfficiency = 1.0 - (progress * 0.9);
} else {
const stepsOver500k = Math.floor((currentHP - 500000) / 100000);
voltEfficiency = 0.1 * Math.pow(0.8, stepsOver500k);
if (voltEfficiency < 0.01) voltEfficiency = 0.01;
}
}
let voltConversion = rawVoltConversion * voltEfficiency;
let softCapMultiplier = 1.0;
if (currentHP >= 100000) {
const progress = (currentHP - 100000) / 100000;
if (progress > 0) {
softCapMultiplier = Math.pow(1 - Math.min(0.99, progress), 2);
if (softCapMultiplier < 0.0001) softCapMultiplier = 0.0001;
}
}
let totalBase = baseAuto + voltConversion;
if (totalBase > 0) {
let finalProduction = totalBase * realmBonus * t2Mult * boostMult * softCapMultiplier * t2ChalMult * bodyAutoMult * bodySpeedMult;
this.addHP(finalProduction * dt);
}
}
} // end production-only block (tier4 outside challenge skips above)
if (s.isInjured) {
const now = Date.now();
if (now >= s.injuredUntil) {
s.isInjured = false;
s.playerCurHp = Math.ceil(s.playerMaxHp * 0.01);
this.log("ä½ ä»é‡ä¼¤ä¸­è‹é†’ï¼Œæ¢å¤äº†å¾®å¼±æ°”æ¯ã€‚", true);
if(this.autoBattleEnabled) {
             setTimeout(() => this.checkAutoBattle(), 100);
        }
    } else {
        // æ›´æ–°UIæ˜¾ç¤ºå‰©ä½™æ—¶é—´ï¼Œé¿å…ç”¨æˆ·ä»¥ä¸ºæ—¶é—´åœ¨å¢åŠ 
        const remaining = Math.ceil((s.injuredUntil - now) / 1000);
        const hpStatusText = document.getElementById('hp-status-text');
        if(hpStatusText) {
            hpStatusText.innerText = `é‡ä¼¤æ¢å¤ä¸­... (${remaining}s)`;
            hpStatusText.style.color = '#ff6600';
        }
    }
    return; // é‡ä¼¤æœŸé—´ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œå›è¡€
}
if (!s.isBattling && s.playerCurHp > 0) {
const stats = this.getBattleStats();
const newMaxHp = stats.pMaxHp;
if (newMaxHp > s.playerMaxHp) {
// Max HP increased (e.g. after gaining more horsePower), heal the difference
const diff = newMaxHp - s.playerMaxHp;
s.playerCurHp = Math.min(newMaxHp, s.playerCurHp + diff);
s.playerMaxHp = newMaxHp;
}
if (s.playerCurHp < s.playerMaxHp) {
const regenLvl = s.realmUpgrades['r_regen'] || 0;
const regenMult = Math.pow(1.5, regenLvl);
const baseRegen = Math.ceil(s.playerMaxHp * 0.1);
const regen = Math.floor(baseRegen * regenMult);
s.playerCurHp = Math.min(s.playerMaxHp, s.playerCurHp + regen);
document.getElementById('hp-status-text').innerText = `éæˆ˜æ–—å›è¡€ä¸­ (+${ui.formatNum(regen)}/s)`;
document.getElementById('hp-status-text').style.color = '#00ccff';
} // end if playerCurHp < playerMaxHp
} else if (!s.isBattling && s.playerCurHp >= s.playerMaxHp) {
document.getElementById('hp-status-text').innerText = "ç”Ÿå‘½å€¼å·²æ»¡";
document.getElementById('hp-status-text').style.color = '#888';
}
},
checkAutoBattle() {
const s = this.state;
if (s.tier < 2) return;
const hasAutoUpgrade = parseInt(s.realmUpgrades['r_auto_battle'] || '0') === 1;
const now = Date.now();
    const isStillInjured = s.isInjured && (now < s.injuredUntil);

    if (!hasAutoUpgrade || !this.autoBattleEnabled || s.isBattling || isStillInjured || s.playerCurHp <= 0) return;

    if (hasAutoUpgrade && this.autoBattleEnabled && !s.isBattling && !isStillInjured && s.playerCurHp > 0) {
        this.startChallenge(true);
    }
},
addVolt(amount) {
const oldVolt = this.state.volt;
const maxVolt = CONFIG.voltHardCap;
if (this.state.volt >= maxVolt) return;
// c1æŒ‘æˆ˜ï¼šä¼ç‰¹è½¯ä¸Šé™â€”â€”éœ€è¦1024å€ï¼ˆprestigeCount=10ï¼‰æ‰èƒ½å‹‰å¼ºæ¨è¿›åˆ°50ä¸‡
const chalRestrict = this.getChallengeRestriction();
if (chalRestrict.c1PassiveVolt) {
  // è½¯ä¸Šé™ï¼šeffectiveCap = 500000 * (prestigeMult / 1024)^1.0ï¼Œæœ€é«˜ä¸è¶…è¿‡voltHardCap
  const prestigeMult = Math.pow(2, this.state.prestigeCount);
  const softCap = Math.min(maxVolt, 500000 * (prestigeMult / 1024));
  if (softCap > 0 && this.state.volt >= softCap) {
    // è¶…è¿‡è½¯ä¸Šé™åï¼Œæ”¶ç›ŠæŒ‰ (softCap/volt)^4 æ€¥å‰§è¡°å‡
    const ratio = softCap / this.state.volt;
    amount = amount * Math.pow(ratio, 4);
  }
}
this.state.volt += amount;
if (this.state.volt > maxVolt) this.state.volt = maxVolt;
this.state.totalVolt += amount;
if (Math.floor(this.state.totalVolt) > Math.floor(oldVolt)) this.checkAchievements();
},
addHP(amount) {
if (this.state.tier < 2) return;
const currentCap = this.getCurrentHPCap();
const oldHP = this.state.horsePower;
if (this.state.horsePower >= currentCap) {
const tinyGrowth = amount * 0.0000001;
this.state.horsePower += tinyGrowth;
this.state.totalHP += tinyGrowth;
return;
}
this.state.horsePower += amount;
if (this.state.horsePower > currentCap) {
this.state.horsePower = currentCap;
}
this.state.totalHP += amount;
if (Math.floor(this.state.totalHP) > Math.floor(oldHP)) this.checkAchievements();
},
getCurrentHPCap() {
const s = this.state;
if (s.tier < 3) return CONFIG.hardCap;
let cap = CONFIG.hardCap;
if (s.skills['hell']) cap = Math.max(cap, 200000);
if (s.skills['tianwu']) cap = Math.max(cap, 500000);
if (s.skills['shura']) cap = Math.max(cap, 800000);
if (s.skills['bao']) cap = Math.max(cap, 950000);
if (s.skills['dao']) cap = Math.max(cap, 990000);
if (s.skills['wo']) cap = CONFIG.finalCap;
return cap;
},
clickAction() {
const chalRestrict = this.getChallengeRestriction();
if (chalRestrict.noClick) return; // c1æŒ‘æˆ˜ç¦æ­¢ç‚¹å‡»è·å–ä¼ç‰¹
const pMult = Math.pow(2, this.state.prestigeCount);
const superEff = 1 + (this.state.superLvl * 0.2);
const achMult = this.getAchievementMult();
const realmMult = this.getRealmResourceMult();
const boostMult = Math.pow(1.5, this.state.t1BoostLvl);
const base = 1 + this.state.capLvl;
const power = base * pMult * superEff * achMult * realmMult * boostMult;
this.addVolt(power);
ui.update();
},
clickActionHP() {
if (this.state.tier < 2) return;
const chalRestrict = this.getChallengeRestriction();
if (chalRestrict.noClick) return; // c1æŒ‘æˆ˜ç¦æ­¢ç‚¹å‡»è·å–åŒ¹æ•°
let base = 1 + (this.state.hpUpgLvl * 1) + (this.state.voltUpgLvl * 1) + (this.state.clickHPLvl * 2);
const achMult = this.getAchievementMult();
const t2Mult = Math.pow(2, this.state.t2PrestigeCount);
const realmMult = this.getRealmResourceMult(true);
const boostMult = Math.pow(1.5, this.state.t2BoostLvl);
const powerRaw = base * achMult * realmMult * t2Mult * boostMult;
const currentHP = this.state.horsePower;
const cap = this.getCurrentHPCap();
let softCapFactor = 1.0;
if (currentHP >= 100000) {
const ratio = (currentHP - 100000) / (cap - 100000);
if (ratio > 0) {
softCapFactor = Math.pow(1 - Math.min(0.99, ratio), 3);
if (softCapFactor < 0.0001) softCapFactor = 0.0001;
}
}
const finalPower = powerRaw * softCapFactor;
this.addHP(finalPower);
ui.update();
},
buyGen() {
if (this.state.volt >= this.state.genCost) {
this.state.volt -= this.state.genCost;
this.state.genCount++;
this.state.genCost = Math.floor(this.state.genCost * 1.5);
ui.update();
}
},
buyCap() {
if (this.getChallengeRestriction().noClick) return; // c1æŒ‘æˆ˜ï¼šç‚¹å‡»å‡çº§ç¦ç”¨
if (this.state.volt >= this.state.capCost) {
this.state.volt -= this.state.capCost;
this.state.capLvl++;
this.state.capCost = Math.floor(this.state.capCost * 1.6);
ui.update();
}
},
buyTrans() {
if (this.state.volt >= this.state.transCost) {
this.state.volt -= this.state.transCost;
this.state.transLvl++;
this.state.transCost = Math.floor(this.state.transCost * 1.7);
ui.update();
}
},
buySuper() {
if (this.state.volt >= this.state.superCost) {
this.state.volt -= this.state.superCost;
this.state.superLvl++;
this.state.superCost = Math.floor(this.state.superCost * 2.0);
ui.update();
}
},
buyT1Boost() {
const chalRestrict = this.getChallengeRestriction();
if (chalRestrict.noT1Boost) { this.log("æŒ‘æˆ˜ä¸­ï¼šæœ¬æºåŠ é€Ÿå·²ç¦ç”¨ï¼", true); return; }
if (this.state.volt >= this.state.t1BoostCost && this.state.t1BoostLvl < 3) {
this.state.volt -= this.state.t1BoostCost;
this.state.t1BoostLvl++;
this.state.t1BoostCost = Math.floor(this.state.t1BoostCost * 5.0);
this.state.autoBuyVoltUpgrades = true; 
this.log("ä¼ç‰¹æœ¬æºå·²æ³¨å…¥ï¼è‡ªåŠ¨è´­ä¹°ä¼ç‰¹å‡çº§å·²æ¿€æ´»ã€‚", true);
this.log("æœ¬æºåŠ é€Ÿ (ç”µæµ) å‡çº§æˆåŠŸï¼", true);
ui.update();
this.renderT1Boost();
} else {
alert("ä¼ç‰¹ä¸è¶³ï¼");
}
},
buyT2Boost() {
if (this.state.horsePower >= this.state.t2BoostCost && this.state.t2BoostLvl < 3) {
this.state.horsePower -= this.state.t2BoostCost;
this.state.t2BoostLvl++;
this.state.t2BoostCost = Math.floor(this.state.t2BoostCost * 8.0);
this.log("æœ¬æºåŠ é€Ÿ (ç£åœº) å‡çº§æˆåŠŸï¼", true);
ui.update();
}
},
buyVoltRetention() {
const s = this.state;
if (s.voltRetentionLevel >= 5) return;
const reqPrestige = 6 + s.voltRetentionLevel;
if (s.prestigeCount < reqPrestige) return;
const mult = Math.pow(2, s.prestigeCount);
const cost = Math.floor((mult / 8) * 10000);
if (s.volt >= cost) {
if(!confirm(`èŠ±è´¹ ${ui.formatNum(cost)} ä¼ç‰¹æå‡ä¼ç‰¹æœ¬æºä¿ç•™ç­‰çº§ï¼Ÿ`)) return;
s.volt -= cost;
s.voltRetentionLevel++;
this.log(`ä¼ç‰¹æœ¬æºä¿ç•™æå‡è‡³ Lv.${s.voltRetentionLevel}`, true);
this.renderVoltRetention();
ui.update();
}
},
doPrestige() {
if (this.state.volt < this.getPrestigeCost()) return;
if (!confirm("ç¡®å®šæ•£åŠŸé‡ä¿®ï¼Ÿ")) return;
const s = this.state;
s.prestigeCount++;
const keepAll = s.voltRetentionLevel >= 5;
const keepCount = s.voltRetentionLevel;
s.volt = 0;
if (!keepAll) {
if (keepCount < 1) { s.genCount = 0; s.genCost = 10; }
if (keepCount < 2) { s.capLvl = 0; s.capCost = 50; }
if (keepCount < 3) { s.transLvl = 0; s.transCost = 200; }
if (keepCount < 4) { s.superLvl = 0; s.superCost = 1000; }
if (keepCount < 5) { s.t1BoostLvl = 0; s.t1BoostCost = 100000; }
}
this.log(`æ•£åŠŸé‡ä¿®æˆåŠŸï¼ä¼ç‰¹å€æ•°ï¼šx${Math.pow(2, s.prestigeCount)}`, true);
if (s.voltRetentionLevel >= 5) {
this.log("ä¼ç‰¹æœ¬æºä¿ç•™ç”Ÿæ•ˆï¼šæ­£åœ¨è‡ªåŠ¨è´­ä¹°æ‰€æœ‰å‡çº§...", true);
const buyMax = (costVar, countVar, costMult) => {
while (s.volt >= s[costVar]) {
s.volt -= s[costVar];
s[countVar]++;
s[costVar] = Math.floor(s[costVar] * costMult);
}
};
buyMax('genCost', 'genCount', 1.5);
buyMax('capCost', 'capLvl', 1.6);
buyMax('transCost', 'transLvl', 1.7);
buyMax('superCost', 'superLvl', 2.0);
while (s.t1BoostLvl < 3 && s.volt >= s.t1BoostCost) {
s.volt -= s.t1BoostCost;
s.t1BoostLvl++;
s.t1BoostCost = Math.floor(s.t1BoostCost * 5.0);
}
this.log("è‡ªåŠ¨è´­ä¹°å®Œæˆï¼", true);
}
this.checkAchievements();
this.renderVoltRetention();
ui.update();
},
getPrestigeCost() {
const count = this.state.prestigeCount;
const base = CONFIG.prestigeReq;
if (count < 8) return Math.floor(base * Math.pow(2, count));
else {
const thresholdMult = Math.pow(2, 8);
const progress = count - 7;
return Math.floor(base * thresholdMult * Math.pow(progress, 3));
}
},
doT2Prestige() {
if (this.state.tier < 2) return;
// ä¿®æ”¹ï¼šæé«˜å¢é•¿ç³»æ•°ï¼Œä»1.5æ”¹ä¸º2.0ï¼Œä½¿åç»­æ›´éš¾
const req = Math.floor(CONFIG.t2PrestigeReq * Math.pow(2.0, this.state.t2PrestigeCount));
if (this.state.horsePower < req) return;
if (!confirm("ç¡®å®šè¿›å…¥é‡ç”Ÿæ± è‹¦ä¿®ï¼Ÿ")) return;
this.state.t2PrestigeCount++;
this.state.horsePower = 0;
this.state.hpUpgLvl = 0; this.state.hpUpgCost = 100;
this.state.voltUpgLvl = 0; this.state.voltUpgCost = 500;
this.state.voltConvLvl = 0; this.state.voltConvCost = 50000;
this.state.autoHPLvl = 0; this.state.autoHPCost = 3000;
this.state.clickHPLvl = 0; this.state.clickHPCost = 1500;
this.state.t2BoostLvl = 0; this.state.t2BoostCost = 10000;
this.log(`è‹¦ä¿®ç»“æŸï¼ç£åœºå€æ•°ï¼šx${Math.pow(2, this.state.t2PrestigeCount).toFixed(2)}`, true);
ui.update();
},
buyHPUpg() {
if (this.state.tier < 2) return;
if (this.getChallengeRestriction().noClick) return; // c1æŒ‘æˆ˜ï¼šç‚¹å‡»å¨åŠ›å‡çº§ç¦ç”¨
if (this.state.horsePower >= this.state.hpUpgCost) {
this.state.horsePower -= this.state.hpUpgCost;
this.state.hpUpgLvl++;
this.state.hpUpgCost = Math.floor(this.state.hpUpgCost * 1.8);
ui.update();
}
},
buyVoltUpg() {
if (this.state.tier < 2) return;
if (this.state.horsePower >= this.state.voltUpgCost) {
this.state.horsePower -= this.state.voltUpgCost;
this.state.voltUpgLvl++;
this.state.voltUpgCost = Math.floor(this.state.voltUpgCost * 2.2);
ui.update();
}
},
buyVoltConv() {
if (this.state.tier < 2) return;
if (this.state.horsePower >= this.state.voltConvCost) {
this.state.horsePower -= this.state.voltConvCost;
this.state.voltConvLvl++;
this.state.voltConvCost = Math.floor(this.state.voltConvCost * 2.5);
ui.update();
if (this.state.voltConvLvl >= 2) {
document.getElementById('btn-buy-volt-conv').disabled = true;
this.log("å·²è¾¾è´­ä¹°ä¸Šé™ (2æ¬¡)ï¼", true);
}
}
},
buyAutoHP() {
if (this.state.tier < 2) return;
if (this.state.horsePower >= this.state.autoHPCost) {
this.state.horsePower -= this.state.autoHPCost;
this.state.autoHPLvl++;
this.state.autoHPCost = Math.floor(this.state.autoHPCost * 2.3);
ui.update();
}
},
buyClickHP() {
if (this.state.tier < 2) return;
if (this.getChallengeRestriction().noClick) return; // c1æŒ‘æˆ˜ï¼šç‚¹å‡»å‡çº§ç¦ç”¨
if (this.state.horsePower >= this.state.clickHPCost) {
this.state.horsePower -= this.state.clickHPCost;
this.state.clickHPLvl++;
this.state.clickHPCost = Math.floor(this.state.clickHPCost * 2.0);
ui.update();
}
},
buySkill(id) {
if (this.state.tier < 3) return;
const skill = CONFIG.skills.find(s => s.id === id);
const curLvl = this.state.skills[id] || 0;
if (curLvl >= 1) return;
if (this.state.battleWins < skill.reqWins) {
this.log(`å®åŠ›ä¸è¶³ï¼éœ€è¦å‡»è´¥ ${skill.reqWins} åå¼ºè€…æ‰èƒ½é¢†æ‚Ÿæ­¤åŠŸæ³•ã€‚`, true);
return;
}
const cost = skill.baseCost;
 if (skill.isFinal) {
        if (!confirm("âš ï¸ è­¦å‘Šï¼šè´­ä¹°ã€è‡ªæ¯å¢ƒç•Œï¼ï¼ï¼ã€‘å°†å½»åº•çªç ´æé™ï¼Œè§¦å‘æ¸¸æˆçš„æœ€ç»ˆé˜¶æ®µï¼ˆç»“å±€å‰§æƒ…ï¼‰ã€‚\n\nç¡®å®šè¦è´­ä¹°å—ï¼Ÿ")) {
            return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆï¼Œä¸æ‰§è¡Œè´­ä¹°
        }
    }
if (this.state.horsePower >= cost) {
this.state.horsePower -= cost;
this.state.skills[id] = 1;
if (skill.unlocksFinalCap) {
this.log(`é¢†æ‚Ÿ ${skill.name}! åŒ¹æ•°ä¸Šé™å½»åº•è§£å¼€ï¼Œçªç ´è‡³ä¸€ç™¾ä¸‡ï¼`, true);
} else if (skill.isFinal) {
this.log(`çªç ´æˆåŠŸï¼ä¸Šé™è§£é”ä¸ºä¸€ç™¾ä¸‡åŒ¹ï¼`, true);
} else {
this.log(`é¢†æ‚Ÿ ${skill.name}! ä¸Šé™è§£é”è‡³ ${ui.formatNum(skill.capUnlock)} åŒ¹ï¼`, true);
}
this.renderSkills();
this.checkProgression();
ui.update();
}
},
getBattleStats() {
const atkMult = this.getRealmAtkMult();
const defMult = this.getRealmDefMult();
const reincarnationMult = this.state.reincarnationMult || 1; // è·å–è½¬ä¸–å€ç‡

// ç©å®¶å±æ€§è®¡ç®—
const pAtk = (this.state.horsePower * 0.5 + 100) * atkMult * reincarnationMult;
const pDef = (this.state.horsePower * 0.2 + 50) * defMult * reincarnationMult;
const pMaxHpVal = pAtk * 1.5; 

const wave = this.state.battleWins + 1;
let batchCount = 1;
if (wave > 5000) {
batchCount = Math.floor(Math.pow(1.005, wave - 5000) * 50);
} else if (wave > 1000) {
batchCount = Math.floor(5 + (wave - 1000) * 0.05);
} else if (wave > 100) {
batchCount = Math.floor(1 + (wave - 100) * 0.01);
}
if (batchCount > 5000) batchCount = 5000;

// ä¿®æ”¹ï¼šæ•Œäººå±æ€§è®¡ç®—é€»è¾‘ä¼˜åŒ–
// 1. åŸºç¡€èµ„æºå› å­ï¼šéšç©å®¶æ€»èµ„æºå¢é•¿ï¼Œä½†å¢é•¿ææ…¢ (logarithmic)
const resourceFactor = 1 + Math.log10(Math.max(1, this.state.volt + this.state.horsePower)) * 0.05;

// 2. éš¾åº¦æ›²çº¿ï¼šå‰æœŸå¢é•¿å¿«ï¼ŒåæœŸå¢é•¿æ”¾ç¼“
let difficultyCurve = 1;
if (wave <= 10) {
difficultyCurve = 1 + (wave * 0.2);
} else {
difficultyCurve = 3 * Math.pow(1.08, wave - 10);
}
// é˜²æ­¢æŒ‡æ•°æº¢å‡ºä¸º Infinityï¼ˆå½“waveæå¤§æ—¶1.08^nä¼šæº¢å‡ºï¼‰
if (!isFinite(difficultyCurve) || difficultyCurve > 1e200) difficultyCurve = 1e200;

// 3. è®¡ç®—åŸå§‹æ•Œäººå±æ€§ï¼ˆé™åˆ¶ä¸è¶…è¿‡ 1e200ï¼Œé˜²æ­¢æ˜¾ç¤ºâˆï¼‰
let rawEAtk = Math.floor(Math.min(1e200, 1500 * resourceFactor * difficultyCurve * 0.12));
    
    // 5. æ•Œäººå±æ€§ä¸Šé™
    // å‡»è´¥ä¸€ä¸‡åæ•Œäººåè§£é™¤ç¡¬ä¸Šé™ï¼Œæ•Œäººå±æ€§ç»§ç»­è‡ªç„¶å¢é•¿ï¼ˆç©å®¶éœ€è´­ä¹°ç»ˆæå‡çº§æ‰èƒ½ç»§ç»­èƒœåˆ©ï¼‰
    const hardCapRemoved = (this.state.battleWins || 0) >= 10000;
    const capMultiplier = 1.5;
    const maxEAtk = pAtk * capMultiplier;
    let eAtk = rawEAtk;
    if (!hardCapRemoved && eAtk > maxEAtk) eAtk = maxEAtk;
    let eMaxHp = Math.floor(eAtk * 3.5);
    let eDef = Math.floor(1500 * resourceFactor * difficultyCurve * 0.04);
    const maxEDef = pDef * capMultiplier;
    if (!hardCapRemoved && eDef > maxEDef) eDef = maxEDef;
    if (!hardCapRemoved && wave > 100) {
        const stageAtkCap = Math.min(7000000, maxEAtk);
        if (eAtk > stageAtkCap) { eAtk = stageAtkCap; eMaxHp = Math.floor(eAtk * 3.5); }
        const stageDefCap = Math.min(2000000, maxEDef);
        if (eDef > stageDefCap) eDef = stageDefCap;
    }

 return { pAtk, pDef, pMaxHp: pMaxHpVal, eMaxHp, eAtk, eDef, wave, batchCount };
},
startChallenge(isAuto = false) {
if (this.state.tier < 2) return;
const now = Date.now();
if (this.state.isInjured) {
if(!isAuto) this.log("é‡ä¼¤æœªæ„ˆï¼Œæ— æ³•æŒ‘æˆ˜ï¼", true);
return;
}
if (this.state.playerCurHp <= 0) {
if(!isAuto) this.log("ç”Ÿå‘½å€¼è¿‡ä½ï¼Œè¯·ç­‰å¾…æ¢å¤...", true);
return;
}
if (this.state.isBattling) return;
const stats = this.getBattleStats();
this.state.isBattling = true;
this.state.enemyMaxHp = stats.eMaxHp;
this.state.enemyCurHp = stats.eMaxHp;
this.state.enemyAtk = stats.eAtk;
this.state.enemyDef = stats.eDef;
this.state.playerMaxHp = stats.pMaxHp;
if (this.state.playerCurHp > this.state.playerMaxHp) this.state.playerCurHp = this.state.playerCurHp;
ui.updateBattleUI(true);
if(!isAuto) this.log(`æŒ‘æˆ˜å¼€å§‹ï¼å¯¹é˜µç¬¬ ${stats.wave} ä½å¼ºè€…ã€‚`, true);
this.battleTimer = setInterval(() => {
this.battleRound();
}, 800);
},
battleRound() {
const s = this.state;
if (!s.isBattling) return;
const stats = this.getBattleStats();
const pDmg = Math.max(1, Math.floor(stats.pAtk - (s.enemyDef * 0.5)));
const eDmg = Math.max(1, Math.floor(s.enemyAtk - stats.pDef));
s.enemyCurHp -= pDmg;
if (s.enemyCurHp < 0) s.enemyCurHp = 0;
ui.updateBattleHP();
if (s.enemyCurHp <= 0) {
this.endBattle(true);
return;
}
setTimeout(() => {
if (!s.isBattling) return;
s.playerCurHp -= eDmg;
if (s.playerCurHp < 0) s.playerCurHp = 0;
ui.updateBattleHP();
if (s.playerCurHp <= 0) {
this.endBattle(false);
}
}, 400);
},
fleeBattle() {
if (!this.state.isBattling) return;
this.log("ä½ é€ƒèµ°äº†ï¼å£«æ°”å¤§å‡ï¼Œéœ€è¦é‡æ–°è°ƒæ•´çŠ¶æ€ã€‚", true);
this.endBattle(false, true);
},
endBattle(win, fled = false) {
clearInterval(this.battleTimer);
this.state.isBattling = false;
const now = Date.now();
if (win) {
const stats = this.getBattleStats();
const count = stats.batchCount || 1;
const baseReward = Math.max(1, Math.floor(stats.eMaxHp / 1000));
const totalReward = baseReward * count;
this.state.battleWins += count;
let logMsg = `æŒ‘æˆ˜èƒœåˆ©ï¼`;
const reincarnationLvl = this.state.realmUpgrades['r_reincarnation'] || 0;
if (reincarnationLvl >= 2) {
    const bonusHP = 100 * reincarnationLvl; 
    this.addHP(bonusHP);
    if (count > 1) {
        logMsg += ` <span style="color:#00ffaa">[è½¬ä¸–å¥–åŠ±] é¢å¤–è·å¾— ${ui.formatNum(bonusHP * count)} åŒ¹ï¼</span>`;
    } else {
        logMsg += ` <span style="color:#00ffaa">[è½¬ä¸–å¥–åŠ±] é¢å¤–è·å¾— ${ui.formatNum(bonusHP)} åŒ¹ï¼</span>`;
    }
}
this.state.realmCount = Math.min(CONFIG.realmCap, this.state.realmCount + totalReward);
if (count > 1) {
logMsg += `åŠ¿å¦‚ç ´ç«¹ï¼ä¸€æ¬¡æ€§å‡»è´¥äº† ${count} ä½å¼ºè€… (ç¬¬ ${stats.wave} - ${stats.wave + count - 1} æ³¢)ã€‚`;
} else {
logMsg += `å‡»è´¥äº†ç¬¬ ${stats.wave} ä½å¼ºè€…ã€‚`;
}
logMsg += ` è·å¾— ${totalReward} æˆ å®Œå…¨å¢ƒç•Œã€‚`;
if(!this.state.isInjured) this.log(logMsg, true);
if (this.autoBattleEnabled) {
if (!this.state.isInjured && this.state.playerCurHp > 0) {
setTimeout(() => {
if(this.autoBattleEnabled && !this.state.isBattling && !this.state.isInjured && this.state.playerCurHp > 0) {
this.startChallenge(true);
}
}, 100);
} else if (this.state.playerCurHp <= 0) {
this.log("è‡ªåŠ¨æŒ‘æˆ˜åœæ­¢ï¼šèƒœåˆ©ä½†ç”Ÿå‘½å€¼å½’é›¶ï¼Œé™·å…¥é‡ä¼¤ã€‚", true);
}
}
this.checkAchievements();
this.renderRealmUpgrades();
this.renderSkills();
} else {
if (!fled) {
this.log("ä½ è¢«æ‰“è´¥äº†ï¼é™·å…¥é‡ä¼¤ã€‚è‡ªåŠ¨æŒ‘æˆ˜å·²åœæ­¢ã€‚", true);
} else {
this.log("é€ƒèµ°å¤±è´¥ï¼Œé™·å…¥é‡ä¼¤ã€‚è‡ªåŠ¨æŒ‘æˆ˜å·²åœæ­¢ã€‚", true);
}
this.state.playerCurHp = 0;
this.state.isInjured = true;
let injuryDuration = 10000;

// æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰å¿ƒè„è‚‰ä½“ ä¸” è´­ä¹°äº† "è‚‰ä½“å†ç”Ÿ" (u_body_regen) å‡çº§
const hasHeart = this.state.bodyParts && this.state.bodyParts.includes('heart');
const hasRegenUpgrade = this.state.ultimateUpgrades && this.state.ultimateUpgrades['u_body_regen'];

if (hasHeart && hasRegenUpgrade) {
    // å‡å°‘ 80% æ—¶é—´ï¼Œå³åªä¿ç•™ 20%
    injuryDuration = injuryDuration * 0.2; 
    this.log("å¿ƒè„ä¿®å¤ï¼é‡ä¼¤æ¢å¤é€Ÿåº¦å¤§å¹…æå‡ï¼", true);
}
this.state.injuredUntil = now + injuryDuration;
}
ui.updateBattleUI(false);
},
buyRealmUpgrade(id) {
const upg = CONFIG.realmUpgrades.find(u => u.id === id);
const curLvl = this.state.realmUpgrades[id] || 0;
if (curLvl >= upg.maxLevel) return;

// ç‰¹æ®Šå¤„ç†ï¼šå…ƒç¥è½¬ä¸–
if (id === 'r_reincarnation') {
    if (this.state.battleWins < upg.reqWins) {
        this.log(`éœ€è¦å‡»è´¥ ${upg.reqWins} åå¼ºè€…æ‰èƒ½è¿›è¡Œå…ƒç¥è½¬ä¸–ï¼`, true);
        return;
    }
    const costs = upg.reincarnationCosts || [0];
    const reincCost = curLvl < costs.length ? costs[curLvl] : Math.floor(costs[costs.length-1] * Math.pow(5, curLvl - costs.length + 1));
    if (reincCost > 0 && this.state.realmCount < reincCost) {
        this.log(`å…ƒç¥è½¬ä¸–éœ€è¦ ${ui.formatNum(reincCost)} å®Œå…¨å¢ƒç•Œï¼å½“å‰ï¼š${ui.formatNum(this.state.realmCount)}`, true);
        return;
    }
    const costText = reincCost > 0 ? `\nè´¹ç”¨ï¼š${ui.formatNum(reincCost)} å®Œå…¨å¢ƒç•Œ` : "";
    if (!confirm("ç¡®å®šè¿›è¡Œå…ƒç¥è½¬ä¸–ï¼Ÿè¿™å°†é‡ç½®æ¸¸æˆæ‰€æœ‰å†…å®¹ï¼ˆé™¤æœ¬æºåŠ é€Ÿã€ç»ˆæå¼ºè€…ã€ç£åœºè‚‰ä½“åŠæµé‡è¿›åº¦å¤–ï¼‰ï¼Œä½†æ°¸ä¹…ç¿»å€æŒ‘æˆ˜å±æ€§å€ç‡ï¼" + costText)) return;
    if (reincCost > 0) this.state.realmCount -= reincCost;
    // å®‰å…¨é”åº•ï¼šå‡»è´¥1ä¸‡æ•Œäººåï¼Œå®Œå…¨å¢ƒç•Œæ°¸ä¸ä½äº1ä¸‡
    if ((this.state.battleWins || 0) >= 10000) {
      this.state.realmCount = Math.max(10000, this.state.realmCount);
    }
    
    // æ‰§è¡Œè½¬ä¸–é€»è¾‘
    this.state.reincarnationMult *= 2;
    this.state.realmUpgrades[id] = curLvl + 1;
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€ï¼Œä½†ä¿ç•™ t1BoostLvl, t2BoostLvl, t1BoostCost, t2BoostCost, reincarnationMult
    const keptData = {
        // ç»ˆæå¼ºè€…å±‚
        tier4Unlocked: this.state.tier4Unlocked,
        ultimatePoints: this.state.ultimatePoints,
        ultimateUpgrades: JSON.parse(JSON.stringify(this.state.ultimateUpgrades)),
        completedChallenges: JSON.parse(JSON.stringify(this.state.completedChallenges)),
        power: this.state.power,
        
        // ç£åœºè‚‰ä½“
        bodyParts: JSON.parse(JSON.stringify(this.state.bodyParts)),
        bodyResetCount: this.state.bodyResetCount,
        magneticBodyUnlocked: this.state.magneticBodyUnlocked,
        
        // æµé‡ç³»ç»Ÿ
        flow: this.state.flow,
        flowUpgrades: JSON.parse(JSON.stringify(this.state.flowUpgrades)),
        flowUnlocked: this.state.flowUnlocked,
        
        // æœ¬æºåŠ é€Ÿ (å…³é”®ï¼šå¿…é¡»ä¿ç•™)
        t1BoostLvl: this.state.t1BoostLvl,
        t1BoostCost: this.state.t1BoostCost,
        t2BoostLvl: this.state.t2BoostLvl,
        t2BoostCost: this.state.t2BoostCost,
        
        // è½¬ä¸–æœ¬èº«çš„çŠ¶æ€
        reincarnationMult: this.state.reincarnationMult,
        realmUpgrades: { 'r_reincarnation': this.state.realmUpgrades['r_reincarnation'] },
        unlockedAchievements: JSON.parse(JSON.stringify(this.state.unlockedAchievements)), // é€šå¸¸æˆå°±ä¹Ÿä¿ç•™
        // å®Œå…¨å¢ƒç•Œå’Œå‡»è´¥æ•°é‡æ°¸ä¹…ä¿ç•™
        realmCount: this.state.realmCount,
        battleWins: this.state.battleWins,
    };
    
    this.state = this.getInitialState();
    this.state = { ...this.state, ...keptData };
    
    this.log(`å…ƒç¥è½¬ä¸–æˆåŠŸï¼å½“å‰æŒ‘æˆ˜å±æ€§å€ç‡ï¼šx${this.state.reincarnationMult}`, true);
    this.renderRealmUpgrades();
    ui.update();
    ui.updateTabs()
    return;
}

const cost = Math.floor(upg.baseCost * Math.pow(upg.costMult, curLvl));
// å‡»è´¥1ä¸‡åæ•Œäººåï¼Œå®Œå…¨å¢ƒç•Œé”å®šä¸‹é™ä¸º1ä¸‡â€”â€”è´­ä¹°ä»ç„¶æœ‰æ•ˆï¼Œä½†æ‰£å‡åä¸ä½äº1ä¸‡
const realmFloor = (this.state.battleWins || 0) >= 10000 ? 10000 : 0;
if (this.state.realmCount >= cost || this.state.realmCount >= realmFloor) {
// æœ‰è¶³å¤Ÿçš„å¢ƒç•Œï¼Œæˆ–è€…è™½ç„¶ä¸å¤Ÿä½†ä¸‹é™ä¿æŠ¤å…è®¸è´­ä¹°ï¼ˆå¢ƒç•Œâ‰¥1ä¸‡æ—¶å…æ‰£ä¸‹é™ä»¥ä¸‹éƒ¨åˆ†ï¼‰
const canAfford = this.state.realmCount >= cost;
const protectedBuy = realmFloor > 0 && this.state.realmCount >= realmFloor;
if (!canAfford && !protectedBuy) {
this.log("å®Œå…¨å¢ƒç•Œä¸è¶³ï¼", true); return;
}
this.state.realmCount -= cost;
// é”åº•ï¼šä¸ä½äº1ä¸‡
if (realmFloor > 0) this.state.realmCount = Math.max(realmFloor, this.state.realmCount);
this.state.realmUpgrades[id] = curLvl + 1;
this.log(`å¢ƒç•Œæå‡ï¼š${upg.name} Lv.${curLvl+1}`, true);
this.renderRealmUpgrades();
ui.update();
} else {
this.log("å®Œå…¨å¢ƒç•Œä¸è¶³ï¼", true);
}
},
toggleAutoBattle() {
const hasAuto = parseInt(this.state.realmUpgrades['r_auto_battle'] || '0') === 1;
if (!hasAuto) {
this.log("å°šæœªè´­ä¹°è‡ªåŠ¨æŒ‘æˆ˜å‡çº§ï¼", true);
return;
}
this.autoBattleEnabled = !this.autoBattleEnabled;
const status = this.autoBattleEnabled ? "ON" : "OFF";
const color = this.autoBattleEnabled ? "var(--accent-color)" : "#888";
const btn = document.getElementById('btn-auto-toggle');
btn.innerText = `è‡ªåŠ¨æŒ‘æˆ˜ï¼š${status}`;
btn.style.borderColor = this.autoBattleEnabled ? 'var(--danger-color)' : 'var(--accent-color)';
btn.style.color = this.autoBattleEnabled ? 'var(--danger-color)' : 'var(--accent-color)';
if (this.autoBattleEnabled) {
this.log("è‡ªåŠ¨æŒ‘æˆ˜å·²å¼€å¯ã€‚èƒœåˆ©åå°†è‡ªåŠ¨å‘èµ·ä¸‹ä¸€æ¬¡æŒ‘æˆ˜ã€‚", true);
this.checkAutoBattle();
} else {
this.log("è‡ªåŠ¨æŒ‘æˆ˜å·²å…³é—­ã€‚", true);
}
ui.update();
},
getAchievementMult() {
const chalRestrict = this.getChallengeRestriction();
if (chalRestrict.noAchMult) return 1;
let mult = 1;
this.state.unlockedAchievements.forEach(id => {
const ach = CONFIG.achievements.find(a => a.id === id);
if (ach) mult *= ach.rewardMult;
});
const upgs = this.state.ultimateUpgrades || {};
if (upgs['u_ach_boost1']) mult *= 1.5;
if (upgs['u_ach_boost2']) mult *= 2;
if (chalRestrict.halfAchMult) return 1 + (mult - 1) * 0.5;
return mult;
},
getRealmResourceMult(isT2 = false, isT3 = false) {
let mult = 1;
const rT1 = this.state.realmUpgrades['r_res_t1'] || 0;
const rT2 = this.state.realmUpgrades['r_res_t2'] || 0;
const rT3 = this.state.realmUpgrades['r_res_t3'] || 0;
if (isT3) mult *= Math.pow(1.2, rT3);
else if (isT2) mult *= Math.pow(1.1, rT2);
else mult *= Math.pow(1.1, rT1);
// Ultimate upgrade bonuses
const upgs = this.state.ultimateUpgrades || {};
// Time/resource bonuses
if (!isT2 && !isT3) {
  if (upgs['u_time1']) mult *= 1.5;
  if (upgs['u_time1b']) mult *= 1.3;
  if (upgs['u_time2']) mult *= 1.8;
  if (upgs['u_volt_boost']) mult *= 2;
  if (upgs['u_volt_boost2']) mult *= 3;
  if (upgs['u_volt_boost3']) mult *= 5;
  if (upgs['u_volt_boost4']) mult *= 10;
  if (upgs['u_volt_boost5']) mult *= 20;
}
if (isT2) {
  if (upgs['u_time1b']) mult *= 1.3;
  if (upgs['u_time2']) mult *= 1.8;
  if (upgs['u_mag_boost']) mult *= 2;
  if (upgs['u_mag_boost2']) mult *= 3;
  if (upgs['u_mag_boost3']) mult *= 5;
  if (upgs['u_mag_boost4']) mult *= 10;
  if (upgs['u_mag_boost5']) mult *= 20;
}
if (isT3 && upgs['u_time3']) mult *= 2;
if (isT3 && upgs['u_skill_boost']) mult *= 2;
// Shared bonuses
if (upgs['u_res_a1']) mult *= 1.2;
if (upgs['u_res_a2']) mult *= 1.4;
if (upgs['u_res_a3']) mult *= 1.5;
if (upgs['u_res_a4']) mult *= 1.5;
if (upgs['u_res_a5']) mult *= 2;
if (upgs['u_res_a6']) mult *= 3;
if (upgs['u_res_a7']) mult *= 5;
if (upgs['u_res_a8']) mult *= 10;
if (upgs['u_res_a9']) mult *= 20;
if (upgs['u_res_a10']) mult *= 50;
if (upgs['u_all_boost']) mult *= 3;
if (upgs['u_all_boost2']) mult *= 5;
if (upgs['u_all_boost3']) mult *= 10;
if (upgs['u_all_boost4']) mult *= 20;
if (upgs['u_all_boost5']) mult *= 50;
if (upgs['u_dimension']) mult *= 10;
if (upgs['u_synergy_a3']) mult *= 1.5;
if (upgs['u_synergy_a4']) mult *= 2;
if (upgs['u_synergy_a5']) mult *= 5;
if (upgs['u_synergy_a6']) mult *= 10;
if (upgs['u_synergy_a7']) mult *= 20;
if (upgs['u_synergy_a8']) mult *= 50;
if (upgs['u_synergy_a9']) mult *= 100;
return mult;
},
getRealmAtkMult() {
const lvl = this.state.realmUpgrades['r_atk'] || 0;
let mult = Math.pow(1.2, lvl);
const upgs = this.state.ultimateUpgrades || {};
if (upgs['u_battle_a1']) mult *= 1e200;
if (upgs['u_battle_a2']) mult *= 1.4;
if (upgs['u_battle_a3']) mult *= 2;
if (upgs['u_battle_a4']) mult *= 2;
if (upgs['u_battle_a5']) mult *= 3;
if (upgs['u_battle_a7']) mult *= 5;
if (upgs['u_battle_power']) mult *= 2;
return mult;
},
getRealmDefMult() {
const lvl = this.state.realmUpgrades['r_def'] || 0;
let mult = Math.pow(1.2, lvl);
const upgs = this.state.ultimateUpgrades || {};
if (upgs['u_battle_a1']) mult *= 1e200;
if (upgs['u_battle_a2']) mult *= 1.2;
if (upgs['u_battle_a3']) mult *= 2;
if (upgs['u_battle_a4']) mult *= 2;
if (upgs['u_battle_a5']) mult *= 3;
if (upgs['u_battle_a7']) mult *= 5;
if (upgs['u_battle_power']) mult *= 2;
return mult;
},
checkProgression() {
if (this.state.tier === 1 && this.state.volt >= CONFIG.t1Breakthrough) {
const btn = document.getElementById('btn-breakthrough');
if (btn) {
btn.disabled = false;
btn.innerText = "çªç ´è‡³ç¬¬äºŒé‡å¤© (å·²å°±ç»ª)";
btn.style.opacity = "1";
btn.style.cursor = "pointer";
}
}
if (this.state.tier === 2 && this.state.horsePower >= CONFIG.t2Breakthrough) {
const btn = document.getElementById('btn-breakthrough-t2');
if (btn) {
btn.disabled = false;
btn.innerText = "è¿›å…¥ç¬¬ä¸‰é‡å¤© (å·²å°±ç»ª)";
btn.style.opacity = "1";
btn.style.cursor = "pointer";
}
}
if (this.state.tier === 3 && !this.state.activeChallenge) {
const allSkillsBought = CONFIG.skills.every(s => this.state.skills[s.id] === 1);
if (allSkillsBought && this.state.horsePower >= CONFIG.finalCap && !this.state.tier4Unlocked) {
this.enterFinal();
}
}
// é‡Œç¨‹ç¢‘æç¤ºï¼šè¾¾åˆ°1å…†åŠ›é‡
if (this.state.tier4Unlocked && this.state.power >= 1e12 && !this.state._milestone_power_1e12) {
this.state._milestone_power_1e12 = true;
const el = document.getElementById('milestone-msg');
if (el) { el.innerText = 'ğŸ‰ æ­å–œä½ ï¼æˆåŠŸè¾¾æˆä¸€å…†åŠ›é‡ï¼Œè¿ˆå…¥äº†ç»ˆæå¼ºè€…çš„è¡Œåˆ—ï¼ï¼ï¼'; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 12000); }
this.log('ğŸ‰ æ­å–œä½ ï¼æˆåŠŸè¾¾æˆä¸€å…†åŠ›é‡ï¼Œè¿ˆå…¥äº†ç»ˆæå¼ºè€…çš„è¡Œåˆ—ï¼ï¼ï¼', true);
}
// é‡Œç¨‹ç¢‘æç¤ºï¼šè¾¾åˆ°1äº¿æµé‡
if (this.state.flowUnlocked && this.state.flow >= 1e8 && !this.state._milestone_flow_1e8) {
this.state._milestone_flow_1e8 = true;
const el = document.getElementById('milestone-msg');
if (el) { el.innerText = 'ğŸ‰ æ­å–œä½ ï¼æˆåŠŸè¾¾æˆä¸€äº¿çº§æµé‡ï¼Œç°åœ¨å¯ä»¥å¼€å§‹æ¨è¿›åŠ›é‡çš„æå‡äº†ï¼ï¼ï¼'; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 12000); }
this.log('ğŸ‰ æ­å–œä½ ï¼æˆåŠŸè¾¾æˆä¸€äº¿çº§æµé‡ï¼Œç°åœ¨å¯ä»¥å¼€å§‹æ¨è¿›åŠ›é‡çš„æå‡äº†ï¼ï¼ï¼', true);
}
// u_auto_all: è‡ªåŠ¨æ•£åŠŸé‡ä¿® & è‡ªåŠ¨è‹¦ä¿®
if (this.state.ultimateUpgrades && this.state.ultimateUpgrades['u_auto_all'] && !this.state.activeChallenge) {
  // è‡ªåŠ¨æ•£åŠŸé‡ä¿®
  if (this.state.tier === 1 && this.state.volt >= this.getPrestigeCost()) {
    const s = this.state;
    s.prestigeCount++;
    const keepAll = s.voltRetentionLevel >= 5;
    const keepCount = s.voltRetentionLevel;
    s.volt = 0;
    if (!keepAll) {
      if (keepCount < 1) { s.genCount = 0; s.genCost = 10; }
      if (keepCount < 2) { s.capLvl = 0; s.capCost = 50; }
      if (keepCount < 3) { s.transLvl = 0; s.transCost = 200; }
      if (keepCount < 4) { s.superLvl = 0; s.superCost = 1000; }
      if (keepCount < 5) { s.t1BoostLvl = 0; s.t1BoostCost = 100000; }
    }
    this.log(`[è‡ªåŠ¨] æ•£åŠŸé‡ä¿®ï¼ä¼ç‰¹å€æ•°ï¼šx${Math.pow(2, s.prestigeCount)}`, true);
    if (s.voltRetentionLevel >= 5) {
      const buyMax = (costVar, countVar, costMult) => { while (s.volt >= s[costVar]) { s.volt -= s[costVar]; s[countVar]++; s[costVar] = Math.floor(s[costVar] * costMult); } };
      buyMax('genCost', 'genCount', 1.5);
      buyMax('capCost', 'capLvl', 1.6);
      buyMax('transCost', 'transLvl', 1.7);
      buyMax('superCost', 'superLvl', 2.0);
      while (s.t1BoostLvl < 3 && s.volt >= s.t1BoostCost) { s.volt -= s.t1BoostCost; s.t1BoostLvl++; s.t1BoostCost = Math.floor(s.t1BoostCost * 5.0); }
    }
    this.checkAchievements();
  }
  // è‡ªåŠ¨è‹¦ä¿®ï¼ˆtier2ï¼‰
  if (this.state.tier >= 2 && this.state.tier < 3) {
    const req = Math.floor(CONFIG.t2PrestigeReq * Math.pow(2.0, this.state.t2PrestigeCount));
    if (this.state.horsePower >= req) {
      this.state.t2PrestigeCount++;
      this.state.horsePower = 0;
      this.state.hpUpgLvl = 0; this.state.hpUpgCost = 100;
      this.state.voltUpgLvl = 0; this.state.voltUpgCost = 500;
      this.state.voltConvLvl = 0; this.state.voltConvCost = 50000;
      this.state.autoHPLvl = 0; this.state.autoHPCost = 3000;
      this.state.clickHPLvl = 0; this.state.clickHPCost = 1500;
      this.state.t2BoostLvl = 0; this.state.t2BoostCost = 10000;
      this.log(`[è‡ªåŠ¨] è‹¦ä¿®ï¼ç£åœºå€æ•°ï¼šx${Math.pow(2, this.state.t2PrestigeCount).toFixed(2)}`, true);
      this.checkAchievements();
    }
  }
}

},
enterTier2() {
if (this.state.volt < CONFIG.t1Breakthrough) {
this.log("ä¼ç‰¹ä¸è¶³ï¼Œæ— æ³•çªç ´ï¼", true);
return;
}
this.state.tier = 2;
this.state.horsePower = 0;
const cardT1 = document.getElementById('card-breakthrough-t1');
if(cardT1) cardT1.style.display = 'none';
// Show tier2 breakthrough card now
const cardT2 = document.getElementById('card-breakthrough-t2');
if(cardT2) cardT2.style.display = '';
const btnBT2 = document.getElementById('btn-breakthrough-t2');
if(btnBT2) { btnBT2.disabled = true; btnBT2.style.opacity='0.5'; btnBT2.innerText='è¿›å…¥ç£åœºåŠŸæ³• (éœ€ 100,000 åŒ¹)'; }
this.log("çªç ´æˆåŠŸï¼è¿›å…¥çœŸæ­£åŠ›é‡ï¼šç£åœºè½¬åŠ¨ã€‚", true);
alert("ğŸ‰ æ­å–œï¼ä½ å·²è§£é”æ–°å±‚çº§ï¼šã€ç£åœºè½¬åŠ¨ã€‘\nç°åœ¨ä½ å¯ä»¥ç§¯ç´¯åŒ¹æ•°ï¼ŒæŒ‘æˆ˜æ›´é«˜çš„å¢ƒç•Œï¼");
ui.unlockTab('tier2');
if (!this.state.activeChallenge) ui.unlockTab('challenge');
ui.switchTab('tier2');
this.checkAchievements();
// Check challenge win
if (this.state.activeChallenge) this.checkChallengeWin();
ui.update();
},
enterTier3() {
if (this.state.horsePower < CONFIG.t2Breakthrough) {
this.log("åŒ¹æ•°ä¸è¶³ï¼Œæ— æ³•è¿›å…¥åœ°ç‹±ï¼", true);
return;
}
this.state.tier = 3;
const cardT2 = document.getElementById('card-breakthrough-t2');
if(cardT2) cardT2.style.display = 'none';
this.log("ä¿®è¡Œéš¾è¿›...è¿›å…¥ç£åœºåŠŸæ³•ã€‚", true);
alert("ğŸ‰ æ­å–œï¼ä½ å·²è§£é”æ–°å±‚çº§ï¼šã€ç£åœºåŠŸæ³•ã€‘\nç°åœ¨ä½ å¯ä»¥å­¦ä¹ å†ä»£å¼ºè€…çš„æ­¦å­¦ï¼Œç²¾è¿›è‡ªèº«ï¼");
ui.unlockTab('tier3');
ui.switchTab('tier3');
this.renderSkills();
this.checkAchievements();
// Check challenge win
if (this.state.activeChallenge) this.checkChallengeWin();
ui.update();
},
enterFinal() {
if (this.state.tier4Unlocked) return; // only first time
this.state.tier = 4;
this.state.tier4Unlocked = true;
const screen = document.getElementById('cinematic-screen');
screen.style.display = 'flex';
this.playCinematic();
this.log("è¾¾åˆ°ä¸€ç™¾ä¸‡åŒ¹ï¼æœ€ç»ˆå‰§æƒ…å¼€å§‹ï¼", true);
},
enterTier4World() {
// Called after cinematic completes - unlock tier4 world
const screen = document.getElementById('cinematic-screen');
screen.style.display = 'none';
// Unlock tier4 mechanics
this.state.gameWon = true;
// å¥–åŠ±ï¼šè§£å¼€ç¬¬ä¸€å±‚ä¼ç‰¹èµ„æºä¸Šé™ï¼ˆæå‡è‡³600äº¿ï¼‰
this.state.voltCapUnlocked = true;
CONFIG.voltHardCap = 60000000000; // 600äº¿
this.log("ğŸ è§£é”å¥–åŠ±ï¼šç¬¬ä¸€å±‚ä¼ç‰¹èµ„æºä¸Šé™å·²è§£å¼€ï¼ˆæå‡è‡³600äº¿ä¼ç‰¹ï¼‰ï¼", true);
ui.unlockTab('tier4');
ui.switchTab('tier4');
// Show power display
document.getElementById('power-display').style.display = 'inline';
document.getElementById('btn-ultimate-reset-inline').style.display = 'inline';
this.renderUltimateTree();
this.renderUltimateChallenges();
this.log("ç»ˆæå¼ºè€…ä¹‹å¢ƒå·²è§£é”ï¼åŠ›é‡å¼€å§‹ç§¯ç´¯ï¼Œè´­ä¹°ç»ˆæå‡çº§ä»¥å¢å¼ºåŠ›é‡äº§å‡ºã€‚", true);
alert("ğŸ‰ æ­å–œï¼ä½ å·²è§£é”æ–°å±‚çº§ï¼šã€ç»ˆæå¼ºè€…ã€‘\nç°åœ¨ä½ å¯ä»¥ç§¯è“„åŠ›é‡ï¼Œæˆä¸ºç»ˆæå¼ºè€…ï¼");
this.saveGame();
},
playCinematic() {
const textEl = document.getElementById('cinematic-text');
const restartBtn = document.getElementById('cinematic-restart-btn');
let lineIndex = 0;
const showNextLine = () => {
if (lineIndex >= this.cinematicLines.length) {
restartBtn.style.display = 'block';
return;
}
textEl.classList.remove('visible');
setTimeout(() => {
textEl.innerText = this.cinematicLines[lineIndex];
textEl.classList.add('visible');
lineIndex++;
setTimeout(showNextLine, 3500);
}, 2000);
};
showNextLine();
},
checkAchievements() {
let changed = false;
CONFIG.achievements.forEach(ach => {
if (!this.state.unlockedAchievements.includes(ach.id)) {
try {
if (ach.condition(this.state)) {
this.state.unlockedAchievements.push(ach.id);
this.log(`æˆå°±è§£é”ï¼š${ach.name} (å€ç‡ +${((ach.rewardMult-1)*100).toFixed(0)}%)`, true);
changed = true;
}
} catch (e) { console.error("Achievement error", e); }
}
});
if (changed) {
this.renderAchievements();
ui.update();
}
},
renderVoltRetention() {
const s = this.state;
const card = document.getElementById('card-volt-retention');
const btn = document.getElementById('btn-buy-volt-retention');
const desc = document.getElementById('volt-retention-desc');
const lvlSpan = document.getElementById('volt-retention-lvl');
lvlSpan.innerText = s.voltRetentionLevel;
if (s.voltRetentionLevel >= 5) {
desc.innerText = "æ•ˆæœï¼šä¿ç•™æ‰€æœ‰ä¼ç‰¹å‡çº§ + é‡ä¿®åç«‹åˆ»è‡ªåŠ¨è´­ä¹°æ»¡ (å·²è¾¾ä¸Šé™)";
btn.disabled = true;
btn.innerText = "å·²æ»¡çº§";
return;
}
const nextReq = 6 + s.voltRetentionLevel;
const mult = Math.pow(2, s.prestigeCount);
const cost = Math.floor((mult / 8) * 10000);
if (s.prestigeCount >= nextReq) {
card.style.display = 'flex';
desc.innerText = `æ•ˆæœï¼š${s.voltRetentionLevel + 1 >= 5 ? 'ä¿ç•™æ‰€æœ‰å¹¶è‡ªåŠ¨è´­ä¹°' : 'å¤šä¿ç•™ä¸€ä¸ª'}ä¼ç‰¹å‡çº§ã€‚èŠ±è´¹ï¼šå€æ•°/8 * 10000 ä¼ç‰¹`;
btn.disabled = s.volt < cost;
btn.innerText = `å‡çº§ (èŠ±è´¹ï¼š${ui.formatNum(cost)} V)`;
} else {
card.style.display = 'flex';
desc.innerText = `è§£é”éœ€æ±‚ï¼šæ•£åŠŸé‡ä¿®è¾¾åˆ° ${Math.pow(2, nextReq)} å€ (å½“å‰ ${Math.pow(2, s.prestigeCount)} å€)`;
btn.disabled = true;
btn.innerText = `éœ€ ${Math.pow(2, nextReq)} å€é‡ä¿®`;
}
},
renderSkills() {
const container = document.getElementById('skill-list');
container.innerHTML = '';
CONFIG.skills.forEach(s => {
const lvl = this.state.skills[s.id] || 0;
if (lvl >= 1) {
const div = document.createElement('div');
if (s.isFinal) {
div.className = 'upgrade-card final-upgrade';
div.style.opacity = '1';
div.innerHTML = `<h3 style="color:var(--gold-color)">${s.name}</h3><p>${s.desc} (å·²è¾¾æˆ)</p><button class="btn-buy gold" disabled>å·²çªç ´</button>`;
} else {
div.className = 'upgrade-card';
div.style.opacity = '0.5';
div.innerHTML = `<h3 style="color:var(--danger-color)">${s.name}</h3><p>${s.desc} (å·²é¢†æ‚Ÿ)</p><button class="btn-buy danger" disabled>å·²ä¿®ç‚¼</button>`;
}
container.appendChild(div);
return;
}
const cost = s.baseCost;
const div = document.createElement('div');
const canBuy = this.state.battleWins >= s.reqWins;
const reqText = `éœ€å‡»è´¥ ${s.reqWins} åå¼ºè€…`;
const capText = s.capUnlock ? ` (è§£é”ä¸Šé™:${ui.formatNum(s.capUnlock)})` : '';
if (s.isFinal) {
div.className = 'upgrade-card final-upgrade';
div.innerHTML = `<h3>${s.name}</h3><p>${s.desc}<br><span style="color:${canBuy?'#0f0':'#f00'}">${canBuy ? 'æ¡ä»¶æ»¡è¶³' : reqText}</span></p><button class="btn-buy gold" onclick="game.buySkill('${s.id}')" ${!canBuy ? 'disabled' : ''}>å°è¯•çªç ´ (èŠ±è´¹ï¼š${ui.formatNum(cost)} åŒ¹)</button>`;
} else {
div.className = 'upgrade-card';
div.innerHTML = `<h3 style="color:var(--danger-color)">${s.name}</h3><p>${s.desc}${capText}<br><span style="color:${canBuy?'#0f0':'#f00'}">${canBuy ? 'æ¡ä»¶æ»¡è¶³' : reqText}</span></p><button class="btn-buy danger" onclick="game.buySkill('${s.id}')" ${!canBuy ? 'disabled' : ''}>ä¿®ç‚¼ (èŠ±è´¹ï¼š${ui.formatNum(cost)} åŒ¹)</button>`;
}
container.appendChild(div);
});
},
renderRealmUpgrades() {
const container = document.getElementById('realm-upgrades');
container.innerHTML = '';
CONFIG.realmUpgrades.forEach(u => {
if (this.state.tier < (u.reqTier || 1)) return;
const lvl = this.state.realmUpgrades[u.id] || 0;
if (lvl >= u.maxLevel) return;

// ç‰¹æ®Šå¤„ç†ï¼šå…ƒç¥è½¬ä¸–æ˜¾ç¤º
if (u.id === 'r_reincarnation') {
    const canBuy = this.state.battleWins >= u.reqWins;
    const div = document.createElement('div');
    div.className = 'upgrade-card';
    div.style.borderColor = canBuy ? 'var(--gold-color)' : '#444';
    const rCosts = u.reincarnationCosts || [0];
const rCost = lvl < rCosts.length ? rCosts[lvl] : Math.floor(rCosts[rCosts.length-1] * Math.pow(5, lvl - rCosts.length + 1));
const rCostText = rCost > 0 ? `èŠ±è´¹ï¼š${ui.formatNum(rCost)} å¢ƒç•Œ` : 'å…è´¹';
const rCanBuy = canBuy && (rCost === 0 || this.state.realmCount >= rCost);
div.innerHTML = `<h3 class="gold">${u.name} <span style="font-size:0.8rem; color:#888">Lv.${lvl}/${u.maxLevel}</span></h3><p>${u.desc}<br><span style="color:${canBuy?'#0f0':'#f00'}">${canBuy ? 'æ¡ä»¶æ»¡è¶³' : `éœ€å‡»è´¥ ${u.reqWins} äºº`}</span><br><span style="color:${rCost>0?(rCanBuy?'#ffaa44':'#ff4444'):'#aaa'}">${rCostText}</span></p><button class="btn-buy gold" onclick="game.buyRealmUpgrade('${u.id}')" ${!rCanBuy ? 'disabled' : ''}>å…ƒç¥è½¬ä¸– (${rCostText})</button>`;
    container.appendChild(div);
    return;
}

const cost = Math.floor(u.baseCost * Math.pow(u.costMult, lvl));
const div = document.createElement('div');
div.className = 'upgrade-card';
div.innerHTML = `<h3 class="gold">${u.name} <span style="font-size:0.8rem; color:#888">Lv.${lvl}/${u.maxLevel}</span></h3><p>${u.desc}</p><button class="btn-buy gold" onclick="game.buyRealmUpgrade('${u.id}')">å‡å (èŠ±è´¹ï¼š${cost} æˆ)</button>`;
container.appendChild(div);
});
if (container.innerHTML === '') container.innerHTML = '<p style="color:#666; grid-column: 1/-1;">æš‚æ— å¯è´­ä¹°çš„å¢ƒç•Œå‡çº§</p>';
},
renderAchievements() {
const container = document.getElementById('achievement-list');
container.innerHTML = '';
CONFIG.achievements.forEach(ach => {
const unlocked = this.state.unlockedAchievements.includes(ach.id);
const div = document.createElement('div');
div.className = `achievement-item ${unlocked ? 'unlocked' : ''}`;
div.innerHTML = `<div class="ach-icon">${unlocked ? 'â˜…' : '?'}</div><div class="ach-info"><div class="ach-title">${ach.name}</div><div class="ach-desc">${ach.desc}</div><div class="ach-reward">${unlocked ? `å¥–åŠ±ï¼šå…¨å±€å€ç‡ x${ach.rewardMult}` : '???'}</div></div>`;
container.appendChild(div);
});
},
log(msg, important = false) {
const area = document.getElementById('log-container');
const div = document.createElement('div');
let cls = 'log-entry';
if (important) cls += ' log-important';
if (msg.includes("é‡ä¼¤") || msg.includes("å†·å´") || msg.includes("æ‰“è´¥")) cls += ' log-danger';
if (msg.includes("çªç ´") || msg.includes("ä¸€ç™¾ä¸‡") || msg.includes("èƒœåˆ©") || msg.includes("è½¬ä¸–")) cls += ' log-gold';
if (msg.includes("è‹é†’") || msg.includes("å›è¡€") || msg.includes("è‡ªåŠ¨è´­ä¹°")) cls += ' log-heal';
div.className = cls;
div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
area.prepend(div);
if (area.children.length > 50) area.lastChild.remove();
},
saveGame(notify = false) {
const s = this.state;
// Always save the "real" tier4 data separately so it survives refreshes during challenges
const tier4Backup = {
ultimatePoints: s.ultimatePoints,
ultimateUpgrades: s.ultimateUpgrades || {},
completedChallenges: s.completedChallenges || [],
bodyParts: s.bodyParts || [],
bodyResetCount: s.bodyResetCount || 0,
magneticBodyUnlocked: s.magneticBodyUnlocked || false,
tier4Unlocked: s.tier4Unlocked || false,
power: s.power || 0,
challengeRewards: s.challengeRewards || {},
activeChallenge: s.activeChallenge || null,
challengeStartTime: s.challengeStartTime || null,
flow: s.flow || 0,
flowUpgrades: s.flowUpgrades || {},
flowUpgLvl: s.flowUpgLvl || 0,
flowUnlocked: s.flowUnlocked || false,
// Save "pre-challenge" values for restoring on load during active challenge
_preChalPower: s.challengeStartState ? s.challengeStartState.power : s.power,
_preChalPoints: s.challengeStartState ? s.challengeStartState.ultimatePoints : s.ultimatePoints,
_preChalUpgrades: s.challengeStartState ? s.challengeStartState.ultimateUpgrades : s.ultimateUpgrades,
_preChalCompleted: s.challengeStartState ? s.challengeStartState.completedChallenges : s.completedChallenges,
_preChalBodyParts: s.challengeStartState ? s.challengeStartState.bodyParts : s.bodyParts,
_preChalBodyCount: s.challengeStartState ? s.challengeStartState.bodyResetCount : s.bodyResetCount,
_preChalMagBody: s.challengeStartState ? s.challengeStartState.magneticBodyUnlocked : s.magneticBodyUnlocked,
_preChalReincMult: s.challengeStartState ? s.challengeStartState.reincarnationMult : s.reincarnationMult,
_preT1BoostLvl: s.challengeStartState ? s.challengeStartState.t1BoostLvl : s.t1BoostLvl,
_preT1BoostCost: s.challengeStartState ? s.challengeStartState.t1BoostCost : s.t1BoostCost,
_preT2BoostLvl: s.challengeStartState ? s.challengeStartState.t2BoostLvl : s.t2BoostLvl,
_preT2BoostCost: s.challengeStartState ? s.challengeStartState.t2BoostCost : s.t2BoostCost,
_preChalRewards: s.challengeStartState ? s.challengeStartState.challengeRewards : s.challengeRewards,
};
localStorage.setItem('magneticT4Backup_v4', JSON.stringify(tier4Backup));
// Save game state (strip challengeStartState to reduce size)
const toSave = { ...s };
delete toSave.challengeStartState;
localStorage.setItem('magneticIncrementSave_v4', JSON.stringify(toSave));
if(notify) this.log("æ¸¸æˆè¿›åº¦å·²ä¿å­˜ã€‚", true);
},
loadGame() {
const saved = localStorage.getItem('magneticIncrementSave_v4') || localStorage.getItem('magneticIncrementSave_v3');
const t4Backup = localStorage.getItem('magneticT4Backup_v4');
if (saved) {
try {
const parsed = JSON.parse(saved);
const initial = this.getInitialState();
this.state = { ...initial, ...parsed };
// Restore tier4 backup data (overrides anything in main save to ensure consistency)
if (t4Backup) {
try {
const t4 = JSON.parse(t4Backup);
this.state.ultimatePoints = t4.ultimatePoints || 0;
this.state.ultimateUpgrades = t4.ultimateUpgrades || {};
this.state.completedChallenges = t4.completedChallenges || [];
this.state.bodyParts = t4.bodyParts || [];
this.state.bodyResetCount = t4.bodyResetCount || 0;
this.state.magneticBodyUnlocked = t4.magneticBodyUnlocked || false;
this.state.tier4Unlocked = t4.tier4Unlocked || false;
this.state.power = t4.power || 0;
this.state.challengeRewards = t4.challengeRewards || {};
this.state.flow = t4.flow || 0;
this.state.flowUpgrades = t4.flowUpgrades || {};
this.state.flowUpgLvl = t4.flowUpgLvl || 0;
this.state.flowUnlocked = t4.flowUnlocked || false;
// If we were in a challenge when saved, restore challengeStartState from backup
if (t4.activeChallenge) {
this.state.activeChallenge = t4.activeChallenge;
this.state.challengeStartTime = t4.challengeStartTime;
this.state.challengeStartState = {
power: t4._preChalPower || 0,
ultimatePoints: t4._preChalPoints || 0,
ultimateUpgrades: t4._preChalUpgrades || {},
completedChallenges: t4._preChalCompleted || [],
bodyParts: t4._preChalBodyParts || [],
bodyResetCount: t4._preChalBodyCount || 0,
magneticBodyUnlocked: t4._preChalMagBody || false,
reincarnationMult: t4._preChalReincMult || 1,
t1BoostLvl: t4._preT1BoostLvl || 0,
t1BoostCost: t4._preT1BoostCost || 100000,
t2BoostLvl: t4._preT2BoostLvl || 0,
t2BoostCost: t4._preT2BoostCost || 10000,
challengeRewards: t4._preChalRewards || {},
tier4Unlocked: true,
};
}
} catch(e2) { console.error("T4 backup error", e2); }
}
if (!Array.isArray(this.state.unlockedAchievements)) this.state.unlockedAchievements = [];
if (this.state.autoBattleEnabled === undefined) this.state.autoBattleEnabled = false;
if (this.state.reincarnationMult === undefined) this.state.reincarnationMult = 1;
// æ¢å¤ä¼ç‰¹ä¸Šé™è§£é”
if (this.state.voltCapUnlocked || this.state.tier4Unlocked) {
  CONFIG.voltHardCap = 60000000000; // 600äº¿
}
if (this.state.tier >= 2 && !this.state.activeChallenge) {
const cardT1 = document.getElementById('card-breakthrough-t1');
if(cardT1) cardT1.style.display = 'none';
}
if (this.state.tier >= 3 && !this.state.activeChallenge) {
const cardT2 = document.getElementById('card-breakthrough-t2');
if(cardT2) cardT2.style.display = 'none';
}
} catch (e) {
console.error("Save error", e);
this.state = this.getInitialState();
}
}
},
exportSave() {
const str = btoa(JSON.stringify(this.state));
prompt("å¤åˆ¶å­˜æ¡£:", str);
},
importSave() {
const str = prompt("ç²˜è´´å­˜æ¡£:");
if (!str) return;
try {
const parsed = JSON.parse(atob(str));
if (parsed.volt !== undefined) {
this.state = { ...this.getInitialState(), ...parsed };
this.saveGame();
location.reload();
} else alert("æ— æ•ˆå­˜æ¡£");
} catch (e) { alert("å­˜æ¡£æŸå"); }
},
// ========= TIER 4 NEW FUNCTIONS =========
handlePassiveRegen() { /* regen is handled inside processAutoProduction */ },
getPowerPerSec() {
const s = this.state;
if (!s.tier4Unlocked) return 0;
const upgs = s.ultimateUpgrades || {};
let rate = 1;
// Core power chain
if (upgs['u_root']) rate *= 1.5;
if (upgs['u_power1']) rate *= 1.5;
if (upgs['u_power1b']) rate *= 1.3;
if (upgs['u_power2']) rate *= 2;
if (upgs['u_power2b']) rate *= 1.5;
if (upgs['u_power3']) rate *= 3;
if (upgs['u_power4']) rate *= 5;
if (upgs['u_power4b']) rate *= 2;
if (upgs['u_power5']) rate *= 8;
if (upgs['u_power6']) rate *= 15;
if (upgs['u_power6b']) rate *= 3;
if (upgs['u_power7']) rate *= 25;
if (upgs['u_power8']) rate *= 50;
if (upgs['u_power8b']) rate *= 5;
if (upgs['u_power9']) rate *= 100;
if (upgs['u_power10']) rate *= 200;
if (upgs['u_power10b']) rate *= 10;
if (upgs['u_power11']) rate *= 300;
if (upgs['u_power12']) rate *= 500;
if (upgs['u_power13']) rate *= 1000;
if (upgs['u_power14']) rate *= 2000;
if (upgs['u_power15']) rate *= 5000;
if (upgs['u_final1']) rate *= 500;
if (upgs['u_transcend']) rate *= 100;
if (upgs['u_final_power']) rate *= 10000;
if (upgs['u_godhood']) rate *= 50;
if (upgs['u_godhood2']) rate *= 100;
if (upgs['u_transcend_prep']) rate *= 100;
if (upgs['u_ultimate_synergy']) {
  const upgCount = Object.values(upgs).filter(v=>v).length;
  rate *= Math.pow(1.5, Math.floor(upgCount/10));
}
// Speed chain
if (upgs['u_speed1']) rate *= 1.2;
if (upgs['u_speed1b']) rate *= 1.3;
if (upgs['u_speed2']) rate *= 1.5;
if (upgs['u_speed3']) rate *= 2;
if (upgs['u_speed4']) rate *= 2.5;
if (upgs['u_speed5']) rate *= 3;
if (upgs['u_speed6']) rate *= 4;
if (upgs['u_speed7']) rate *= 5;
if (upgs['u_speed8']) rate *= 6;
if (upgs['u_speed9']) rate *= 8;
if (upgs['u_speed10']) rate *= 10;
if (upgs['u_speed11']) rate *= 12;
if (upgs['u_speed12']) rate *= 15;
if (upgs['u_speed13']) rate *= 20;
if (upgs['u_speed14']) rate *= 30;
if (upgs['u_speed15']) rate *= 50;
// Power field chain
if (upgs['u_pow_a1']) rate *= 1.2;
if (upgs['u_pow_a2']) rate *= 1.3;
if (upgs['u_pow_a3']) rate *= 1.5;
if (upgs['u_pow_a4']) rate *= 2;
if (upgs['u_pow_a5']) rate *= 3;
if (upgs['u_pow_a6']) rate *= 5;
if (upgs['u_pow_a7']) rate *= 8;
if (upgs['u_pow_a8']) rate *= 15;
if (upgs['u_pow_a9']) rate *= 30;
if (upgs['u_pow_a10']) rate *= 60;
// Synergy chain
if (upgs['u_synergy_a1']) rate *= 1.1;
if (upgs['u_synergy_a2']) rate *= 1.2;
if (upgs['u_synergy_a3']) rate *= 1.5;
if (upgs['u_synergy_a4']) rate *= 2;
if (upgs['u_synergy_a5']) rate *= 5;
if (upgs['u_synergy_a6']) rate *= 10;
if (upgs['u_synergy_a7']) rate *= 20;
if (upgs['u_synergy_a8']) rate *= 50;
if (upgs['u_synergy_a9']) { rate *= 100; rate *= 10; }
// Achievement boost
if (upgs['u_ach_boost1']) rate *= 1.5;
if (upgs['u_ach_boost2']) rate *= 2;
// Body synergy: +100% per owned body part
const bodyCount = (s.bodyParts || []).length;
if (upgs['u_body_synergy']) rate *= (1 + bodyCount);
if (upgs['u_body_all']) rate *= 2;
// All body parts owned bonus
if (upgs['u_body5'] && bodyCount >= 5) rate *= 5;
// Battle wins bonus
if (upgs['u_battle_a8'] || upgs['u_battle_a9'] || upgs['u_battle_a10']) {
  const winsBonus = Math.floor((s.battleWins || 0) / 100);
  const bonusPerWin = upgs['u_battle_a10'] ? 0.5 : (upgs['u_battle_a9'] ? 0.2 : 0.1);
  rate *= (1 + winsBonus * bonusPerWin);
}
// Volt/Mag boost series also boost power production (since tier 1-3 are already capped)
if (upgs['u_volt_boost']) rate *= 1.5;
if (upgs['u_volt_boost2']) rate *= 2;
if (upgs['u_volt_boost3']) rate *= 3;
if (upgs['u_volt_boost4']) rate *= 5;
if (upgs['u_volt_boost5']) rate *= 8;
if (upgs['u_mag_boost']) rate *= 1.5;
if (upgs['u_mag_boost2']) rate *= 2;
if (upgs['u_mag_boost3']) rate *= 3;
if (upgs['u_mag_boost4']) rate *= 5;
if (upgs['u_mag_boost5']) rate *= 8;
// time/res series also redirect to power
if (upgs['u_time1']) rate *= 1.3;
if (upgs['u_time1b']) rate *= 1.3;
if (upgs['u_time2']) rate *= 1.5;
if (upgs['u_time3']) rate *= 2;
if (upgs['u_res_a1']) rate *= 1.1;
if (upgs['u_res_a2']) rate *= 1.2;
if (upgs['u_res_a3']) rate *= 1.3;
if (upgs['u_res_a4']) rate *= 1.5;
if (upgs['u_res_a5']) rate *= 2;
if (upgs['u_res_a6']) rate *= 3;
if (upgs['u_res_a7']) rate *= 5;
if (upgs['u_res_a8']) rate *= 8;
if (upgs['u_res_a9']) rate *= 15;
if (upgs['u_res_a10']) rate *= 30;
// å®Œå…¨å¢ƒç•ŒåŠ æˆ: æ¯100å¢ƒç•Œ+10%ï¼ˆå åŠ ï¼‰
const realmBonus = 1 + Math.floor((s.realmCount || 0) / 100) * 0.1;
rate *= realmBonus;
// æµé‡åŠ æˆ: æ¯1000æµé‡+5%
const flowBonus = 1 + Math.floor((s.flow || 0) / 1000) * 0.05;
rate *= flowBonus;
// ä¼ç‰¹åŠ æˆï¼šä¼ç‰¹è¶Šé«˜ï¼ŒåŠ›é‡äº§å‡ºè¶Šå¿«ï¼ˆæä½å€ç‡ï¼Œä¸Šé™10å€ï¼‰
// 600äº¿ä¼ç‰¹æ—¶æ°å¥½è¾¾åˆ°10å€ä¸Šé™
if ((s.volt || 0) > 0) {
  const voltLog = Math.log10(s.volt + 1);
  const voltBonusCap = 9; // +9 â†’ total 10x
  const k = Math.log10(6e10 + 1) / voltBonusCap; // normalizer
  const voltBonus = 1 + Math.min(voltLog / k, voltBonusCap);
  rate *= voltBonus;
}
// å‡»è´¥å¼ºè€…åŠ æˆï¼ˆè§£é”ç»ˆæå¼ºè€…åç”Ÿæ•ˆï¼‰ï¼šæ¯å‡»è´¥100åæ•Œäºº+1%åŠ›é‡äº§å‡ºï¼Œä¸Šé™+10000%ï¼ˆ100å€ï¼‰
if (s.tier4Unlocked) {
  const rawBonus = Math.floor((s.battleWins || 0) / 100) * 0.01;
  const battleBonus = 1 + Math.min(rawBonus, 100); // ä¸Šé™ +10000%
  rate *= battleBonus;
}
// ä¼ç‰¹åŠ æˆï¼šä¼ç‰¹è¶Šé«˜ï¼ŒåŠ›é‡äº§å‡ºé€Ÿåº¦å°å¹…æå‡ï¼ˆæœ€å¤š10å€ï¼‰
// å…¬å¼ï¼š1 + 9 * (log10(volt+1) / log10(voltHardCap))ï¼Œä¸Šé™10x
if (s.volt > 0) {
  const voltLog = Math.log10(Math.max(1, s.volt));
  const voltCapLog = Math.log10(Math.max(1, CONFIG.voltHardCap));
  const voltBonus = 1 + 9 * Math.min(1, voltLog / voltCapLog);
  rate *= voltBonus;
}
return rate;
},
processPowerProduction() {
const s = this.state;
if (!s.tier4Unlocked || s.activeChallenge) return; // don't generate power during challenges
const rate = this.getPowerPerSec();
s.power = Math.min(s.power + rate, this.getCurrentPowerCap());
},
getCurrentPowerCap() {
const completed = (this.state.completedChallenges || []).length;
const caps = CONFIG.challengePowerCaps;
return caps[Math.min(completed, caps.length - 1)];
},
getUltimateResetPreview(power) {
// æ¢ç®—å…¬å¼ï¼špts = floor(10^(log10(power) * exponent - 1))
// å®Œæˆç¬¬ä¸€ä½å¼ºè€…æŒ‘æˆ˜åï¼ŒæŒ‡æ•°ä» 0.6 æå‡è‡³ 0.75ï¼Œå¤§å¹…å¢åŠ è·å–é‡
if (power <= 0) return 0;
const logP = Math.log10(Math.max(1, power));
if (logP < 2) return 0;
const upgs = this.state.ultimateUpgrades || {};
const rewards = this.state.challengeRewards || {};
// c1æŒ‘æˆ˜å®Œæˆåï¼šæŒ‡æ•°åŠ æˆ 0.6 â†’ 0.75ï¼ˆæ¯10åŠ›é‡é‡çº§çº¦å¤šå¾—10å€ç‚¹æ•°ï¼‰
const exponent = rewards['c1'] ? 0.75 : 0.6;
const pts = Math.floor(Math.pow(10, logP * exponent - 1));
// ç»ˆæé¢†æ‚ŸIIIåŠ æˆ
const mult = upgs['u_final3'] ? 2 : 1;
return Math.max(0, pts * mult);
},
doUltimateReset() {
const s = this.state;
if (!s.tier4Unlocked) return;
const pts = this.getUltimateResetPreview(s.power);
if (pts <= 0) { this.log("åŠ›é‡ä¸è¶³ï¼éœ€è¦è‡³å°‘1000åŠ›é‡æ‰èƒ½è·å–ç»ˆæç‚¹æ•°ï¼", true); return; }
// Apply challenge reward multipliers
const mult1 = s.ultimateUpgrades && s.ultimateUpgrades['u_challenge_reward'] ? 3 : 1;
const mult2 = s.ultimateUpgrades && s.ultimateUpgrades['u_ultra_reward'] ? 5 : 1;
const finalPts = Math.floor(pts * mult1 * mult2);
if (!confirm(`ç¡®å®šé‡ç½®ï¼Ÿå½“å‰åŠ›é‡ ${ui.formatPower(s.power)} å°†è½¬æ¢ä¸º ${ui.formatNum(finalPts)} ç»ˆæç‚¹æ•°ã€‚\nå‰ä¸‰å±‚çš„è¿›åº¦ï¼ˆä¼ç‰¹ã€åŒ¹æ•°ã€å‡çº§ç­‰ï¼‰å°†ä¿ç•™ï¼`)) return;
s.ultimatePoints += finalPts;
s.power = 0;
// Do NOT reset tier1-3 - only reset power
this.log(`é‡ç½®å®Œæˆï¼è·å¾— ${ui.formatNum(finalPts)} ç»ˆæç‚¹æ•°ï¼ˆåŸºäºåŠ›é‡å¯¹æ•°æ¢ç®—ï¼‰ã€‚å‰ä¸‰å±‚è¿›åº¦å·²ä¿ç•™ã€‚`, true);
this.renderUltimateTree();
this.renderUltimateChallenges();
ui.update();
},
buyUltimateUpgrade(id) {
const s = this.state;
const upg = CONFIG.ultimateUpgrades.find(u => u.id === id);
if (!upg || s.ultimateUpgrades[id]) return;
if (upg.requires && !s.ultimateUpgrades[upg.requires]) {
this.log("éœ€è¦å…ˆè´­ä¹°å‰ç½®å‡çº§ï¼", true); return;
}
if (upg.reqChallenge && !(s.completedChallenges && s.completedChallenges.includes(upg.reqChallenge))) {
const refCh = CONFIG.ultimateChallenges.find(c => c.id === upg.reqChallenge);
this.log(`éœ€è¦å…ˆå®ŒæˆæŒ‘æˆ˜ï¼š${refCh ? refCh.name : upg.reqChallenge}ï¼`, true); return;
}
if (s.ultimatePoints < upg.cost && upg.cost < Number.MAX_VALUE) {
this.log("ç»ˆæç‚¹æ•°ä¸è¶³ï¼", true); return;
}
if (upg.cost >= Number.MAX_VALUE && s.ultimatePoints < 1e300) {
this.log("ç»ˆæç‚¹æ•°ä¸è¶³ï¼éœ€è¦çº¦ 1e300 ç‚¹ï¼", true); return;
}
s.ultimatePoints -= upg.cost;
s.ultimateUpgrades[id] = true;
this.log(`ğŸ”® è´­ä¹°ç»ˆæå‡çº§ï¼š${upg.name}`, true);
// Check if this is the first ultimate upgrade - unlock flow page
const upgCount = Object.values(s.ultimateUpgrades).filter(v=>v).length;
if (upgCount === 1 && !s.flowUnlocked) {
s.flowUnlocked = true;
ui.unlockTab('flow');
this.log('ğŸ’§ ã€æ–°è§£é”ã€‘æŒ‘æˆ˜å¼ºè€…é¡µé¢ä¸‹æ–¹çš„ã€Œæµé‡ã€å·²è§£é”ï¼æµé‡å¯é€šè¿‡å……èƒ½è·å–ï¼Œç”¨äºå¢å¼ºç»ˆæå¼ºè€…å±‚åŠ›é‡äº§å‡ºã€‚', true);
// Show notification popup
setTimeout(() => {
alert('ğŸŒŠ æµé‡ç³»ç»Ÿå·²è§£é”ï¼\n\nåœ¨ä¾§è¾¹æ ã€ŒæŒ‘æˆ˜å¼ºè€…ã€ä¸‹æ–¹æ‰¾åˆ°ã€Œæµé‡ã€é¡µé¢ã€‚\næµé‡å¯é€šè¿‡ç‚¹å‡»å……èƒ½æ¡ç§¯ç´¯ï¼Œè´­ä¹°æµé‡å‡çº§å¢åŠ æ¯æ¬¡è·å–é‡ã€‚\næµé‡è¶Šå¤šï¼Œç»ˆæå¼ºè€…å±‚åŠ›é‡äº§å‡ºè¶Šé«˜ï¼');
}, 200);
}
this.renderUltimateTree();
this.renderUltimateChallenges();
ui.update();
},
getChallengeRestriction() {
const s = this.state;
if (!s.activeChallenge) return {};
const ch = CONFIG.ultimateChallenges.find(c => c.id === s.activeChallenge);
return ch ? (ch.restriction || {}) : {};
},
startUltimateChallenge(id) {
const s = this.state;
const ch = CONFIG.ultimateChallenges.find(c => c.id === id);
if (!ch) return;
if (s.activeChallenge) { this.log("å·²åœ¨æŒ‘æˆ˜ä¸­ï¼", true); return; }
if (s.completedChallenges.includes(id)) { this.log("å·²å®Œæˆæ­¤æŒ‘æˆ˜ï¼", true); return; }
// Check unlock requirement (separate challenge unlock upgrades)
if (ch.reqUpg && !s.ultimateUpgrades[ch.reqUpg]) {
this.log("éœ€è¦å…ˆè´­ä¹°å¯¹åº”ç»ˆæè§£é”å‡çº§ï¼", true); return;
}
// Check previous challenge
const idx = CONFIG.ultimateChallenges.findIndex(c => c.id === id);
if (idx > 0) {
const prevId = CONFIG.ultimateChallenges[idx - 1].id;
if (!s.completedChallenges.includes(prevId)) {
this.log("éœ€è¦å…ˆå®Œæˆä¸Šä¸€ä¸ªæŒ‘æˆ˜ï¼", true); return;
}
}
// Check power requirement
if (s.power < ch.powerReq) {
this.log(`åŠ›é‡ä¸è¶³ï¼æŒ‘æˆ˜${ch.name}éœ€è¦ ${ui.formatNum(ch.powerReq)} åŠ›é‡ã€‚`, true); return;
}
// Check ultimate points requirement
if (ch.pointReq && s.ultimatePoints < ch.pointReq) {
this.log(`ç»ˆæç‚¹æ•°ä¸è¶³ï¼æŒ‘æˆ˜${ch.name}éœ€è¦ ${ui.formatNum(ch.pointReq)} ç»ˆæç‚¹æ•°ã€‚`, true); return;
}
if (!confirm(`å¼€å§‹æŒ‘æˆ˜ï¼š${ch.name}ï¼Ÿ\n\né™åˆ¶ï¼š${ch.desc}\nå¥–åŠ±ï¼š${ch.reward}\n\næ¸¸æˆå°†ä»é›¶å¼€å§‹ï¼`)) return;
// c1æŒ‘æˆ˜ï¼šå…ˆæ’­æ”¾å‰§æƒ…è¿‡åœºï¼Œå®Œæˆåå†å®é™…å¼€å§‹æŒ‘æˆ˜
if (id === 'c1') {
  this._pendingChallengeId = id;
  this.playC1Cinematic();
  return;
}
this._actuallyStartChallenge(id);
},
exitUltimateChallenge(forced = false) {
const s = this.state;
if (!s.activeChallenge) return;
if (!forced && !confirm("ç¡®å®šæ”¾å¼ƒå½“å‰æŒ‘æˆ˜ï¼Ÿï¼ˆè¿›åº¦ä¸ä¼šä¿ç•™ï¼Œä½†ä¹Ÿä¸ä¼šè¿˜åŸå¼€å§‹å‰çš„èµ„æºï¼‰")) return;
this._restoreFromChallenge(false, null);
},
playC1Cinematic() {
const screen = document.getElementById('cinematic-screen');
const textEl = document.getElementById('cinematic-text');
const restartBtn = document.getElementById('cinematic-restart-btn');
const confirmBtn = document.getElementById('cinematic-confirm-btn');
restartBtn.style.display = 'none';
confirmBtn.style.display = 'none';
screen.style.display = 'flex';
// å·²çœ‹è¿‡è¿‡åœºåŠ¨ç”»åˆ™æ˜¾ç¤ºç®€çŸ­ç¡®è®¤ç”»é¢
if (this.state.c1CinematicSeen) {
  textEl.classList.remove('visible');
  setTimeout(() => {
    textEl.innerText = 'è¿˜è¦å°è¯•æŒ‘æˆ˜å—ï¼Ÿ';
    textEl.classList.add('visible');
    confirmBtn.style.display = 'block';
  }, 800);
  this._c1CinematicContinue = () => {
    confirmBtn.style.display = 'none';
    screen.style.display = 'none';
    this._actuallyStartChallenge(this._pendingChallengeId);
    this._pendingChallengeId = null;
    this._c1CinematicContinue = null;
  };
  return;
}
// é¦–æ¬¡æ’­æ”¾å®Œæ•´è¿‡åœº
this.state.c1CinematicSeen = true;
const lines = [
  "åˆä¸€æ¬¡ï¼Œä½ åˆä¸€æ¬¡ç«™åˆ°äº†è¿™é‡Œã€‚",
  "çºµä½¿æˆ‘æ‹¥æœ‰ä¸‰å¸ˆå…„æ‰€ç»™äºˆçš„å¤©çœ¼ï¼Œä¹Ÿæ— æ³•çœ‹åˆ°è¿™æœªæ¥ã€‚",
  "ä½ çœŸçš„å‡†å¤‡å¥½äº†ï¼Ÿ",
];
const linesAfterConfirm = [
  "å¾ˆå¥½â€¦â€¦",
  "åœ¨ä½ æŒ‘æˆ˜ä»–ä¹‹å‰ï¼Œå°±ç”±æˆ‘æ¥ç»™ä½ ç¬¬ä¸€æ¬¡è¯•ç‚¼ã€‚",
  "è€Œå½“ä½ é€šè¿‡è¯•ç‚¼åï¼Œæˆ‘ä¾¿å°†å¤©çœ¼äº¤äºˆä½ ã€‚",
];
const showLine = (text, onDone) => {
  textEl.classList.remove('visible');
  setTimeout(() => {
    textEl.innerText = text;
    textEl.classList.add('visible');
    setTimeout(onDone, 3500);
  }, 2000);
};
const playLines = (arr, startIdx, onAllDone) => {
  if (startIdx >= arr.length) { onAllDone(); return; }
  showLine(arr[startIdx], () => playLines(arr, startIdx + 1, onAllDone));
};
playLines(lines.slice(0, 2), 0, () => {
  showLine(lines[2], () => {
    confirmBtn.style.display = 'block';
  });
});
this._c1CinematicContinue = () => {
  confirmBtn.style.display = 'none';
  playLines(linesAfterConfirm, 0, () => {
    screen.style.display = 'none';
    this._actuallyStartChallenge(this._pendingChallengeId);
    this._pendingChallengeId = null;
    this._c1CinematicContinue = null;
  });
};
},
cinematicConfirm() {
if (this._c1CinematicContinue) this._c1CinematicContinue();
},
_actuallyStartChallenge(id) {
const s = this.state;
const ch = CONFIG.ultimateChallenges.find(c => c.id === id);
if (!ch) return;
// Save entire current tier4 state
const tier4Save = {
tier4Unlocked: s.tier4Unlocked,
ultimatePoints: s.ultimatePoints,
ultimateUpgrades: JSON.parse(JSON.stringify(s.ultimateUpgrades)),
completedChallenges: [...s.completedChallenges],
bodyParts: [...(s.bodyParts||[])],
bodyResetCount: s.bodyResetCount || 0,
magneticBodyUnlocked: s.magneticBodyUnlocked,
reincarnationMult: s.reincarnationMult || 1,
t1BoostLvl: s.t1BoostLvl, t1BoostCost: s.t1BoostCost,
t2BoostLvl: s.t2BoostLvl, t2BoostCost: s.t2BoostCost,
power: s.power,
challengeRewards: JSON.parse(JSON.stringify(s.challengeRewards || {})),
flow: s.flow || 0,
flowMax: s.flowMax || 1e8,
flowUpgrades: JSON.parse(JSON.stringify(s.flowUpgrades || {})),
flowUpgLvl: s.flowUpgLvl || 0,
flowUnlocked: s.flowUnlocked || false,
// æˆå°±ç³»ç»Ÿ & å¼ºè€…æŒ‘æˆ˜é¡µé¢ - è¿›å‡ºæŒ‘æˆ˜å‡å®Œæ•´ä¿ç•™
unlockedAchievements: [...(s.unlockedAchievements || [])],
battleWins: s.battleWins || 0,
realmCount: s.realmCount || 0,
realmUpgrades: JSON.parse(JSON.stringify(s.realmUpgrades || {})),
playerMaxHp: s.playerMaxHp || 100,
playerCurHp: s.playerCurHp || 100,
isInjured: s.isInjured || false,
injuredUntil: s.injuredUntil || 0,
hpRegenActive: s.hpRegenActive !== false,
autoBattleEnabled: this.autoBattleEnabled || false,
};
// Full reset to initial state
this.state = this.getInitialState();
// Apply challenge state
this.state.tier = 1;
this.state.tier4Unlocked = true;
this.state.ultimatePoints = tier4Save.ultimatePoints;
this.state.ultimateUpgrades = tier4Save.ultimateUpgrades;
this.state.completedChallenges = tier4Save.completedChallenges;
this.state.bodyParts = tier4Save.bodyParts;
this.state.bodyResetCount = tier4Save.bodyResetCount;
this.state.magneticBodyUnlocked = tier4Save.magneticBodyUnlocked;
this.state.reincarnationMult = tier4Save.reincarnationMult;
this.state.t1BoostLvl = tier4Save.t1BoostLvl;
this.state.t1BoostCost = tier4Save.t1BoostCost;
this.state.t2BoostLvl = tier4Save.t2BoostLvl;
this.state.t2BoostCost = tier4Save.t2BoostCost;
this.state.power = 0; // power resets during challenge
this.state.challengeRewards = tier4Save.challengeRewards || {};
this.state.activeChallenge = id;
this.state.challengeStartState = tier4Save;
this.state.challengeStartTime = Date.now();
// å®Œæ•´ä¿ç•™ï¼šæˆå°±ç³»ç»Ÿã€å¼ºè€…æŒ‘æˆ˜é¡µé¢æ‰€æœ‰å†…å®¹
this.state.unlockedAchievements = [...(tier4Save.unlockedAchievements || [])];
this.state.battleWins = tier4Save.battleWins || 0;
this.state.realmCount = tier4Save.realmCount || 0;
this.state.realmUpgrades = JSON.parse(JSON.stringify(tier4Save.realmUpgrades || {}));
this.state.playerMaxHp = tier4Save.playerMaxHp || 100;
this.state.playerCurHp = tier4Save.playerCurHp || 100;
this.state.isInjured = tier4Save.isInjured || false;
this.state.injuredUntil = tier4Save.injuredUntil || 0;
this.state.hpRegenActive = tier4Save.hpRegenActive !== false;
this.autoBattleEnabled = tier4Save.autoBattleEnabled || false;
// æµé‡æ°¸ä¸é‡ç½®â€”â€”è¿›å…¥æŒ‘æˆ˜æ—¶å®Œæ•´ä¿ç•™
this.state.flow = tier4Save.flow || 0;
this.state.flowMax = tier4Save.flowMax || 1e8;
this.state.flowUpgrades = JSON.parse(JSON.stringify(tier4Save.flowUpgrades || {}));
this.state.flowUpgLvl = tier4Save.flowUpgLvl || 0;
this.state.flowUnlocked = tier4Save.flowUnlocked || false;
// Reset all navigation to locked state
const navIds = ['tier2','tier3','challenge'];
navIds.forEach(tabId => {
const btn = document.getElementById(`nav-${tabId}`);
if (btn) btn.classList.add('disabled');
});
// Restore breakthrough cards
const cardT1 = document.getElementById('card-breakthrough-t1');
if (cardT1) cardT1.style.display = '';
const cardT2 = document.getElementById('card-breakthrough-t2');
if (cardT2) cardT2.style.display = 'none';
const btnBT = document.getElementById('btn-breakthrough');
if (btnBT) { btnBT.disabled = true; btnBT.style.opacity='0.5'; btnBT.style.borderColor='#444'; btnBT.style.color='#444'; btnBT.innerText='çªç ´è‡³ç£åœºè½¬åŠ¨ (éœ€ 500,000 V)'; }
const btnBT2 = document.getElementById('btn-breakthrough-t2');
if (btnBT2) { btnBT2.disabled = true; btnBT2.style.opacity='0.5'; btnBT2.innerText='è¿›å…¥ç£åœºåŠŸæ³• (éœ€ 100,000 åŒ¹)'; }
const banner = document.getElementById('challenge-mode-banner');
banner.classList.add('active');
document.getElementById('challenge-mode-name').innerText = ch.name;
ui.switchTab('tier1');
this.checkAchievements();
this.renderRealmUpgrades();
this.renderSkills();
this.log(`âš”ï¸ æŒ‘æˆ˜å¼€å§‹ï¼š${ch.name}`, true);
this.log(`é™åˆ¶ï¼š${ch.desc}`, true);
ui.update();
},
_restoreFromChallenge(won, ch) {
const s = this.state;
const saved = s.challengeStartState || {};
// Build restored state from saved tier4 data
const newState = this.getInitialState();
// Restore tier4 permanent data from pre-challenge save
newState.tier = 4;
newState.tier4Unlocked = true;
newState.ultimatePoints = (saved.ultimatePoints || 0) + (won && ch ? ch.pointReward : 0);
newState.ultimateUpgrades = JSON.parse(JSON.stringify(saved.ultimateUpgrades || {}));
newState.completedChallenges = won && ch
  ? [...(saved.completedChallenges || []), ch.id]
  : [...(saved.completedChallenges || [])];
newState.bodyParts = [...(saved.bodyParts || [])];
newState.bodyResetCount = saved.bodyResetCount || 0;
newState.magneticBodyUnlocked = saved.magneticBodyUnlocked || false;
newState.reincarnationMult = saved.reincarnationMult || 1;
newState.t1BoostLvl = saved.t1BoostLvl || 0;
newState.t1BoostCost = saved.t1BoostCost || 100000;
newState.t2BoostLvl = saved.t2BoostLvl || 0;
newState.t2BoostCost = saved.t2BoostCost || 10000;
newState.power = saved.power || 0;
newState.challengeRewards = JSON.parse(JSON.stringify(saved.challengeRewards || {}));
// æµé‡æ°¸ä¸é‡ç½®â€”â€”å–è¿›å…¥æŒ‘æˆ˜æ—¶ä¿å­˜çš„å€¼ä¸æŒ‘æˆ˜ä¸­è·å–å€¼çš„æœ€å¤§å€¼
newState.flow = Math.max(saved.flow || 0, this.state.flow || 0);
newState.flowMax = Math.max(saved.flowMax || 1e8, this.state.flowMax || 1e8);
newState.flowUpgrades = JSON.parse(JSON.stringify(saved.flowUpgrades || {}));
newState.flowUpgLvl = saved.flowUpgLvl || 0;
newState.flowUnlocked = saved.flowUnlocked || this.state.flowUnlocked || false;
// å®Œæ•´æ¢å¤ï¼šæˆå°±ç³»ç»Ÿã€å¼ºè€…æŒ‘æˆ˜é¡µé¢æ‰€æœ‰å†…å®¹
newState.realmCount = saved.realmCount || 0;
newState.battleWins = saved.battleWins || 0;
newState.unlockedAchievements = [...(saved.unlockedAchievements || [])];
newState.realmUpgrades = JSON.parse(JSON.stringify(saved.realmUpgrades || {}));
newState.playerMaxHp = saved.playerMaxHp || 100;
newState.playerCurHp = saved.playerCurHp || 100;
newState.isInjured = saved.isInjured || false;
newState.injuredUntil = saved.injuredUntil || 0;
newState.hpRegenActive = saved.hpRegenActive !== false;
this.autoBattleEnabled = saved.autoBattleEnabled || false;
// Handle first challenge win unlocking magnetic body
if (won && ch && ch.id === 'c1') {
newState.magneticBodyUnlocked = true;
}
// Store challenge-specific permanent rewards in challengeRewards
if (won && ch) {
if (!newState.challengeRewards) newState.challengeRewards = {};
newState.challengeRewards[ch.id] = true;
}
this.state = newState;
// Restore UI
document.getElementById('challenge-mode-banner').classList.remove('active');
// Restore tier2/tier3/challenge nav based on tier4 normal state (player has already passed these)
// In tier4, tier2/tier3/challenge are always accessible
['tier2','tier3','challenge'].forEach(tabId => {
const btn = document.getElementById(`nav-${tabId}`);
if (btn) { btn.classList.remove('disabled'); btn.classList.add('unlocked'); }
});
// Restore breakthrough card visibility
const cardT1 = document.getElementById('card-breakthrough-t1');
if (cardT1) cardT1.style.display = 'none'; // in tier4 normal, tier2 already passed
const cardT2 = document.getElementById('card-breakthrough-t2');
if (cardT2) cardT2.style.display = 'none';
// Unlock tier4 tabs
ui.unlockTab('tier4');
if (this.state.magneticBodyUnlocked) ui.unlockTab('magnetic-body');
if (this.state.flowUnlocked) { ui.unlockTab('flow'); this.renderFlowUpgrades(); }
ui.switchTab('tier4');
// Power display
document.getElementById('power-display').style.display = 'inline';
document.getElementById('btn-ultimate-reset-inline').style.display = 'inline';
if (won && ch) {
this.log(`ğŸ† æŒ‘æˆ˜å®Œæˆï¼š${ch.name}ï¼`, true);
this.log(`å¥–åŠ±ï¼š${ch.reward} (+${ch.pointReward} ç»ˆæç‚¹æ•°)`, true);
if (ch.id === 'c1' && newState.magneticBodyUnlocked) this.log("ç£åœºè‚‰ä½“å±‚å·²è§£é”ï¼", true);
// åŠ›é‡ä¸Šé™è§£é”æç¤º
const completedCount = (newState.completedChallenges || []).length;
const caps = CONFIG.challengePowerCaps;
const newCap = caps[Math.min(completedCount, caps.length - 1)];
const prevCap = caps[Math.min(completedCount - 1, caps.length - 1)];
if (newCap > prevCap) {
  this.log(`ğŸ”“ åŠ›é‡ä¸Šé™å·²è§£é”ï¼${ui.formatPower(prevCap)} â†’ ${ui.formatPower(newCap)}`, true);
}
} else {
this.log("æ”¾å¼ƒæŒ‘æˆ˜ã€‚", true);
}
this.checkAchievements();
this.renderUltimateTree();
this.renderUltimateChallenges();
this.renderBodyParts();
this.renderRealmUpgrades();
this.renderSkills();
ui.update();
},
checkChallengeWin() {
const s = this.state;
if (!s.activeChallenge) return;
const ch = CONFIG.ultimateChallenges.find(c => c.id === s.activeChallenge);
if (!ch) return;
const cond = ch.winCondition;
let won = false;
if (cond.tier !== undefined && s.tier >= cond.tier) won = true;
if (cond.t2PrestigeCount !== undefined && s.t2PrestigeCount >= cond.t2PrestigeCount) won = true;
if (cond.battleWins !== undefined && s.battleWins >= cond.battleWins) won = true;
if (!won) return;
// Calculate point reward, applying multipliers from upgrades
let baseReward = ch.pointReward || 0;
const mult1 = s.ultimateUpgrades && s.ultimateUpgrades['u_challenge_reward'] ? 3 : 1;
const mult2 = s.ultimateUpgrades && s.ultimateUpgrades['u_ultra_reward'] ? 5 : 1;
const mult3 = s.ultimateUpgrades && s.ultimateUpgrades['u_final3'] ? 10 : 1;
const totalReward = Math.floor(baseReward * mult1 * mult2 * mult3);
// Inject total reward into ch object temporarily
const chWithReward = { ...ch, pointReward: totalReward };
this._restoreFromChallenge(true, chWithReward);
},
checkChallengeTimeout() {
const s = this.state;
if (!s.activeChallenge || !s.challengeStartTime) return;
const ch = CONFIG.ultimateChallenges.find(c => c.id === s.activeChallenge);
if (!ch || !ch.restriction || !ch.restriction.timeLimit) return;
const elapsed = (Date.now() - s.challengeStartTime) / 1000;
const remaining = ch.restriction.timeLimit - elapsed;
// Update timer display if in challenge
const banner = document.getElementById('challenge-mode-banner');
if (banner && banner.classList.contains('active')) {
const timeEl = document.getElementById('challenge-timer');
if (timeEl) {
const mins = Math.floor(remaining / 60);
const secs = Math.floor(remaining % 60);
timeEl.innerText = remaining > 0 ? ` â±${mins}:${secs.toString().padStart(2,'0')}` : ' â±è¶…æ—¶ï¼';
timeEl.style.color = remaining < 30 ? '#ff2200' : '#ffaa44';
}
}
if (elapsed >= ch.restriction.timeLimit) {
this.log("â± æŒ‘æˆ˜è¶…æ—¶ï¼è‡ªåŠ¨é€€å‡ºã€‚", true);
this.exitUltimateChallenge(true);
}
},
getBodyPartMult(effectType) {
const s = this.state;
let mult = 1;
if (!s.bodyParts || !s.magneticBodyUnlocked) return mult;
const extraBonus = s.ultimateUpgrades['u2'] ? 2 : 1; // u2 doubles body part bonuses
CONFIG.bodyParts.forEach(bp => {
if (s.bodyParts.includes(bp.id) && bp.effect === effectType) {
mult *= (1 + (bp.value - 1) * extraBonus);
}
});
return mult;
},
getBodyResetCost(count) {
const costs = CONFIG.bodyResetCosts;
const base = costs[Math.min(count, costs.length - 1)];
const u7 = (this.state.ultimateUpgrades || {})['u7'] ? 0.5 : 1;
const a3 = (this.state.ultimateUpgrades || {})['u_body_a3'] ? 0.8 : 1;
const a4 = (this.state.ultimateUpgrades || {})['u_body_a4'] ? 0.7 : 1;
return base * u7 * a3 * a4;
},
doBodyReset() {
const s = this.state;
if (!s.magneticBodyUnlocked) return;
const actualNeed = this.getBodyResetCost(s.bodyResetCount);
if (s.power < actualNeed) {
this.log(`åŠ›é‡ä¸è¶³ï¼éœ€è¦ ${ui.formatNum(actualNeed)} åŠ›é‡ã€‚`, true);
return;
}
const allParts = CONFIG.bodyParts.map(b => b.id);
const remaining = allParts.filter(id => !s.bodyParts.includes(id));
if (remaining.length === 0) {
this.log("å·²æ‹¥æœ‰å…¨éƒ¨ç£åœºè‚‰ä½“ï¼", true); return;
}
const nextPart = remaining[0];
const bp = CONFIG.bodyParts.find(b => b.id === nextPart);
if (!confirm(`æ¶ˆè€— ${ui.formatNum(actualNeed)} åŠ›é‡è·å–ç£åœºè‚‰ä½“ï¼š${bp.name}ï¼Ÿ`)) return;
s.power -= actualNeed;
s.bodyParts.push(nextPart);
s.bodyResetCount++;
this.log(`è·å–ç£åœºè‚‰ä½“ï¼š${bp.name}ï¼æ•ˆæœï¼š${bp.desc}`, true);
this.renderBodyParts();
ui.update();
},
renderUltimateTree() {
const container = document.getElementById('ultimate-tree');
if (!container) return;
container.innerHTML = '';
const s = this.state;

// åˆ†ç±»å®šä¹‰
const categories = [
  { key: 'power', label: 'âš¡ åŠ›é‡', color: '#ff00ff', ids: ['u_root','u_power1','u_power1b','u_power2','u_power2b','u_power3','u_power4','u_power4b','u_power5','u_power6','u_power6b','u_power7','u_power8','u_power8b','u_power9','u_power10','u_power10b','u_power11','u_power12','u_power13','u_power14','u_power15','u_pow_a1','u_pow_a2','u_pow_a3','u_pow_a4','u_pow_a5','u_pow_a6','u_pow_a7','u_pow_a8','u_pow_a9','u_pow_a10','u_godhood','u_godhood2','u_transcend','u_final_power','u_transcend_prep','u_ultimate_synergy','u_final1','u_final2','u_final3'] },
  { key: 'speed', label: 'ğŸ’¨ é€Ÿåº¦', color: '#00ffff', ids: ['u_speed1','u_speed1b','u_speed2','u_speed3','u_speed4','u_speed5','u_speed6','u_speed7','u_speed8','u_speed9','u_speed10','u_speed11','u_speed12','u_speed13','u_speed14','u_speed15'] },
  { key: 'resource', label: 'ğŸŒŠ èµ„æº', color: '#00ff88', ids: ['u_time1','u_time1b','u_time2','u_time3','u_volt_boost','u_volt_boost2','u_volt_boost3','u_volt_boost4','u_volt_boost5','u_mag_boost','u_mag_boost2','u_mag_boost3','u_mag_boost4','u_mag_boost5','u_res_a1','u_res_a2','u_res_a3','u_res_a4','u_res_a5','u_res_a6','u_res_a7','u_res_a8','u_res_a9','u_res_a10','u_all_boost','u_all_boost2','u_all_boost3','u_all_boost4','u_all_boost5','u_dimension','u_volt_cap','u_softcap_kill','u_t3_free','u_auto_all'] },
  { key: 'battle', label: 'âš”ï¸ æˆ˜æ–—', color: '#ff4444', ids: ['u_battle_a1','u_battle_a2','u_battle_a3','u_battle_a4','u_battle_a5','u_battle_a6','u_battle_a7','u_battle_a8','u_battle_a9','u_battle_a10','u_battle_power','u_realm_boost','u_realm_boost2','u_realm_boost3','u_realm_auto','u_challenge_reward','u_ultra_reward','u_prestige_boost','u_t2prestige','u_realm_boost','u_realm_boost2'] },
  { key: 'body', label: 'ğŸ’ª è‚‰ä½“', color: '#00ffaa', ids: ['u_body1b','u_body2','u_body3','u_body4','u_body5','u_body_regen','u_body_synergy','u_body_all','u_body_a1','u_body_a2','u_body_a3','u_body_a4','u_body_a5','u_body_a6','u_body_a7','u_body_a8'] },
  { key: 'synergy', label: 'âœ¨ å…±é¸£', color: '#ffdd44', ids: ['u_synergy_a1','u_synergy_a2','u_synergy_a3','u_synergy_a4','u_synergy_a5','u_synergy_a6','u_synergy_a7','u_synergy_a8','u_synergy_a9','u_ach_boost1','u_ach_boost2','u_skill_boost','u_click1','u_click2','u_click3','u_click_boost','u_click_boost2','u_t2prestige'] },
  { key: 'challenge', label: 'ğŸ”“ æŒ‘æˆ˜è§£é”', color: '#ff8800', ids: ['u_chal_unlock1','u_chal_unlock2','u_chal_unlock3','u_chal_unlock4','u_chal_unlock5'] },
];

// æ”¶é›†æ‰€æœ‰å·²å½’ç±»çš„id
const categorized = new Set(categories.flatMap(c => c.ids));

// å°†å‰©ä½™å‡çº§åŠ å…¥powerç±»
const allIds = CONFIG.ultimateUpgrades.map(u => u.id);
const uncategorized = allIds.filter(id => !categorized.has(id));
if (uncategorized.length > 0) categories[0].ids.push(...uncategorized);

// å¤–å±‚æ¨ªå‘flexæ’åˆ—å„åˆ†ç±»åˆ—
const wrapper = document.createElement('div');
wrapper.style.cssText = 'display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap;width:100%;';

categories.forEach(cat => {
  // è¿‡æ»¤å‡ºè¯¥åˆ†ç±»å®é™…å­˜åœ¨çš„å‡çº§ï¼Œå¹¶æŒ‰è´¹ç”¨ä»é«˜åˆ°ä½æ’åˆ—
  const upgrades = cat.ids
    .map(id => CONFIG.ultimateUpgrades.find(u => u.id === id))
    .filter(Boolean)
    .filter((u, i, arr) => arr.findIndex(x => x.id === u.id) === i) // å»é‡
    .sort((a, b) => a.cost - b.cost); // è´¹ç”¨ä»ä½åˆ°é«˜æ’åˆ—

  if (upgrades.length === 0) return;

  const col = document.createElement('div');
  col.style.cssText = `display:flex;flex-direction:column;gap:4px;min-width:150px;max-width:185px;flex:1;`;

  // åˆ†ç±»æ ‡é¢˜
  const title = document.createElement('div');
  title.style.cssText = `color:${cat.color};font-family:var(--font-main);font-size:0.85rem;text-align:center;padding:4px;background:rgba(0,0,0,0.5);border:1px solid ${cat.color};margin-bottom:3px;letter-spacing:1px;`;
  title.innerText = cat.label;
  col.appendChild(title);

  upgrades.forEach(u => {
    const owned = s.ultimateUpgrades && s.ultimateUpgrades[u.id];
    const reqMet = !u.requires || (s.ultimateUpgrades && s.ultimateUpgrades[u.requires]);
    const chalMet = !u.reqChallenge || (s.completedChallenges && s.completedChallenges.includes(u.reqChallenge));
    const canAfford = s.ultimatePoints >= u.cost;
    const available = reqMet && chalMet;

    const node = document.createElement('div');
    node.style.cssText = `
      padding:5px 7px;
      border:1px solid ${owned ? cat.color : (available ? '#443344' : '#221122')};
      background:${owned ? `rgba(${cat.color === '#ff00ff' ? '255,0,255' : cat.color === '#00ffff' ? '0,255,255' : cat.color === '#00ff88' ? '0,255,136' : cat.color === '#ff4444' ? '255,68,68' : cat.color === '#00ffaa' ? '0,255,170' : cat.color === '#ffdd44' ? '255,221,68' : '255,136,0'},0.15)` : (available ? '#1a0a1a' : '#0d000d')};
      opacity:${owned ? '1' : (available ? '0.9' : '0.45')};
      cursor:${owned ? 'default' : (available && canAfford ? 'pointer' : 'not-allowed')};
      transition:border-color 0.15s;
      position:relative;
    `;
    // å¯è´­ä¹°çš„å‡çº§åŠ å‘å…‰åŠ¨ç”»
    if (!owned && available && canAfford) {
      node.classList.add('ult-node-affordable');
    }

    let statusIcon = owned ? 'âœ“' : (available ? (canAfford ? 'â—‰' : 'â—‹') : 'âœ—');
    let statusColor = owned ? cat.color : (available ? (canAfford ? '#ffffff' : '#666') : '#440044');

    node.innerHTML = `
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="color:${statusColor};font-size:0.85rem;flex-shrink:0;">${statusIcon}</span>
        <span style="color:${owned ? cat.color : (available ? '#ddc8ff' : '#554455')};font-size:0.82rem;font-family:var(--font-main);line-height:1.2;">${u.name}</span>
      </div>
      <div style="color:#888;font-size:0.72rem;margin-left:15px;line-height:1.3;">${u.desc}</div>
      <div style="color:#aa66cc;font-size:0.72rem;margin-left:15px;margin-top:1px;">${owned ? 'âœ“ å·²è´­ä¹°' : 'ğŸ’ ' + ui.formatUltPoints(u.cost) + 'ç‚¹'}</div>
    `;

    if (!owned && available && canAfford) {
      node.onclick = () => game.buyUltimateUpgrade(u.id);
      node.addEventListener('mouseover', () => { node.style.borderColor = cat.color; });
      node.addEventListener('mouseout', () => { node.style.borderColor = '#443344'; });
    } else if (!owned) {
      node.title = !available ? 'éœ€è¦å‰ç½®å‡çº§' : 'ç»ˆæç‚¹æ•°ä¸è¶³';
    }

    col.appendChild(node);
  });

  wrapper.appendChild(col);
});

container.appendChild(wrapper);
},
renderUltimateChallenges() {
const container = document.getElementById('ultimate-challenges-list');
if (!container) return;
container.innerHTML = '';
const s = this.state;
CONFIG.ultimateChallenges.forEach((ch, idx) => {
const completed = s.completedChallenges && s.completedChallenges.includes(ch.id);
const isActive = s.activeChallenge === ch.id;
const prevDone = idx === 0 || (s.completedChallenges && s.completedChallenges.includes(CONFIG.ultimateChallenges[idx-1].id));
if (!prevDone && !isActive && !completed) {
            return; // ç›´æ¥è·³è¿‡ï¼Œä¸ç”Ÿæˆè¯¥æŒ‘æˆ˜çš„å¡ç‰‡
        }

        const reqMet = !ch.reqUpg || (s.ultimateUpgrades && s.ultimateUpgrades[ch.reqUpg]);
        const hasPower = s.power >= ch.powerReq;
        const hasPoints = !ch.pointReq || s.ultimatePoints >= ch.pointReq;
        const canStart = prevDone && reqMet && hasPower && hasPoints && !completed && !s.activeChallenge;

        const div = document.createElement('div');
        div.className = `ult-challenge-card${completed?' completed':''}${isActive?' active-challenge':''}`;
        const diffStars = 'â˜…'.repeat(ch.difficulty) + 'â˜†'.repeat(10 - ch.difficulty);
        
        div.innerHTML = `
        <h4>${ch.name}</h4>
        <div style="color:#886644;font-size:0.8rem;letter-spacing:2px;margin-bottom:8px;">${diffStars}</div>
        <p style="color:#ccc;font-size:0.9rem;margin:5px 0;">${ch.desc}</p>
        <p style="color:#ffaa44;font-size:0.85rem;margin:5px 0;"> ğŸ†  å¥–åŠ±ï¼š${ch.reward}</p>
        <p style="color:${hasPower?'#44ff44':'#ff4444'};font-size:0.85rem;"> âš¡  éœ€è¦åŠ›é‡ï¼š${ui.formatNum(ch.powerReq)}${hasPower?'  âœ“ ':' (ä¸è¶³)'}</p>
        ${ch.pointReq ? `<p style="color:${hasPoints?'#44ff44':'#ff4444'};font-size:0.85rem;"> ğŸ’  éœ€è¦ç»ˆæç‚¹æ•°ï¼š${ui.formatUltPoints(ch.pointReq)}${hasPoints?'  âœ“ ':' (ä¸è¶³)'}</p>` : ''}
        ${ch.reqUpg ? `<p style="color:${reqMet?'#44ff44':'#ff4444'};font-size:0.8rem;"> ğŸ”“  å‰æå‡çº§ï¼š${reqMet?' âœ“  å·²è§£é”':'éœ€è´­ä¹°å¯¹åº”å‡çº§'}</p>` : ''}
<p style="color:${prevDone?'#44ff44':'#ff6644'};font-size:0.8rem;">${prevDone?'âœ“ å‰ç½®å·²å®Œæˆ':'éœ€å®Œæˆä¸Šä¸€æŒ‘æˆ˜'}</p>
${completed ? '<div style="color:#00ff66;font-family:var(--font-main);font-size:1.1rem;">â˜… å·²å®Œæˆ</div>' :
  isActive ? '<div style="color:#ff4400;font-family:var(--font-main);">âš” è¿›è¡Œä¸­...</div>' :
  `<button onclick="game.startUltimateChallenge('${ch.id}')" ${canStart?'':'disabled'} style="background:#2a1000;border:2px solid #ff4400;color:#ff8844;padding:8px 15px;cursor:pointer;font-family:var(--font-main);margin-top:10px;${canStart?'':'opacity:0.4;cursor:not-allowed;'}">âš” å¼€å§‹æŒ‘æˆ˜</button>`
}`;
container.appendChild(div);
});
},
renderBodyParts() {
const container = document.getElementById('body-parts-list');
if (!container) return;
container.innerHTML = '';
const s = this.state;
const neededPower = game.getBodyResetCost(s.bodyResetCount || 0);
const nextCostEl = document.getElementById('next-body-cost');
if (nextCostEl) nextCostEl.innerText = ui.formatNum(neededPower);
const partsCountEl = document.getElementById('body-parts-count');
if (partsCountEl) partsCountEl.innerText = s.bodyParts ? s.bodyParts.length : 0;
const resetBtn = document.getElementById('btn-body-reset');
if (resetBtn) {
const allOwned = s.bodyParts && s.bodyParts.length >= CONFIG.bodyParts.length;
resetBtn.disabled = allOwned || (s.power < neededPower);
resetBtn.innerText = allOwned ? 'å…¨éƒ¨æ‹¥æœ‰' : `è·å–ç£åœºè‚‰ä½“ (éœ€${ui.formatNum(neededPower)}åŠ›é‡)`;
}
CONFIG.bodyParts.forEach(bp => {
const owned = s.bodyParts && s.bodyParts.includes(bp.id);
const div = document.createElement('div');
div.className = `body-part-card${owned ? ' owned' : ''}`;
div.innerHTML = `<h4>${bp.name}</h4><p style="color:#88ffcc;font-size:0.9rem;">${bp.desc}</p><div style="color:${owned?'#00ffaa':'#446655'};font-size:0.85rem;">${owned ? 'âœ“ å·²è·å–' : 'æœªè·å–'}</div>`;
container.appendChild(div);
});
},
// ========= æµé‡ç³»ç»Ÿ =========
processFlowCharge() {
const s = this.state;
if (!s.flowUnlocked || s.flowChargeActive) return;
// åªæœ‰è´­ä¹°äº†è‡ªåŠ¨å……èƒ½å‡çº§æ‰è‡ªåŠ¨é‡å¯
const hasAutoCharge = (s.flowUpgrades || {})['fl_auto'] >= 1;
if (hasAutoCharge && s.flow < s.flowMax) {
s.flowChargeActive = true;
s.flowChargeProgress = 0;
}
},
tickFlowCharge(dt) {
// Called from requestAnimationFrame loop (dt in seconds)
const s = this.state;
if (!s.flowUnlocked || !s.flowChargeActive) return;
const totalTime = this.getFlowChargeTime();
    
    // è¿›åº¦å¢åŠ  = å¸§æ—¶é—´ / æ€»æ—¶é—´
    s.flowChargeProgress = Math.min(1, s.flowChargeProgress + dt / totalTime);
    
    if (s.flowChargeProgress >= 1) {
        // è®¡ç®—è·å–é‡é€»è¾‘ä¿æŒä¸å˜
        const upgs = s.flowUpgrades || {};
        let amount = 1;
amount += (upgs['fl_amount1'] || 0) * 4;
amount += (upgs['fl_amount2'] || 0) * 10;
amount += (upgs['fl_amount3'] || 0) * 40;
amount += (upgs['fl_amount4'] || 0) * 200;
amount += (upgs['fl_amount5'] || 0) * 1000;
amount += (upgs['fl_amount6'] || 0) * 1000;
amount += (upgs['fl_amount7'] || 0) * 2000;
amount += (upgs['fl_amount8'] || 0) * 4000;
amount += (upgs['fl_amount9'] || 0) * 20000;
amount += (upgs['fl_amount10'] || 0) * 40000;
amount += (upgs['fl_amount11'] || 0) * 100000;
amount += (upgs['fl_amount16'] || 0) * 4000000;
amount += (upgs['fl_amount17'] || 0) * 6000000;
amount += (upgs['fl_amount18'] || 0) * 8000000;
amount += (upgs['fl_amount19'] || 0) * 10000000;
amount += (upgs['fl_amount20'] || 0) * 20000000;
s.flow = Math.min(s.flowMax, s.flow + amount);
s.flowChargeProgress = 0;
// åªæœ‰è´­ä¹°äº†è‡ªåŠ¨å……èƒ½å‡çº§æ‰è‡ªåŠ¨é‡å¯
const hasAutoCharge = (s.flowUpgrades || {})['fl_auto'] >= 1;
if (hasAutoCharge && s.flow < s.flowMax) {
s.flowChargeActive = true;
} else {
s.flowChargeActive = false;
}
ui.updateFlowBar(); 
}
},
startFlowCharge() {
const s = this.state;
if (!s.flowUnlocked) return;
if (s.flow >= s.flowMax) { this.log("æµé‡å·²æ»¡ï¼", true); return; }
if (s.flowChargeActive) { this.log("æ­£åœ¨å……èƒ½ä¸­...", true); return; }
s.flowChargeActive = true;
s.flowChargeProgress = 0;
this.log("å¼€å§‹å……èƒ½æµé‡ï¼", true);
ui.update();
},
getFlowChargeTime() {
    const s = this.state;
    let baseTime = 2.5; // åŸºç¡€2.5ç§’ï¼ˆå·²å‡åŠï¼‰
    if (!s.flowUpgrades) return baseTime;
    
    // éå†æ‰€æœ‰ speed ç±»å‹çš„å‡çº§ï¼Œè®¡ç®—å‡å…æ¯”ä¾‹
    // æ³¨æ„ï¼šè¿™é‡Œé‡‡ç”¨ä¹˜æ³•å åŠ  (ä¾‹å¦‚å‡å°‘10%åï¼Œå†å‡å°‘10%ï¼Œå³ 0.9 * 0.9)ï¼Œé¿å…å‡åˆ°0æˆ–è´Ÿæ•°
    CONFIG.flowUpgrades.forEach(upg => {
        if (upg.type === 'speed') {
            const lvl = s.flowUpgrades[upg.id] || 0;
            for (let i = 0; i < lvl; i++) {
                baseTime *= (1 - upg.value); 
            }
        }
    });
    
    // è®¾ç½®æœ€ä½ä¸‹é™ï¼Œä¾‹å¦‚æœ€å¿«ä¸èƒ½ä½äº 0.1ç§’ï¼Œé˜²æ­¢é™¤é›¶é”™è¯¯æˆ–è¿‡äºç¦»è°±
    return Math.max(0.1, baseTime);
},
buyFlowUpgrade(idx) {
const s = this.state;
if (!s.flowUnlocked) return;
const upg = CONFIG.flowUpgrades[idx];
if (!upg) return;
const bought = s.flowUpgrades || {};
const lvl = bought[upg.id] || 0;
if (lvl >= upg.maxLevel) { this.log("å·²è¾¾ä¸Šé™ï¼", true); return; }
// è‡ªåŠ¨å……èƒ½éœ€è¦1ä¸‡æµé‡æ€»é‡ï¼ˆtotalFlowï¼‰æˆ–å½“å‰æµé‡
if (upg.id === 'fl_auto') {
  if (s.flow < 10000) { this.log("éœ€è¦æ‹¥æœ‰1ä¸‡æµé‡æ‰èƒ½è§£é”è‡ªåŠ¨å……èƒ½ï¼", true); return; }
}
const cost = Math.floor(upg.baseCost * Math.pow(upg.costMult, lvl));
if (s.flow < cost) { this.log("æµé‡ä¸è¶³ï¼", true); return; }
s.flow -= cost;
if (!s.flowUpgrades) s.flowUpgrades = {};
s.flowUpgrades[upg.id] = lvl + 1;
// Recalculate total flowUpgLvl from all flow upgrades
s.flowUpgLvl = Object.entries(s.flowUpgrades).reduce((sum, [id, level]) => {
const ug = CONFIG.flowUpgrades.find(u => u.id === id);
if (!ug || ug.type !== 'amount') return sum;
return sum + level;
}, 0);
this.log(`ğŸŒŠ è´­ä¹°æµé‡å‡çº§ï¼š${upg.name}`, true);
game.renderFlowUpgrades();
ui.update();
ui.updateFlowBar(); 
ui.renderFlowUpgrades(); // å¦‚æœæœ‰å‡çº§åˆ—è¡¨ä¹Ÿéœ€è¦åˆ·æ–°
},
renderFlowUpgrades() {
const container = document.getElementById('flow-upg-list');
if (!container) return;
container.innerHTML = '';
const s = this.state;
CONFIG.flowUpgrades.forEach((upg, idx) => {
const bought = s.flowUpgrades || {};
const lvl = bought[upg.id] || 0;
const cost = Math.floor(upg.baseCost * Math.pow(upg.costMult, lvl));
const maxed = lvl >= upg.maxLevel;
// è‡ªåŠ¨å……èƒ½ç‰¹æ®Šå¤„ç†
if (upg.id === 'fl_auto') {
  const locked = s.flow < 10000;
  const div = document.createElement('div');
  div.className = 'upgrade-card';
  div.style.borderColor = maxed ? '#00ffaa' : (locked ? '#333' : '#0099ff');
  div.style.borderTopColor = maxed ? '#00ffaa' : (locked ? '#333' : '#0099ff');
  div.style.gridColumn = '1 / -1'; // è·¨æ•´è¡Œ
  div.innerHTML = `
    <h3 style="color:${maxed ? '#00ffaa' : (locked ? '#555' : '#44aaff')};font-size:1rem;">
      âš™ï¸ è‡ªåŠ¨å……èƒ½
      ${maxed ? '<span style="color:#00ffaa;font-size:0.8rem;"> âœ“ å·²æ¿€æ´»</span>' : ''}
    </h3>
    <p style="font-size:0.85rem;color:${locked ? '#555' : '#88aaff'};">${upg.desc}</p>
    ${locked ? `<p style="color:#ff6644;font-size:0.8rem;">ğŸ”’ éœ€è¦å½“å‰æ‹¥æœ‰ 1ä¸‡ æµé‡æ‰èƒ½è§£é”ï¼ˆå½“å‰ï¼š${ui.formatNum(s.flow)}ï¼‰</p>` : ''}
    <button class="btn-buy" style="border-color:${maxed ? '#555' : '#0099ff'};color:${maxed ? '#555' : '#0099ff'};" 
      onclick="game.buyFlowUpgrade(${idx})" 
      ${maxed || locked ? 'disabled' : ''}>
      ${maxed ? 'å·²æ¿€æ´»' : (locked ? `ğŸ”’ éœ€è¦1ä¸‡æµé‡` : `æ¿€æ´» (èŠ±è´¹: ${ui.formatNum(cost)} æµé‡)`)}
    </button>`;
  container.appendChild(div);
  return;
}
const div = document.createElement('div');
div.className = 'upgrade-card';
div.style.borderColor = '#0066ff';
div.style.borderTopColor = '#0099ff';
div.innerHTML = `<h3 style="color:#44aaff;font-size:1rem;">${upg.name} <span style="color:#666;font-size:0.8rem">Lv.${lvl}/${upg.maxLevel}</span></h3><p style="font-size:0.85rem;color:#88aaff;">${upg.desc}</p><button class="btn-buy" style="border-color:#0099ff;color:#0099ff;" onclick="game.buyFlowUpgrade(${idx})" ${maxed ? 'disabled' : ''} ${s.flow < cost && !maxed ? 'disabled' : ''}>${maxed ? 'å·²æ»¡çº§' : `å‡çº§ (èŠ±è´¹: ${ui.formatNum(cost)} æµé‡)`}</button>`;
container.appendChild(div);
});
},
};

const ui = {
init() {
const s = game.state;
if (s.activeChallenge) {
// Restoring mid-challenge: show tier1, with tier2/3 possibly unlocked based on tier
this.switchTab('tier1');
// Unlock tier2 nav if challenge already reached tier2
if (s.tier >= 2) {
this.unlockTab('tier2');
const cardT1 = document.getElementById('card-breakthrough-t1');
if(cardT1) cardT1.style.display = 'none';
const cardT2 = document.getElementById('card-breakthrough-t2');
if(cardT2) cardT2.style.display = s.tier >= 2 ? '' : 'none';
}
if (s.tier >= 3) {
this.unlockTab('tier3');
const cardT2 = document.getElementById('card-breakthrough-t2');
if(cardT2) cardT2.style.display = 'none';
}
const ch = CONFIG.ultimateChallenges.find(c => c.id === s.activeChallenge);
const banner = document.getElementById('challenge-mode-banner');
banner.classList.add('active');
document.getElementById('challenge-mode-name').innerText = ch ? ch.name : '-';
// Tier4 nav stays locked during challenge
if (s.tier4Unlocked) this.unlockTab('tier4');
if (s.magneticBodyUnlocked) this.unlockTab('magnetic-body');
if (s.flowUnlocked) { this.unlockTab('flow'); game.renderFlowUpgrades(); }
} else {
this.switchTab(s.tier4Unlocked ? 'tier4' : 'tier1');
if (s.tier >= 2) {
this.unlockTab('tier2');
this.unlockTab('challenge');
document.getElementById('card-breakthrough-t1').style.display = 'none';
}
if (s.tier >= 3) {
this.unlockTab('tier3');
document.getElementById('card-breakthrough-t2').style.display = 'none';
}
if (s.tier4Unlocked) {
this.unlockTab('tier4');
document.getElementById('power-display').style.display = 'inline';
document.getElementById('btn-ultimate-reset-inline').style.display = 'inline';
}
if (s.magneticBodyUnlocked) {
this.unlockTab('magnetic-body');
}
if (s.flowUnlocked) {
this.unlockTab('flow');
game.renderFlowUpgrades();
}
}
this.update();
},
switchTab(tabId) {
document.querySelectorAll('.panel-view').forEach(el => el.classList.remove('active'));
document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active', 'challenge-active', 'achievement-active'));
document.getElementById(`view-${tabId}`).classList.add('active');
const btn = document.getElementById(`nav-${tabId}`);
if (btn) {
btn.classList.add('active');
if (tabId === 'challenge') btn.classList.add('challenge-active');
if (tabId === 'achievements') btn.classList.add('achievement-active');
}
},
unlockTab(tabId) {
const btn = document.getElementById(`nav-${tabId}`);
if (btn) btn.classList.remove('disabled');
},
formatPower(num) {
// ä¸‡è¿›åˆ¶æ ¼å¼ï¼šä¸‡ã€äº¿ã€å…†ã€ä¸‡å…†ï¼ˆåªæ˜¾ç¤ºè¿™å››ä¸ªå•ä½ï¼‰
if (!isFinite(num)) return 'âˆ';
if (num < 0) return '-' + this.formatPower(-num);
if (num === 0) return '0';
if (num >= 1e16) return (num/1e16).toFixed(2) + 'ä¸‡å…†';
if (num >= 1e12) return (num/1e12).toFixed(2) + 'å…†';
if (num >= 1e8) return (num/1e8).toFixed(2) + 'äº¿';
if (num >= 1e4) return (num/1e4).toFixed(2) + 'ä¸‡';
return Math.floor(num).toLocaleString();
},
formatUltPoints(num) {
// ç»ˆæç‚¹æ•°ç”¨ç§‘å­¦è®¡æ•°æ³•
if (num >= Number.MAX_VALUE || !isFinite(num)) return '1.80e308';
if (num === 0) return '0';
if (num < 1000) return Math.floor(num).toString();
const exp = Math.floor(Math.log10(num));
const mantissa = num / Math.pow(10, exp);
return mantissa.toFixed(2) + 'e' + exp;
},
formatNum(num) {
if (!isFinite(num)) return 'âˆ';
if (num < 0) return '-' + this.formatNum(-num);
if (num === 0) return '0';
// Ultra large numbers: use e-notation with magnitude names
if (num >= 1e100) {
const exp = Math.floor(Math.log10(num));
const mantissa = num / Math.pow(10, exp);
return mantissa.toFixed(2) + 'e' + exp;
}
if (num >= 1e16) return (num/1e16).toFixed(2) + 'äº¬';
if (num >= 1e12) return (num/1e12).toFixed(2) + 'å…†';
if (num >= 1e8) return (num/1e8).toFixed(2) + 'äº¿';
if (num >= 1e4) return (num/1e4).toFixed(2) + 'ä¸‡';
if (num >= 1e3) return (num/1e3).toFixed(1) + 'k';
return Math.floor(num).toLocaleString();
},
checkRedDots() {
const s = game.state;
const t1HasBuyable = s.volt >= s.genCost || s.volt >= s.capCost || s.volt >= s.transCost || s.volt >= s.superCost || (s.volt >= s.t1BoostCost && s.t1BoostLvl < 3);
document.getElementById('dot-tier1').style.display = (s.tier === 1 && t1HasBuyable) ? 'block' : 'none';
if (s.tier >= 2) {
const t2HasBuyable = s.horsePower >= s.hpUpgCost || s.horsePower >= s.voltUpgCost || s.horsePower >= s.voltConvCost || s.horsePower >= s.autoHPCost || s.horsePower >= s.clickHPCost || (s.horsePower >= s.t2BoostCost && s.t2BoostLvl < 3);
document.getElementById('dot-tier2').style.display = t2HasBuyable ? 'block' : 'none';
}
if (s.tier === 3) {
let t3HasBuyable = false;
CONFIG.skills.forEach(skill => {
if (!s.skills[skill.id] && s.horsePower >= skill.baseCost && s.battleWins >= skill.reqWins) t3HasBuyable = true;
});
document.getElementById('dot-tier3').style.display = t3HasBuyable ? 'block' : 'none';
}
if (s.tier >= 2) {
const canChallenge = !s.isBattling && !s.isInjured && s.playerCurHp > 0;
let realmBuyable = false;
CONFIG.realmUpgrades.forEach(u => {
if (s.tier >= (u.reqTier||1)) {
const lvl = s.realmUpgrades[u.id] || 0;
if (lvl < u.maxLevel) {
    if (u.id === 'r_reincarnation') {
        if (s.battleWins >= u.reqWins) realmBuyable = true;
    } else {
        if (s.realmCount >= Math.floor(u.baseCost * Math.pow(u.costMult, lvl))) realmBuyable = true;
    }
}
}
});
document.getElementById('dot-challenge').style.display = (canChallenge || realmBuyable) ? 'block' : 'none';
}
},
applyC1CrackStyle(enable) {
// éœ€è¦åº”ç”¨çº¢è‰²è£‚ç—•çš„ç‚¹å‡»ç±»å‡çº§å¡ç‰‡ï¼ˆé€šè¿‡æŒ‰é’®æ‰¾åˆ°çˆ¶å¡ç‰‡ï¼‰
const crackSelectors = [
  '#view-tier1 button[onclick="game.clickAction()"]',   // æ¨åŠ¨ï¼ˆç‚¹å‡»è·å–ä¼ç‰¹ï¼‰
  '#btn-buy-cap',                                        // è¶…çº§æ„ŸçŸ¥ï¼ˆç‚¹å‡»å‡çº§ï¼‰
  '#btn-buy-t1-boost',                                   // æœ¬æºåŠ é€Ÿï¼ˆç”µæµï¼‰
  '#view-tier2 button[onclick="game.clickActionHP()"]', // æ¿€å‘ï¼ˆç‚¹å‡»è·å–åŒ¹æ•°ï¼‰
  '#btn-buy-hp-upg',                                    // ç£åœºé©¬åŠ›ï¼ˆç‚¹å‡»å¨åŠ›å‡çº§ï¼‰
  '#btn-buy-click-hp',                                  // æƒ…ç»ªæ¨åŠ¨ï¼ˆç‚¹å‡»åŒ¹æ•°å‡çº§ï¼‰
];
crackSelectors.forEach(sel => {
  const btn = document.querySelector(sel);
  if (!btn) return;
  // æ‰¾åˆ°æœ€è¿‘çš„ upgrade-card çˆ¶å…ƒç´ 
  const card = btn.closest('.upgrade-card');
  const target = card || btn;
  if (enable) {
    target.classList.add('card-cracked');
    btn.disabled = true;
  } else {
    target.classList.remove('card-cracked');
    btn.disabled = false;
  }
});
},
updateAllButtons() {
// æ— è®ºå½“å‰é¡µé¢æ˜¯å“ªä¸ªï¼Œå§‹ç»ˆåˆ·æ–°æ‰€æœ‰æŒ‰é’®çš„å¯ç”¨çŠ¶æ€
const s = game.state;
// === ç¬¬ä¸€å±‚æŒ‰é’® ===
const chalRestrict = game.getChallengeRestriction();
const isC1 = !!chalRestrict.noClick;
// c1æŒ‘æˆ˜ä¸­ç‚¹å‡»ç±»æŒ‰é’®åº”ç”¨è£‚ç—•æ ·å¼
this.applyC1CrackStyle(isC1);
const btnGen = document.getElementById('btn-buy-gen');
if (btnGen) btnGen.disabled = s.volt < s.genCost;
const btnCap = document.getElementById('btn-buy-cap');
if (btnCap) btnCap.disabled = (!isC1) && (s.volt < s.capCost);
const btnTrans = document.getElementById('btn-buy-trans');
if (btnTrans) btnTrans.disabled = s.volt < s.transCost;
const btnSuper = document.getElementById('btn-buy-super');
if (btnSuper) btnSuper.disabled = s.volt < s.superCost;
const btnT1Boost = document.getElementById('btn-buy-t1-boost');
if (btnT1Boost) btnT1Boost.disabled = s.volt < s.t1BoostCost || s.t1BoostLvl >= 3 || !!chalRestrict.noT1Boost;
const btnPrestige = document.getElementById('btn-prestige');
if (btnPrestige) btnPrestige.disabled = s.volt < game.getPrestigeCost();
const btnBT = document.getElementById('btn-breakthrough');
if (btnBT) btnBT.disabled = !(s.volt >= CONFIG.t1Breakthrough && s.tier === 1);
// === ç¬¬äºŒå±‚æŒ‰é’® ===
const btnHpUpg = document.getElementById('btn-buy-hp-upg');
if (btnHpUpg) btnHpUpg.disabled = (!isC1) && (s.horsePower < s.hpUpgCost);
const btnVoltUpg = document.getElementById('btn-buy-volt-upg');
if (btnVoltUpg) btnVoltUpg.disabled = s.horsePower < s.voltUpgCost;
const btnVoltConv = document.getElementById('btn-buy-volt-conv');
if (btnVoltConv) btnVoltConv.disabled = s.horsePower < s.voltConvCost || s.voltConvLvl >= 2;
const btnAutoHp = document.getElementById('btn-buy-auto-hp');
if (btnAutoHp) btnAutoHp.disabled = s.horsePower < s.autoHPCost;
const btnClickHp = document.getElementById('btn-buy-click-hp');
if (btnClickHp) btnClickHp.disabled = (!isC1) && (s.horsePower < s.clickHPCost);
const btnT2Boost = document.getElementById('btn-buy-t2-boost');
if (btnT2Boost) btnT2Boost.disabled = s.horsePower < s.t2BoostCost || s.t2BoostLvl >= 3;
const t2Req = Math.floor(CONFIG.t2PrestigeReq * Math.pow(2.0, s.t2PrestigeCount));
const btnT2Prestige = document.getElementById('btn-t2-prestige');
if (btnT2Prestige) btnT2Prestige.disabled = s.horsePower < t2Req;
const btnBT2 = document.getElementById('btn-breakthrough-t2');
if (btnBT2) btnBT2.disabled = !(s.horsePower >= CONFIG.t2Breakthrough && s.tier === 2);
// === æŒ‘æˆ˜/å¢ƒç•ŒæŒ‰é’® ===
const rButtons = document.querySelectorAll('#realm-upgrades button');
let rIdx = 0;
CONFIG.realmUpgrades.forEach(u => {
if (s.tier < (u.reqTier||1)) return;
const lvl = s.realmUpgrades[u.id] || 0;
if (lvl >= u.maxLevel) return;
if (u.id === 'r_reincarbonation') return;
const cost = Math.floor(u.baseCost * Math.pow(u.costMult, lvl));
if (rButtons[rIdx]) rButtons[rIdx].disabled = s.realmCount < cost;
rIdx++;
});
// === ç»ˆæå±‚æŒ‰é’® ===
if (s.magneticBodyUnlocked) {
const neededPower = game.getBodyResetCost(s.bodyResetCount || 0);
const resetBtn = document.getElementById('btn-body-reset');
if (resetBtn) {
const allOwned = s.bodyParts && s.bodyParts.length >= CONFIG.bodyParts.length;
resetBtn.disabled = allOwned || (s.power < neededPower);
}
}
// === æµé‡å‡çº§æŒ‰é’® ===
if (s.flowUnlocked) {
const allFlowBtns = document.querySelectorAll('#flow-upg-list button');
allFlowBtns.forEach(btn => {
const onclick = btn.getAttribute('onclick') || '';
const match = onclick.match(/buyFlowUpgrade\((\d+)\)/);
if (!match) return;
const idx = parseInt(match[1]);
const upg = CONFIG.flowUpgrades[idx];
if (!upg) return;
const lvl = (s.flowUpgrades || {})[upg.id] || 0;
if (lvl >= upg.maxLevel) { btn.disabled = true; return; }
if (upg.id === 'fl_auto') { btn.disabled = s.flow < 10000; return; }
const cost = Math.floor(upg.baseCost * Math.pow(upg.costMult, lvl));
btn.disabled = s.flow < cost;
});
}
},
update() {
const s = game.state;
// æ¯æ¬¡ update éƒ½æ›´æ–°æ‰€æœ‰æŒ‰é’®çŠ¶æ€ï¼ˆæ— è®ºå½“å‰åœ¨å“ªä¸ªé¡µé¢ï¼‰
this.updateAllButtons();
const achMult = game.getAchievementMult();
const realmMult = game.getRealmResourceMult();
const activeTab = document.querySelector('.panel-view.active').id;
let resName = "ç”µæµ", resVal = s.volt, resUnit = "ä¼ç‰¹";
let resColor = "var(--accent-color)";
const cap = game.getCurrentHPCap();
// Update power display
if (s.tier4Unlocked) {
document.getElementById('power-display').style.display = 'inline';
document.getElementById('btn-ultimate-reset-inline').style.display = 'inline';
document.getElementById('power-val').innerText = ui.formatPower(s.power);
const t4PowerDisp = document.getElementById('t4-power-display');
const t4PpsDisp = document.getElementById('t4-pps-display');
if(t4PowerDisp) t4PowerDisp.innerText = ui.formatPower(s.power);
if(t4PpsDisp) t4PpsDisp.innerText = ui.formatPower(game.getPowerPerSec());
const preview = game.getUltimateResetPreview(s.power);
document.getElementById('ultimate-reset-preview').innerText = ui.formatUltPoints(preview);
const t4previewEl = document.getElementById('ultimate-reset-preview-t4');
if (t4previewEl) t4previewEl.innerText = ui.formatUltPoints(preview);
// æ˜¾ç¤ºå…¬å¼å¼ºåŒ–çŠ¶æ€
const formulaEl = document.getElementById('ultimate-formula-status');
if (formulaEl) {
  const hasC1 = (s.challengeRewards || {})['c1'];
  formulaEl.innerHTML = hasC1
    ? '<span style="color:#00ffaa;font-size:0.8rem;">âœ“ ç»ˆæç‚¹æ•°å…¬å¼å·²å¼ºåŒ–ï¼ˆæŒ‡æ•° 0.60â†’0.75ï¼‰</span>'
    : '<span style="color:#886688;font-size:0.8rem;">ğŸ’¡ å®Œæˆã€Œç¬¬ä¸€ä½å¼ºè€…ã€æŒ‘æˆ˜å¯å¼ºåŒ–è·å–å…¬å¼</span>';
}
if (t4previewEl) t4previewEl.innerText = ui.formatUltPoints(preview);
const ppsEl = document.getElementById('power-per-sec');
if (ppsEl) ppsEl.innerText = ui.formatPower(game.getPowerPerSec());
const voltBonusEl = document.getElementById('volt-power-bonus');
if (voltBonusEl && s.tier4Unlocked) {
  const voltLog = Math.log10(Math.max(1, s.volt));
  const voltCapLog = Math.log10(Math.max(1, CONFIG.voltHardCap));
  const voltBonus = 1 + 9 * Math.min(1, voltLog / voltCapLog);
  voltBonusEl.innerText = 'x' + voltBonus.toFixed(2);
}
const ultUpgEl = document.getElementById('ult-upg-count');
if (ultUpgEl) ultUpgEl.innerText = Object.keys(s.ultimateUpgrades).filter(k=>s.ultimateUpgrades[k]).length;
const ultPtsEl = document.getElementById('ultimate-points-disp');
if (ultPtsEl) ultPtsEl.innerText = ui.formatUltPoints(s.ultimatePoints);
// Power cap display
const powerCapEl = document.getElementById('power-cap-display');
const powerCapHintEl = document.getElementById('power-cap-unlock-hint');
if (powerCapEl) {
  const currentCap = game.getCurrentPowerCap();
  const completed = (s.completedChallenges || []).length;
  const maxCaps = CONFIG.challengePowerCaps.length;
  powerCapEl.innerText = ui.formatPower(currentCap);
  if (powerCapHintEl) {
    if (completed < maxCaps - 1) {
      powerCapHintEl.innerText = `ï¼ˆå®ŒæˆæŒ‘æˆ˜å¯è§£é”æ›´é«˜ä¸Šé™ï¼‰`;
    } else {
      powerCapHintEl.innerText = `ï¼ˆå·²è¾¾æœ€é«˜ä¸Šé™ï¼‰`;
    }
  }
}
}
// Update body parts reset button
if (s.magneticBodyUnlocked) {
const neededPower = game.getBodyResetCost(s.bodyResetCount || 0);
const resetBtn = document.getElementById('btn-body-reset');
if (resetBtn) {
const allOwned = s.bodyParts && s.bodyParts.length >= CONFIG.bodyParts.length;
resetBtn.disabled = allOwned || (s.power < neededPower);
}
const nextCostEl = document.getElementById('next-body-cost');
if (nextCostEl) nextCostEl.innerText = ui.formatNum(neededPower);
}
if (activeTab === 'view-tier1') {
resName = "ç”µæµ"; resVal = s.volt; resUnit = "ä¼ç‰¹";
// æ›´æ–°ä¼ç‰¹ä¸Šé™è¯´æ˜
const voltCapInfoEl = document.getElementById('volt-cap-info');
if (voltCapInfoEl) {
  if (s.voltCapUnlocked || s.tier4Unlocked) {
    voltCapInfoEl.style.color = '#ff00ff';
    voltCapInfoEl.innerText = 'ğŸ ç»ˆæå¼ºè€…å¥–åŠ±ï¼šä¸Šé™å·²æ‰©å±•è‡³600äº¿ï¼';
  } else {
    voltCapInfoEl.style.color = 'var(--accent-color)';
    voltCapInfoEl.innerText = 'ä¸Šé™é”å®šä¸º60äº¿ã€‚';
  }
}
const pMult = Math.pow(2, s.prestigeCount);
const superEff = 1 + (s.superLvl * 0.2);
const boostMult = Math.pow(1.5, s.t1BoostLvl);
const clickPow = (1 + s.capLvl) * pMult * superEff * achMult * realmMult * boostMult;
document.getElementById('t1-click-val').innerText = this.formatNum(clickPow);
document.getElementById('cost-gen').innerText = this.formatNum(s.genCost);
document.getElementById('count-gen').innerText = s.genCount;
document.getElementById('btn-buy-gen').disabled = s.volt < s.genCost;
document.getElementById('cost-cap').innerText = this.formatNum(s.capCost);
document.getElementById('lvl-cap').innerText = s.capLvl;
document.getElementById('btn-buy-cap').disabled = s.volt < s.capCost;
document.getElementById('cost-trans').innerText = this.formatNum(s.transCost);
document.getElementById('lvl-trans').innerText = s.transLvl;
document.getElementById('btn-buy-trans').disabled = s.volt < s.transCost;
document.getElementById('cost-super').innerText = this.formatNum(s.superCost);
document.getElementById('lvl-super').innerText = s.superLvl;
document.getElementById('btn-buy-super').disabled = s.volt < s.superCost;
document.getElementById('cost-t1-boost').innerText = this.formatNum(s.t1BoostCost);
document.getElementById('lvl-t1-boost').innerText = s.t1BoostLvl;
document.getElementById('btn-buy-t1-boost').disabled = s.volt < s.t1BoostCost || s.t1BoostLvl >= 3;
const currentReq = game.getPrestigeCost();
const prog = Math.min(100, (s.volt / currentReq) * 100);
document.getElementById('prog-prestige').style.width = prog + '%';
document.getElementById('prestige-mult-disp').innerText = Math.pow(2, s.prestigeCount);
document.getElementById('btn-prestige').disabled = s.volt < currentReq;
game.renderVoltRetention();
const btnBT = document.getElementById('btn-breakthrough');
if (s.volt >= CONFIG.t1Breakthrough && s.tier === 1) {
btnBT.disabled = false;
btnBT.style.opacity = "1";
btnBT.style.borderColor = "var(--gold-color)";
btnBT.style.color = "var(--gold-color)";
} else {
btnBT.disabled = true;
btnBT.style.opacity = "0.5";
btnBT.style.borderColor = "#444";
btnBT.style.color = "#444";
}
}
else if (activeTab === 'view-tier2') {
resName = "ç£åœº"; resVal = s.horsePower; resUnit = "åŒ¹";
resColor = "var(--danger-color)";
if (s.horsePower >= cap) {
resVal = cap;
} else {
resVal = s.horsePower;
}
const t2Mult = Math.pow(2, s.t2PrestigeCount);
const boostMult = Math.pow(1.5, s.t2BoostLvl);
const clickPowRaw = (1 + s.hpUpgLvl * 1 + s.voltUpgLvl * 1 + s.clickHPLvl * 2) * achMult * game.getRealmResourceMult(true) * t2Mult * boostMult;
let softCapFactor = 1.0;
if (s.horsePower >= 100000) {
const ratio = (s.horsePower - 100000) / (cap - 100000);
if (ratio > 0) softCapFactor = Math.pow(1 - Math.min(0.99, ratio), 3);
}
const clickPow = clickPowRaw * softCapFactor;
document.getElementById('t2-click-val').innerText = this.formatNum(clickPow);
document.getElementById('cost-hp-upg').innerText = this.formatNum(s.hpUpgCost);
document.getElementById('lvl-hp-upg').innerText = s.hpUpgLvl;
document.getElementById('btn-buy-hp-upg').disabled = s.horsePower < s.hpUpgCost;
document.getElementById('cost-volt-upg').innerText = this.formatNum(s.voltUpgCost);
document.getElementById('lvl-volt-upg').innerText = s.voltUpgLvl;
document.getElementById('btn-buy-volt-upg').disabled = s.horsePower < s.voltUpgCost;
document.getElementById('cost-volt-conv').innerText = this.formatNum(s.voltConvCost);
document.getElementById('lvl-volt-conv').innerText = s.voltConvLvl;
document.getElementById('btn-buy-volt-conv').disabled = s.horsePower < s.voltConvCost || s.voltConvLvl >= 2;
document.getElementById('cost-auto-hp').innerText = this.formatNum(s.autoHPCost);
document.getElementById('lvl-auto-hp').innerText = s.autoHPLvl;
document.getElementById('btn-buy-auto-hp').disabled = s.horsePower < s.autoHPCost;
document.getElementById('cost-click-hp').innerText = this.formatNum(s.clickHPCost);
document.getElementById('lvl-click-hp').innerText = s.clickHPLvl;
document.getElementById('btn-buy-click-hp').disabled = s.horsePower < s.clickHPCost;
document.getElementById('cost-t2-boost').innerText = this.formatNum(s.t2BoostCost);
document.getElementById('lvl-t2-boost').innerText = s.t2BoostLvl;
document.getElementById('btn-buy-t2-boost').disabled = s.horsePower < s.t2BoostCost || s.t2BoostLvl >= 3;
// ä¿®æ”¹ï¼šæ˜¾ç¤ºæ›´æ–°åçš„éœ€æ±‚
const t2Req = Math.floor(CONFIG.t2PrestigeReq * Math.pow(2.0, s.t2PrestigeCount));
document.getElementById('t2-prestige-req').innerText = this.formatNum(t2Req);
const t2Prog = Math.min(100, (s.horsePower / t2Req) * 100);
document.getElementById('prog-t2-prestige').style.width = t2Prog + '%';
document.getElementById('t2-prestige-mult-disp').innerText = Math.pow(2, s.t2PrestigeCount).toFixed(2);
document.getElementById('btn-t2-prestige').disabled = s.horsePower < t2Req;
const btnBT2 = document.getElementById('btn-breakthrough-t2');
if (s.horsePower >= CONFIG.t2Breakthrough && s.tier === 2) {
btnBT2.disabled = false;
btnBT2.style.opacity = "1";
btnBT2.style.borderColor = "var(--gold-color)";
btnBT2.style.color = "var(--gold-color)";
} else {
btnBT2.disabled = true;
btnBT2.style.opacity = "0.5";
}
}
else if (activeTab === 'view-tier3') {
resName = "ç£åœº"; resVal = s.horsePower; resUnit = "åŒ¹";
resColor = "var(--danger-color)";
if (s.horsePower >= cap) {
resVal = cap;
} else {
resVal = s.horsePower;
}
const t3WinsDisplay = s.battleWins >= 20000 ? "ä½ æ‰“å€’äº†ä»–å¦ˆçš„æ•´ä¸ªä¸–ç•Œï¼" : s.battleWins;
document.getElementById('t3-wins-count').innerText = t3WinsDisplay;
}
else if (activeTab === 'view-challenge' || activeTab === 'view-achievements') {
if (s.tier === 1) { resName = "ç”µæµ"; resVal = s.volt; resUnit = "ä¼ç‰¹"; }
else {
resName = "ç£åœº"; resVal = s.horsePower; resUnit = "åŒ¹";
resColor = "var(--danger-color)";
if (s.horsePower >= cap) {
resVal = cap;
} else {
resVal = s.horsePower;
}
}
}
const displayVal = (s.tier === 4 && !s.activeChallenge && activeTab !== 'view-tier1' && activeTab !== 'view-tier2' && activeTab !== 'view-tier3' && activeTab !== 'view-challenge' && activeTab !== 'view-achievements') ? "" : this.formatNum(resVal);
// Hide resource display entirely when on pure tier4 tabs
const resDisplayEl = document.querySelector('#top-bar .resource-display');
const isTier4Tab = s.tier4Unlocked && !s.activeChallenge && (activeTab === 'view-tier4' || activeTab === 'view-magnetic-body'|| activeTab === 'view-flow');
if (resDisplayEl) {
resDisplayEl.style.display = isTier4Tab ? 'none' : '';
}
document.getElementById('res-name').innerText = resName;
document.getElementById('res-name').style.color = resColor;
if (!isTier4Tab) {
document.getElementById('res-val').innerText = displayVal;
document.getElementById('res-unit').innerText = resUnit;
}
document.getElementById('total-mult').innerText = (achMult * realmMult).toFixed(2);
document.getElementById('ach-mult').innerText = achMult.toFixed(2);
document.getElementById('realm-mult').innerText = realmMult.toFixed(2);
if (activeTab === 'view-challenge' && s.tier >= 2) {
const winsDisplay = s.battleWins >= 20000 ? "ä½ æ‰“å€’äº†ä»–å¦ˆçš„æ•´ä¸ªä¸–ç•Œï¼" : s.battleWins;
document.getElementById('challenge-wins-count').innerText = winsDisplay;
// æ˜¾ç¤ºæ•Œäººä¸Šé™è§£é™¤çŠ¶æ€
const capStatusEl = document.getElementById('battle-cap-status');
if (capStatusEl) capStatusEl.style.display = (s.battleWins >= 10000) ? 'block' : 'none';
const realmLockEl = document.getElementById('realm-lock-status');
if (realmLockEl) realmLockEl.style.display = (s.battleWins >= 10000) ? 'block' : 'none';
// æ˜¾ç¤ºå‡»è´¥å¼ºè€…å¯¹åŠ›é‡äº§å‡ºçš„åŠ æˆï¼ˆè§£é”ç»ˆæå±‚åï¼‰
const powerBonusEl = document.getElementById('battle-power-bonus');
if (powerBonusEl) {
  if (s.tier4Unlocked) {
    const rawBonus = Math.floor((s.battleWins || 0) / 100);
    const cappedBonus = Math.min(rawBonus, 10000);
    const isCapped = rawBonus >= 10000;
    powerBonusEl.style.display = 'block';
    powerBonusEl.innerText = `âš¡ å‡»è´¥å¼ºè€…åŠ æˆï¼š+${cappedBonus}% åŠ›é‡äº§å‡ºé€Ÿåº¦ï¼ˆæ¯å‡»è´¥100å+1%ï¼Œä¸Šé™+10000%ï¼‰${isCapped ? ' âœ“ å·²è¾¾ä¸Šé™' : ''}`;
  } else {
    powerBonusEl.style.display = 'none';
  }
}
const stats = game.getBattleStats();
s.playerAtkCache = stats.pAtk;
document.getElementById('player-atk').innerText = this.formatNum(stats.pAtk);
document.getElementById('player-def').innerText = this.formatNum(stats.pDef);
document.getElementById('player-hp-max').innerText = this.formatNum(Math.floor(stats.pMaxHp));
document.getElementById('player-hp-cur').innerText = this.formatNum(Math.floor(s.playerCurHp));
const pHpPct = (s.playerCurHp / stats.pMaxHp) * 100;
document.getElementById('player-hp-bar').style.width = Math.max(0, pHpPct) + '%';
document.getElementById('enemy-wave-num').innerText = stats.wave;
document.getElementById('enemy-hp-max').innerText = this.formatNum(stats.eMaxHp);
document.getElementById('enemy-hp-cur').innerText = this.formatNum(Math.floor(s.enemyCurHp));
document.getElementById('enemy-atk').innerText = this.formatNum(stats.eAtk);
document.getElementById('enemy-def').innerText = this.formatNum(stats.eDef);
const eHpPct = stats.eMaxHp > 0 ? (s.enemyCurHp / stats.eMaxHp) * 100 : 0;
document.getElementById('enemy-hp-bar').style.width = Math.max(0, eHpPct) + '%';
document.getElementById('realm-count').innerText = this.formatNum(s.realmCount);
const btnChallenge = document.getElementById('btn-challenge');
const btnFlee = document.getElementById('btn-flee');
const statusDiv = document.getElementById('battle-status');
const now = Date.now();
if (s.isInjured) {
const remaining = Math.ceil((s.injuredUntil - now) / 1000);
statusDiv.innerText = `é‡ä¼¤æ¢å¤ä¸­ (${remaining}s)`;
statusDiv.className = "battle-status status-injured";
btnChallenge.disabled = true;
btnFlee.disabled = true;
} else if (s.isBattling) {
statusDiv.innerText = "æˆ˜æ–—ä¸­...";
statusDiv.className = "battle-status status-fighting";
btnChallenge.disabled = true;
btnFlee.disabled = false;
} else {
btnFlee.disabled = true;
if (s.playerCurHp <= 0) {
statusDiv.innerText = "ç­‰å¾…å¤æ´»...";
statusDiv.className = "battle-status status-cooldown";
btnChallenge.disabled = true;
} else {
statusDiv.innerText = "å‡†å¤‡æŒ‘æˆ˜";
statusDiv.className = "battle-status status-waiting";
btnChallenge.disabled = false;
}
}
const btnAutoToggle = document.getElementById('btn-auto-toggle');
const hasAuto = parseInt(s.realmUpgrades['r_auto_battle'] || '0') === 1;
if (!hasAuto) {
btnAutoToggle.disabled = true;
btnAutoToggle.style.borderColor = '#444';
btnAutoToggle.style.color = '#444';
btnAutoToggle.style.backgroundColor = '#111';
btnAutoToggle.innerText = "æœªè´­ä¹°å‡çº§";
} else {
btnAutoToggle.disabled = false;
btnAutoToggle.style.borderColor = game.autoBattleEnabled ? 'var(--danger-color)' : 'var(--accent-color)';
btnAutoToggle.style.color = game.autoBattleEnabled ? 'var(--danger-color)' : 'var(--accent-color)';
btnAutoToggle.style.backgroundColor = '#222';
btnAutoToggle.style.cursor = 'pointer';
const statusText = game.autoBattleEnabled ? "ON" : "OFF";
btnAutoToggle.innerText = `è‡ªåŠ¨æŒ‘æˆ˜ï¼š${statusText}`;
}
const rButtons = document.querySelectorAll('#realm-upgrades button');
let rIdx = 0;
CONFIG.realmUpgrades.forEach(u => {
if (s.tier < (u.reqTier||1)) return;
const lvl = s.realmUpgrades[u.id] || 0;
if (lvl >= u.maxLevel) return;
// è·³è¿‡è½¬ä¸–çš„è´¹ç”¨æ£€æŸ¥ï¼Œå› ä¸ºå®ƒå…è´¹
if (u.id === 'r_reincarbonation') return; 
const cost = Math.floor(u.baseCost * Math.pow(u.costMult, lvl));
if (rButtons[rIdx]) rButtons[rIdx].disabled = s.realmCount < cost;
rIdx++;
});
}
},
updateFlowBar() {
const s = game.state;
if (!s.flowUnlocked) return;
const bar = document.getElementById('flow-charge-bar');
const text = document.getElementById('flow-charge-text');
if (!bar || !text) return;
const pct = (s.flowChargeProgress || 0) * 100;
bar.style.width = pct + '%';
const currentTime = game.getFlowChargeTime();
const timeText = document.getElementById('flow-time-text');
if (timeText) {
timeText.innerText = currentTime.toFixed(1);
}
if (s.flow >= s.flowMax) {
text.innerText = 'æµé‡å·²æ»¡ï¼';
} else if (s.flowChargeActive) {
text.innerText = `å……èƒ½ä¸­... ${pct.toFixed(0)}%`;
} else {
const hasAutoCharge = (s.flowUpgrades || {})['fl_auto'] >= 1;
text.innerText = hasAutoCharge ? 'âš™ï¸ è‡ªåŠ¨å……èƒ½ä¸­...' : 'ğŸ‘† ç‚¹å‡»å¼€å§‹å……èƒ½';
}
// Update flow value
const flowValEl = document.getElementById('flow-val');
if (flowValEl) flowValEl.innerText = this.formatNum(s.flow);
// Update amount per charge
const amtEl = document.getElementById('flow-amount-per-charge');
if (amtEl) {
const upgs = s.flowUpgrades || {};
let amount = 1;
amount += (upgs['fl_amount1'] || 0) * 4;
amount += (upgs['fl_amount2'] || 0) * 10;
amount += (upgs['fl_amount3'] || 0) * 40;
amount += (upgs['fl_amount4'] || 0) * 200;
amount += (upgs['fl_amount5'] || 0) * 1000;
amount += (upgs['fl_amount6'] || 0) * 1000;
        amount += (upgs['fl_amount7'] || 0) * 2000;
        amount += (upgs['fl_amount8'] || 0) * 4000;
        amount += (upgs['fl_amount9'] || 0) * 20000;
        amount += (upgs['fl_amount10'] || 0) * 40000;
        amount += (upgs['fl_amount11'] || 0) * 100000;
                                        amount += (upgs['fl_amount16'] || 0) * 4000000;
        amount += (upgs['fl_amount17'] || 0) * 6000000;
        amount += (upgs['fl_amount18'] || 0) * 8000000;
        amount += (upgs['fl_amount19'] || 0) * 10000000;
        amount += (upgs['fl_amount20'] || 0) * 20000000;
amtEl.innerText = this.formatNum(amount);
}
// Bonuses display
const realmBonusEl = document.getElementById('flow-realm-bonus');
if (realmBonusEl) realmBonusEl.innerText = '+' + (Math.floor((s.realmCount || 0) / 100) * 10).toFixed(0) + '%';
const flowBonusEl = document.getElementById('flow-power-bonus');
if (flowBonusEl) flowBonusEl.innerText = '+' + (Math.floor((s.flow || 0) / 1000) * 5).toFixed(0) + '%';
},
updateBattleUI(inBattle) {
this.update();
},
updateBattleHP() {
const s = game.state;
const stats = game.getBattleStats();
document.getElementById('player-hp-cur').innerText = Math.floor(s.playerCurHp);
document.getElementById('enemy-hp-cur').innerText = Math.floor(s.enemyCurHp);
const pHpPct = (s.playerCurHp / stats.pMaxHp) * 100;
const eHpPct = stats.eMaxHp > 0 ? (s.enemyCurHp / stats.eMaxHp) * 100 : 0;
document.getElementById('player-hp-bar').style.width = Math.max(0, pHpPct) + '%';
document.getElementById('enemy-hp-bar').style.width = Math.max(0, eHpPct) + '%';
}
};
window.onload = () => game.init();
</script>
</body>
</html>
